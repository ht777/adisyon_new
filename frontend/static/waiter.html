<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Garson</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
<div class="max-w-3xl mx-auto p-6">
<div id="loginBox" class="bg-white p-6 rounded-xl shadow border">
<h2 class="text-xl font-bold mb-4">Garson Giri≈üi</h2>
<div class="grid grid-cols-2 gap-4">
<div><label class="text-sm text-gray-500">Kullanƒ±cƒ±</label><input id="wUser" class="border p-2 rounded w-full" placeholder="kullanƒ±cƒ±"></div>
<div><label class="text-sm text-gray-500">≈ûifre (4 hane)</label><input id="wPin" class="border p-2 rounded w-full" maxlength="4" placeholder="1234"></div>
</div>
<div class="mt-4"><button onclick="waiterLogin()" class="px-4 py-2 bg-slate-800 text-white rounded">Giri≈ü</button></div>
</div>
<div id="mainBox" class="hidden">
<div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">Masalar</h2><button onclick="logout()" class="text-sm px-3 py-1 bg-gray-200 rounded">√áƒ±kƒ±≈ü</button></div>
<div id="tablesGrid" class="grid grid-cols-2 md:grid-cols-3 gap-3"></div>
<div id="menuBox" class="hidden mt-6 bg-white p-5 rounded-2xl shadow-lg border">
<div class="flex justify-between items-center pb-3 border-b">
  <h3 class="font-bold text-lg text-gray-800">üçΩÔ∏è Men√º</h3>
  <button onclick="closeMenu()" class="text-sm px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">‚úï Kapat</button>
</div>
<div id="categories" class="flex gap-2 mt-4 flex-wrap"></div>
<div id="products" class="grid grid-cols-2 gap-3 mt-4 max-h-[40vh] overflow-y-auto"></div>
<div class="mt-5 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-100">
  <h4 class="font-bold text-sm mb-3 text-blue-800 flex items-center gap-2">üõí Sepet</h4>
  <div id="cartSummary"><div class="text-gray-400 text-sm text-center py-2">Sepet bo≈ü - √úr√ºn ekleyin</div></div>
</div>
<div class="mt-4">
  <label class="block text-sm font-medium text-gray-700 mb-2">üìù Sipari≈ü Notu (Opsiyonel)</label>
  <textarea id="orderNotes" class="w-full border border-gray-300 rounded-lg p-3 text-sm resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="2" placeholder="√ñrn: Az tuzlu, yanƒ±nda sos olmasƒ±n, acƒ±lƒ± olsun..."></textarea>
</div>
<div class="mt-4">
  <button onclick="submitOrder()" class="w-full py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl font-bold text-lg hover:from-blue-700 hover:to-indigo-700 transition-all shadow-lg">
    ‚úì Sipari≈üi Onayla
  </button>
</div>
</div>
<div id="tableActionsModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl w-[90%] max-w-xl p-4">
    <div class="flex justify-between items-center border-b pb-2 mb-3">
      <div class="text-lg font-bold" id="tamTitle">Masa</div>
      <button onclick="closeActions()" class="px-2 py-1 bg-gray-200 rounded">Kapat</button>
    </div>
    <div class="grid grid-cols-3 gap-3">
      <button onclick="actionAddProduct()" class="p-4 bg-green-50 border border-green-300 rounded-lg font-medium text-green-700 hover:bg-green-100 transition-colors">‚ûï √úr√ºn Ekle</button>
      <button onclick="actionDetails()" class="p-4 bg-orange-50 border rounded-lg hover:bg-orange-100 transition-colors">Hesap detayƒ±</button>
      <button onclick="actionTransfer()" class="p-4 bg-blue-50 border rounded-lg hover:bg-blue-100 transition-colors">Masa deƒüi≈ütir</button>
      <button onclick="actionMerge()" class="p-4 bg-gray-50 border rounded-lg hover:bg-gray-100 transition-colors">Masa birle≈ütir</button>
      <button onclick="actionPrint()" class="p-4 bg-yellow-50 border rounded-lg hover:bg-yellow-100 transition-colors">Yazdƒ±r</button>
      <button onclick="actionCancel()" class="p-4 bg-red-50 border rounded-lg hover:bg-red-100 transition-colors">ƒ∞ptal et</button>
    </div>
  </div>
</div>
<div id="orderDetailsModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-2xl w-[90%] max-w-md p-5 shadow-2xl max-h-[85vh] overflow-y-auto">
    <div class="flex justify-between items-center pb-3 mb-4 border-b-2 border-gray-100">
      <div class="text-xl font-bold text-gray-800">üìã Sipari≈ü Detayƒ±</div>
      <button onclick="closeOrderDetails()" class="w-8 h-8 flex items-center justify-center bg-gray-100 hover:bg-gray-200 rounded-full transition-colors text-gray-600">‚úï</button>
    </div>
    <div id="orderDetailsContent"></div>
  </div>
</div>
</div>
</div>
<script>
let token=null; let currentTable=null; let categories=[]; let products=[]; let cart=[]; let actionTable=null;
function logout(){ localStorage.removeItem('waiterToken'); localStorage.removeItem('authToken'); location.reload(); }
async function waiterLogin(){
 const u=document.getElementById('wUser').value.trim();
 const p=document.getElementById('wPin').value.trim();
 const r=await fetch('/api/auth/pin-login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,pin:p})});
 if(!r.ok){ alert('Giri≈ü ba≈üarƒ±sƒ±z'); return; }
 const d=await r.json(); token=d.access_token; localStorage.setItem('waiterToken',token);
 document.getElementById('loginBox').classList.add('hidden'); document.getElementById('mainBox').classList.remove('hidden');
 loadAssignedTables(); loadMenuData();
}
async function loadAssignedTables(){
 const h={'Authorization':'Bearer '+(token||localStorage.getItem('waiterToken'))};
 const grid=document.getElementById('tablesGrid');
 try{
  // √ñnce atanmƒ±≈ü masalarƒ± al
  const r=await fetch('/api/waiters/assigned-tables',{headers:h}); const t=await r.json();
  let list=t||[];
  
  // Eƒüer hi√ß atanmƒ±≈ü masa yoksa, t√ºm aktif masalarƒ± getir ve ata
  if(!list.length){
    // T√ºm aktif masalarƒ± getir (dolu/bo≈ü fark etmez)
    const allTablesRes = await fetch('/api/tables?active_only=true',{headers:h});
    const allTables = await allTablesRes.json();
    
    if(allTables && allTables.length > 0) {
      // T√ºm masalarƒ± bu garsona ata
      const tableIds = allTables.map(t => t.id);
      await fetch('/api/waiters/auto-assign',{method:'POST', headers:h});
      
      // Tekrar atanmƒ±≈ü masalarƒ± al
      const rr=await fetch('/api/waiters/assigned-tables',{headers:h}); 
      list = await rr.json() || [];
      
      // Eƒüer hala bo≈üsa, t√ºm masalarƒ± g√∂ster
      if(!list.length) {
        list = allTables.map(t => ({id: t.id, number: t.number, name: t.name, is_occupied: false}));
      }
    }
  }
  
  grid.innerHTML=list.length ? list.map(x=>`<button onclick=\"openTable(${x.id},${x.number})\" class=\"p-4 rounded-xl text-left ${x.is_occupied?'bg-red-50 border border-red-300':'bg-green-50 border border-green-300'}\"><div class=\"font-bold\">Masa ${x.number}</div><div class=\"text-sm text-gray-600\">${x.is_occupied?'Dolu':'M√ºsait'}</div></button>`).join('') : '<div class=\"text-gray-500\">M√ºsait masa yok</div>';
 }catch(e){ grid.innerHTML='<div class=\"text-red-600\">Masa listesi y√ºklenemedi</div>'; }
}
async function openTable(id,num){ currentTable={id:id, number:num};
  try{
    const h={'Authorization':'Bearer '+(token||localStorage.getItem('waiterToken'))};
    const r=await fetch(`/api/tables/details/${id}`,{headers:h});
    const d=await r.json();
    const active=(d.orders||[]).filter(o=>['pending','preparing','bekliyor','hazirlaniyor','ready','hazir','hazƒ±r'].includes((o.status||'').toLowerCase()));
    await loadMenuData();
    // Dolu masa ise her zaman se√ßenekleri a√ß, bo≈ü masa ise direkt men√ºy√º a√ß
    if(active.length > 0){ openActions(id,num); } else { renderMenu(); }
  }catch(e){ openActions(id,num); }
}
function openActions(id,num){ actionTable={id:id, number:num}; const m=document.getElementById('tableActionsModal'); document.getElementById('tamTitle').innerText=`Masa ${num}`; m.classList.remove('hidden'); m.classList.add('flex'); }
function closeActions(){ const m=document.getElementById('tableActionsModal'); m.classList.add('hidden'); m.classList.remove('flex'); }
async function actionDetails(){ const h={'Authorization':'Bearer '+(token||localStorage.getItem('waiterToken'))}; const r=await fetch(`/api/tables/details/${actionTable.id}`,{headers:h}); const d=await r.json(); alert(`Toplam: ${(d.total_amount||0).toFixed(2)} ‚Ç∫`); }
function showOrderDetails(d){ 
  const box=document.getElementById('orderDetailsContent'); 
  const orders = d.orders || [];
  
  if(orders.length === 0) {
    box.innerHTML = '<div class="text-center py-6 text-gray-400"><div class="text-4xl mb-2">üìã</div><div>Aktif sipari≈ü yok</div></div>';
  } else {
    let html = `<div class="text-center mb-4 pb-3 border-b-2 border-blue-200">
      <div class="text-2xl font-bold text-blue-600">MASA ${d.table_number}</div>
    </div>`;
    
    orders.forEach((o) => {
      const orderNum = o.daily_order_number || '?';
      const orderTotal = o.total_amount || 0;
      const orderTime = o.created_at ? new Date(o.created_at).toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'}) : '';
      const statusText = {'pending':'Bekliyor','preparing':'Hazƒ±rlanƒ±yor','ready':'Hazƒ±r','delivered':'Teslim','cancelled':'ƒ∞ptal'}[o.status] || o.status;
      const statusColor = {'pending':'bg-yellow-100 text-yellow-700','preparing':'bg-orange-100 text-orange-700','ready':'bg-green-100 text-green-700'}[o.status] || 'bg-gray-100 text-gray-700';
      
      const itemsList = (o.items || []).map(i => 
        `<div class="flex justify-between py-2 border-b border-gray-100 last:border-0">
          <span class="text-gray-700">${i.quantity || 1}x ${i.name}</span>
          <span class="font-mono font-medium">${(i.subtotal||0).toFixed(2)} ‚Ç∫</span>
        </div>`
      ).join('');
      
      html += `
        <div class="mb-4 bg-gray-50 rounded-xl p-4">
          <div class="flex justify-between items-center mb-3">
            <div>
              <span class="text-lg font-bold text-blue-600">Sipari≈ü #${orderNum}</span>
              <span class="text-xs text-gray-400 ml-2">üïê ${orderTime}</span>
            </div>
            <span class="text-xs px-2 py-1 rounded-full ${statusColor}">${statusText}</span>
          </div>
          <div class="bg-white rounded-lg p-3">
            ${itemsList || '<div class="text-gray-400 text-sm text-center">√úr√ºn yok</div>'}
          </div>
          <div class="flex justify-between mt-3 pt-2 border-t border-gray-200">
            <span class="font-bold">Sipari≈ü Toplamƒ±</span>
            <span class="font-mono font-bold text-lg">${orderTotal.toFixed(2)} ‚Ç∫</span>
          </div>
        </div>
      `;
    });
    
    if(orders.length > 1) {
      html += `
        <div class="bg-blue-600 text-white p-4 rounded-xl mt-2">
          <div class="flex justify-between font-bold text-lg">
            <span>GENEL TOPLAM</span>
            <span class="font-mono">${(d.total_amount||0).toFixed(2)} ‚Ç∫</span>
          </div>
        </div>
      `;
    }
    box.innerHTML = html;
  }
  
  const m=document.getElementById('orderDetailsModal'); 
  m.classList.remove('hidden'); 
  m.classList.add('flex'); 
}
function closeOrderDetails(){ const m=document.getElementById('orderDetailsModal'); m.classList.add('hidden'); m.classList.remove('flex'); }
async function actionDetails(){ const h={'Authorization':'Bearer '+(token||localStorage.getItem('waiterToken'))}; const r=await fetch(`/api/tables/details/${actionTable.id}`,{headers:h}); const d=await r.json(); showOrderDetails(d); }
async function actionClose(){ const h={'Authorization':'Bearer '+(token||localStorage.getItem('waiterToken'))}; await fetch(`/api/tables/close/${actionTable.id}`,{method:'POST',headers:h}); alert('Hesap kesildi'); closeActions(); loadAssignedTables(); }
async function actionTransfer(){ const tgt=prompt('Hedef masa numarasƒ±:'); if(!tgt) return; const h={'Authorization':'Bearer '+(token||localStorage.getItem('waiterToken'))}; const tr=await fetch('/api/tables?active_only=false',{headers:h}); const td=await tr.json(); const t=td.find(x=>x.number==parseInt(tgt)); if(!t){ alert('Masa bulunamadƒ±'); return;} await fetch(`/api/tables/transfer/${actionTable.id}/${t.id}`,{method:'POST',headers:h}); alert('Ta≈üƒ±ndƒ±'); closeActions(); loadAssignedTables(); }
async function actionMerge(){ const tgt=prompt('Birle≈ütirilecek masa numarasƒ±:'); if(!tgt) return; const h={'Authorization':'Bearer '+(token||localStorage.getItem('waiterToken'))}; const tr=await fetch('/api/tables?active_only=false',{headers:h}); const td=await tr.json(); const t=td.find(x=>x.number==parseInt(tgt)); if(!t){ alert('Masa bulunamadƒ±'); return;} await fetch(`/api/tables/merge/${actionTable.id}/${t.id}`,{method:'POST',headers:h}); alert('Birle≈ütirildi'); closeActions(); loadAssignedTables(); }
async function actionPrint(){ const h={'Authorization':'Bearer '+(token||localStorage.getItem('waiterToken'))}; await fetch(`/api/tables/print-bill/${actionTable.id}`,{method:'POST',headers:h}); alert('Yazdƒ±rƒ±lƒ±yor'); }
async function actionCancel(){ const h={'Authorization':'Bearer '+(token||localStorage.getItem('waiterToken'))}; const dr=await fetch(`/api/tables/details/${actionTable.id}`,{headers:h}); const d=await dr.json(); const active=(d.orders||[]).filter(o=>['pending','preparing','bekliyor','hazirlaniyor'].includes((o.status||'').toLowerCase())); for(const o of active){ await fetch(`/api/orders/${o.id}/status`,{method:'PUT',headers:h,body:JSON.stringify({status:'cancelled'})}); } alert('ƒ∞ptal edildi'); closeActions(); loadAssignedTables(); }
async function actionAddProduct(){ 
  // Se√ßenekleri kapat ve men√ºy√º a√ß
  closeActions(); 
  currentTable = actionTable;
  await loadMenuData();
  renderMenu(); 
}
function closeMenu(){ document.getElementById('menuBox').classList.add('hidden'); cart=[]; const notesInput = document.getElementById('orderNotes'); if(notesInput) notesInput.value = ''; }
async function loadMenuData(){ 
  const h={'Authorization':'Bearer '+(token||localStorage.getItem('waiterToken'))}; 
  const cr=await fetch('/api/products/categories',{headers:h}); 
  const cd=await cr.json(); 
  categories=cd.categories||cd; 
  // available_only=true ile stoƒüu 0 olanlarƒ± backend'den filtreliyoruz
  const pr=await fetch('/api/products?available_only=true',{headers:h}); 
  const pd=await pr.json(); 
  products=Array.isArray(pd)?pd:(pd.products||[]); 
}
function renderMenu(){ 
  const cats=document.getElementById('categories'); 
  const ps=document.getElementById('products'); 
  // Stok takibi a√ßƒ±k ve stoƒüu 0 olan √ºr√ºnleri filtrele
  const availableProducts = products.filter(p => !p.track_stock || (p.stock || 0) > 0);
  cats.innerHTML=categories.map(c=>`<button onclick="filterCat(${c.id})" class="px-3 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 font-medium transition-colors">${c.name}</button>`).join(''); 
  ps.innerHTML=availableProducts.map(p=>{
    const inCart = cart.find(x=>x.product_id==p.id);
    const qty = inCart ? inCart.quantity : 0;
    const selectedClass = qty > 0 ? 'bg-blue-50 border-blue-400 border-2 shadow-md ring-2 ring-blue-200' : 'border-gray-200 hover:border-gray-300';
    return `<div class="border rounded-xl p-4 transition-all ${selectedClass}">
      <div class="font-bold text-gray-800">${p.name}</div>
      <div class="text-sm text-gray-500 mb-3">${(p.price||0).toFixed(2)} ‚Ç∫</div>
      <div class="flex items-center justify-between">
        ${qty > 0 ? `
          <div class="flex items-center gap-2">
            <button onclick="removeFromCart(${p.id})" class="w-8 h-8 flex items-center justify-center bg-red-500 text-white rounded-full font-bold hover:bg-red-600 transition-colors">-</button>
            <span class="font-bold text-lg text-blue-600 min-w-[24px] text-center">${qty}</span>
            <button onclick="addToCart(${p.id})" class="w-8 h-8 flex items-center justify-center bg-blue-600 text-white rounded-full font-bold hover:bg-blue-700 transition-colors">+</button>
          </div>
          <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-medium">Sepette</span>
        ` : `
          <button onclick="addToCart(${p.id})" class="w-full py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors">+ Ekle</button>
        `}
      </div>
    </div>`;
  }).join(''); 
  // Sepet √∂zeti g√∂ster
  renderCartSummary();
  document.getElementById('menuBox').classList.remove('hidden'); 
}
function filterCat(cid){ 
  const ps=document.getElementById('products'); 
  const availableProducts = products.filter(p => p.category_id==cid && (!p.track_stock || (p.stock || 0) > 0));
  ps.innerHTML=availableProducts.map(p=>{
    const inCart = cart.find(x=>x.product_id==p.id);
    const qty = inCart ? inCart.quantity : 0;
    const selectedClass = qty > 0 ? 'bg-blue-50 border-blue-400 border-2 shadow-md ring-2 ring-blue-200' : 'border-gray-200 hover:border-gray-300';
    return `<div class="border rounded-xl p-4 transition-all ${selectedClass}">
      <div class="font-bold text-gray-800">${p.name}</div>
      <div class="text-sm text-gray-500 mb-3">${(p.price||0).toFixed(2)} ‚Ç∫</div>
      <div class="flex items-center justify-between">
        ${qty > 0 ? `
          <div class="flex items-center gap-2">
            <button onclick="removeFromCart(${p.id})" class="w-8 h-8 flex items-center justify-center bg-red-500 text-white rounded-full font-bold hover:bg-red-600 transition-colors">-</button>
            <span class="font-bold text-lg text-blue-600 min-w-[24px] text-center">${qty}</span>
            <button onclick="addToCart(${p.id})" class="w-8 h-8 flex items-center justify-center bg-blue-600 text-white rounded-full font-bold hover:bg-blue-700 transition-colors">+</button>
          </div>
          <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-medium">Sepette</span>
        ` : `
          <button onclick="addToCart(${p.id})" class="w-full py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors">+ Ekle</button>
        `}
      </div>
    </div>`;
  }).join(''); 
}
function addToCart(pid){ const p=products.find(x=>x.id==pid); if(!p) return; const i=cart.find(x=>x.product_id==pid); if(i) i.quantity+=1; else cart.push({product_id:pid,quantity:1,extras:{}}); renderMenu(); }
function removeFromCart(pid){ const i=cart.findIndex(x=>x.product_id==pid); if(i>=0){ if(cart[i].quantity>1) cart[i].quantity--; else cart.splice(i,1); } renderMenu(); }
function renderCartSummary(){
  const summary = document.getElementById('cartSummary');
  if(!summary) return;
  if(cart.length === 0){ 
    summary.innerHTML = '<div class="text-gray-400 text-sm text-center py-2">Sepet bo≈ü - √úr√ºn ekleyin</div>'; 
    return; 
  }
  let total = 0;
  const items = cart.map(c => {
    const p = products.find(x=>x.id==c.product_id);
    if(!p) return '';
    const subtotal = (p.price||0) * c.quantity;
    total += subtotal;
    return `<div class="flex justify-between text-sm py-1 border-b border-gray-100">
      <span class="text-gray-700"><span class="font-bold text-blue-600">${c.quantity}x</span> ${p.name}</span>
      <span class="font-mono font-medium">${subtotal.toFixed(2)} ‚Ç∫</span>
    </div>`;
  }).join('');
  summary.innerHTML = `
    <div class="text-xs text-gray-500 mb-2">${cart.length} √ºr√ºn</div>
    ${items}
    <div class="border-t-2 border-blue-200 mt-3 pt-3 flex justify-between font-bold text-lg">
      <span>Toplam</span>
      <span class="text-blue-600">${total.toFixed(2)} ‚Ç∫</span>
    </div>
  `;
}
async function submitOrder(){ 
  if(!currentTable||cart.length==0){ alert('√úr√ºn se√ßin'); return; } 
  const h={'Authorization':'Bearer '+(token||localStorage.getItem('waiterToken')),'Content-Type':'application/json'}; 
  const notesInput = document.getElementById('orderNotes');
  const customerNotes = notesInput ? notesInput.value.trim() : '';
  const body={table_number:currentTable.number, items:cart, customer_notes: customerNotes || null}; 
  const r=await fetch('/api/orders',{method:'POST',headers:h,body:JSON.stringify(body)}); 
  if(r.ok){ 
    alert('Sipari≈ü g√∂nderildi'); 
    cart=[]; 
    if(notesInput) notesInput.value = '';
    document.getElementById('menuBox').classList.add('hidden'); 
    openActions(currentTable.id,currentTable.number); 
    loadAssignedTables(); 
  } else { alert('Sipari≈ü hatasƒ±'); } 
}
document.addEventListener('DOMContentLoaded', ()=>{ const t=localStorage.getItem('authToken')||localStorage.getItem('waiterToken'); if(t){ token=t; document.getElementById('loginBox').classList.add('hidden'); document.getElementById('mainBox').classList.remove('hidden'); loadAssignedTables(); loadMenuData(); } });
</script>
</body>
</html>
