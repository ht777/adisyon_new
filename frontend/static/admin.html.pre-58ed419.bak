<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Paneli | Restoran</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .nav-item.active { background-color: #1e293b; border-left: 4px solid #3b82f6; }
    </style>
</head>
<body class="bg-gray-50 flex h-screen overflow-hidden font-sans">
    <div class="w-64 bg-slate-900 text-white flex-shrink-0 flex flex-col shadow-xl z-20">
        <div class="p-6 text-2xl font-bold text-center border-b border-slate-800 flex items-center justify-center gap-2">
            <i class="fas fa-utensils text-blue-500"></i> <span>Y√∂netim</span>
        </div>
        
        <nav class="flex-1 overflow-y-auto py-6 space-y-1">
            <button onclick="showSection('dashboard')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3 active"><i class="fas fa-chart-pie w-5 text-center"></i> Dashboard</button>
            <button onclick="showSection('orders')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3"><i class="fas fa-receipt w-5 text-center"></i> Sipari≈üler</button>
            <button onclick="showSection('products')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3"><i class="fas fa-hamburger w-5 text-center"></i> √úr√ºnler</button>
            <button onclick="showSection('categories')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3"><i class="fas fa-tags w-5 text-center"></i> Kategoriler</button>
            <button onclick="showSection('tables')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3"><i class="fas fa-chair w-5 text-center"></i> Masalar</button>
            <button onclick="showSection('reports')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3"><i class="fas fa-chart-line w-5 text-center"></i> Raporlar</button>
            <button onclick="showSection('settings')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3"><i class="fas fa-cog w-5 text-center"></i> Ayarlar</button>
        </nav>
        
        <div class="p-4 border-t border-slate-800">
            <button onclick="logout()" class="w-full bg-red-600/90 hover:bg-red-600 py-3 rounded-lg text-sm font-bold transition flex items-center justify-center gap-2 shadow-lg"><i class="fas fa-sign-out-alt"></i> √áIKI≈û YAP</button>
        </div>
    </div>

    <div class="flex-1 flex flex-col overflow-hidden relative">
        <header class="bg-white shadow-sm p-5 flex justify-between items-center z-10">
            <div><h2 id="pageTitle" class="text-2xl font-bold text-gray-800">Dashboard</h2><p class="text-sm text-gray-500 mt-1">Genel bakƒ±≈ü ve istatistikler</p></div>
            <div class="flex items-center gap-4"><div class="text-right hidden sm:block"><div class="text-sm font-bold text-gray-800">Y√∂netici</div><div class="text-xs text-green-500">‚óè √áevrimi√ßi</div></div><div class="w-10 h-10 bg-slate-200 rounded-full flex items-center justify-center text-slate-600"><i class="fas fa-user"></i></div></div>
        </header>

        <main class="flex-1 overflow-y-auto p-6 bg-gray-50/50">
            
            <div id="dashboardSection" class="section">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border-b-4 border-green-500 hover:shadow-md transition"><div class="flex justify-between items-start"><div><h3 class="text-gray-500 text-xs font-bold uppercase tracking-wider">G√ºnl√ºk Ciro</h3><p class="text-3xl font-bold text-slate-800 mt-1" id="statRevenue">0.00 ‚Ç∫</p></div><div class="p-3 bg-green-50 rounded-lg text-green-600"><i class="fas fa-wallet text-xl"></i></div></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-b-4 border-blue-500 hover:shadow-md transition"><div class="flex justify-between items-start"><div><h3 class="text-gray-500 text-xs font-bold uppercase tracking-wider">Bug√ºnk√º Sipari≈ü</h3><p class="text-3xl font-bold text-slate-800 mt-1" id="statTodayOrders">0</p></div><div class="p-3 bg-blue-50 rounded-lg text-blue-600"><i class="fas fa-shopping-bag text-xl"></i></div></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-b-4 border-orange-500 hover:shadow-md transition"><div class="flex justify-between items-start"><div><h3 class="text-gray-500 text-xs font-bold uppercase tracking-wider">Aktif Sipari≈ü</h3><p class="text-3xl font-bold text-slate-800 mt-1" id="statActiveOrders">0</p></div><div class="p-3 bg-orange-50 rounded-lg text-orange-600"><i class="fas fa-fire text-xl"></i></div></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-b-4 border-purple-500 hover:shadow-md transition"><div class="flex justify-between items-start"><div><h3 class="text-gray-500 text-xs font-bold uppercase tracking-wider">Men√º √úr√ºnleri</h3><p class="text-3xl font-bold text-slate-800 mt-1" id="statProducts">-</p></div><div class="p-3 bg-purple-50 rounded-lg text-purple-600"><i class="fas fa-box-open text-xl"></i></div></div></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="font-bold text-gray-800 mb-6 flex items-center gap-2"><i class="fas fa-chart-line text-blue-500"></i> Haftalƒ±k Satƒ±≈ü Grafiƒüi</h3><div class="w-full h-80"><canvas id="salesChart"></canvas></div></div>
            </div>

            <div id="productsSection" class="section hidden">
                <div class="flex justify-between items-center mb-6"><h3 class="text-lg font-bold text-gray-800">√úr√ºn Listesi</h3><button onclick="openProductModal()" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700 transition flex items-center gap-2 shadow-lg shadow-blue-200"><i class="fas fa-plus"></i> Yeni √úr√ºn</button></div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100"><table class="min-w-full divide-y divide-gray-100"><thead class="bg-gray-50"><tr><th class="p-4 text-left text-xs font-bold text-gray-500 uppercase">Resim</th><th class="p-4 text-left text-xs font-bold text-gray-500 uppercase">√úr√ºn Adƒ±</th><th class="p-4 text-left text-xs font-bold text-gray-500 uppercase">Kategori</th><th class="p-4 text-left text-xs font-bold text-gray-500 uppercase">Fiyat</th><th class="p-4 text-center text-xs font-bold text-gray-500 uppercase">ƒ∞≈ülem</th></tr></thead><tbody id="productsTable" class="divide-y divide-gray-100"></tbody></table></div>
            </div>

            <div id="categoriesSection" class="section hidden">
                <div class="flex justify-between items-center mb-6"><h3 class="text-lg font-bold text-gray-800">Kategoriler</h3><button onclick="addCategory()" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700 transition flex items-center gap-2 shadow-lg shadow-blue-200"><i class="fas fa-plus"></i> Yeni Kategori</button></div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100"><table class="min-w-full divide-y divide-gray-100"><thead class="bg-gray-50"><tr><th class="p-4 text-left text-xs font-bold text-gray-500 uppercase">ƒ∞kon</th><th class="p-4 text-left text-xs font-bold text-gray-500 uppercase">Kategori Adƒ±</th><th class="p-4 text-center text-xs font-bold text-gray-500 uppercase">ƒ∞≈ülem</th></tr></thead><tbody id="categoriesTable" class="divide-y divide-gray-100"></tbody></table></div>
            </div>

            <div id="tablesSection" class="section hidden">
                <div class="flex justify-between items-center mb-6"><h3 class="text-lg font-bold text-gray-800">Masa Y√∂netimi</h3><button onclick="addTable()" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700 transition flex items-center gap-2 shadow-lg shadow-blue-200"><i class="fas fa-plus"></i> Yeni Masa</button></div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100"><table class="min-w-full divide-y divide-gray-100"><thead class="bg-gray-50"><tr><th class="p-4 text-left text-xs font-bold text-gray-500 uppercase">Masa Adƒ±</th><th class="p-4 text-left text-xs font-bold text-gray-500 uppercase">Numara</th><th class="p-4 text-center text-xs font-bold text-gray-500 uppercase">ƒ∞≈ülemler</th></tr></thead><tbody id="tablesTable" class="divide-y divide-gray-100"></tbody></table></div>
            </div>
            
            <div id="ordersSection" class="section hidden">
                <div class="flex justify-between items-center mb-6"><h3 class="text-lg font-bold text-gray-800">T√ºm Sipari≈üler</h3><button onclick="loadOrders()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition"><i class="fas fa-sync-alt mr-1"></i> Yenile</button></div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100"><table class="min-w-full divide-y divide-gray-100"><thead class="bg-gray-50"><tr><th class="p-4 text-left text-xs font-bold text-gray-500 uppercase">ID</th><th class="p-4 text-left text-xs font-bold text-gray-500 uppercase">Masa</th><th class="p-4 text-left text-xs font-bold text-gray-500 uppercase">Tutar</th><th class="p-4 text-left text-xs font-bold text-gray-500 uppercase">Durum</th><th class="p-4 text-left text-xs font-bold text-gray-500 uppercase">Tarih</th><th class="p-4 text-center text-xs font-bold text-gray-500 uppercase">ƒ∞≈ülem</th></tr></thead><tbody id="ordersTable" class="divide-y divide-gray-100"></tbody></table></div>
            </div>

            <div id="reportsSection" class="section hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm mb-6">
                    <h3 class="font-bold text-gray-800 mb-4">Tarih Aralƒ±ƒüƒ± Se√ß</h3>
                    <div class="flex gap-4 items-end">
                        <div><label class="text-sm text-gray-500">Ba≈ülangƒ±√ß</label><input type="date" id="reportStart" class="block border p-2 rounded-lg"></div>
                        <div><label class="text-sm text-gray-500">Biti≈ü</label><input type="date" id="reportEnd" class="block border p-2 rounded-lg"></div>
                        <button onclick="loadReports()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Raporla</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
                        <p class="text-gray-500 text-sm">Toplam Ciro</p>
                        <h3 class="text-2xl font-bold text-gray-800" id="repTotalRevenue">0.00 ‚Ç∫</h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500">
                        <p class="text-gray-500 text-sm">Toplam Sipari≈ü</p>
                        <h3 class="text-2xl font-bold text-gray-800" id="repTotalOrders">0</h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-purple-500">
                        <p class="text-gray-500 text-sm">Ortalama Sepet</p>
                        <h3 class="text-2xl font-bold text-gray-800" id="repAvgOrder">0.00 ‚Ç∫</h3>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h4 class="font-bold text-gray-700 mb-4">En √áok Satan √úr√ºnler</h4>
                        <div class="overflow-auto max-h-60">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50 text-gray-500"><tr><th class="p-2">√úr√ºn</th><th class="p-2">Adet</th><th class="p-2 text-right">Tutar</th></tr></thead>
                                <tbody id="topProductsTable" class="divide-y"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h4 class="font-bold text-gray-700 mb-4">G√ºnl√ºk Satƒ±≈ü Grafiƒüi</h4>
                        <div class="h-60"><canvas id="reportChart"></canvas></div>
                    </div>
                </div>
            </div>

            <div id="settingsSection" class="section hidden">
                <div class="max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-sm">
                    <h3 class="text-xl font-bold text-gray-800 mb-6 border-b pb-4">Sistem Ayarlarƒ±</h3>
                    <form onsubmit="saveSettings(event)" class="space-y-4">
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">Restoran Adƒ±</label><input type="text" id="setRestName" class="w-full border p-3 rounded-lg" required></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-gray-700 mb-1">Para Birimi</label><input type="text" id="setCurrency" class="w-full border p-3 rounded-lg" required></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-1">Vergi Oranƒ± (%)</label><input type="number" step="0.1" id="setTax" class="w-full border p-3 rounded-lg" required></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-gray-700 mb-1">Servis √úcreti (%)</label><input type="number" step="0.1" id="setService" class="w-full border p-3 rounded-lg"></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-1">Masa Zaman A≈üƒ±mƒ± (Dk)</label><input type="number" id="setTimeout" class="w-full border p-3 rounded-lg"></div>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">Wi-Fi ≈ûifresi (M√º≈üteriler i√ßin)</label><input type="text" id="setWifi" class="w-full border p-3 rounded-lg"></div>
                        
                        <div class="pt-4"><button type="submit" class="w-full bg-slate-800 text-white py-3 rounded-lg font-bold hover:bg-slate-900 transition">Ayarlarƒ± Kaydet</button></div>
                    </form>
                </div>
            </div>

        </main>
    </div>

    <div id="productModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center z-50 transition-opacity">
        <div class="bg-white rounded-2xl w-96 p-8 shadow-2xl transform scale-100 transition-transform">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Yeni √úr√ºn Ekle</h3>
            <form id="productForm" onsubmit="saveProduct(event)" class="space-y-4">
                <input type="text" name="name" placeholder="√úr√ºn Adƒ±" class="w-full border border-gray-200 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition" required>
                <textarea name="description" placeholder="A√ßƒ±klama" class="w-full border border-gray-200 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition h-24 resize-none"></textarea>
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" name="price" placeholder="Fiyat (TL)" step="0.01" class="w-full border border-gray-200 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition" required>
                    <select name="category_id" id="categorySelect" class="w-full border border-gray-200 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition" required></select>
                </div>
                <div class="border border-dashed border-gray-300 p-4 rounded-xl text-center hover:bg-gray-50 transition cursor-pointer relative"><input type="file" id="productImage" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full"><div class="text-gray-500 text-sm pointer-events-none"><i class="fas fa-cloud-upload-alt text-2xl mb-2 text-blue-400"></i><br>Resim Se√ßmek ƒ∞√ßin Tƒ±kla</div></div>
                <div class="flex justify-end gap-3 pt-4"><button type="button" onclick="closeProductModal()" class="px-5 py-2.5 rounded-xl text-gray-600 hover:bg-gray-100 font-medium transition">ƒ∞ptal</button><button type="submit" class="bg-blue-600 text-white px-6 py-2.5 rounded-xl hover:bg-blue-700 font-bold shadow-lg shadow-blue-200 transition">Kaydet</button></div>
            </form>
        </div>
    </div>
    
    <audio id="bellSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        // Placeholder SVG (Resim hatasƒ±nƒ± √∂nler)
        const placeholderSvg = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgcnk9IjEwIiBmaWxsPSIjZGVlMzE3Ii8+PHBhdGggZD0iTTUwLDEwTDIwLDIwVjgwTDUwLDkwTDgwLDgwVjIwTDUwLDEwWiIgZmlsbD0iI2YxZjVmOSIgc3Ryb2tlPSIjNjQ3NDhiIiBzdHJva2Utd2lkdGg9IjIiLz48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSIxMCIgZmlsbD0iIzY0NzQ4YiIvPjwvc3ZnPg==';

        // --- BA≈ûLANGI√á AYARLARI ---
        let authToken = localStorage.getItem('authToken');
        if(!authToken) window.location.href = '/login.html';
        const getHeaders = () => ({ 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' });
        let chartInstance = null;
        let reportChartInstance = null;

        function showSection(id) {
            document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
            document.getElementById(id + 'Section').classList.remove('hidden');
            document.getElementById('pageTitle').innerText = id.charAt(0).toUpperCase() + id.slice(1);
            
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active', 'bg-slate-800'));
            const activeBtn = document.querySelector(`button[onclick="showSection('${id}')"]`);
            if(activeBtn) activeBtn.classList.add('active', 'bg-slate-800');

            if(id === 'dashboard') loadDashboard();
            if(id === 'products') loadProducts();
            if(id === 'categories') loadCategories();
            if(id === 'tables') loadTables();
            if(id === 'orders') loadOrders();
            if(id === 'reports') loadReports();
            if(id === 'settings') loadSettings();
        }

        function logout() { localStorage.removeItem('authToken'); window.location.href = '/login.html'; }

        // --- DASHBOARD VE GRAFƒ∞KLER ---
        async function loadDashboard() {
            try {
                const res = await fetch('/api/admin/dashboard', {headers: getHeaders()});
                const data = await res.json();
                
                // 1. STATƒ∞K DEƒûERLERƒ∞ Y√úKLE
                document.getElementById('statProducts').innerText = data.overview.total_products;
                document.getElementById('statRevenue').innerText = data.sales.today_revenue.toFixed(2) + ' ‚Ç∫';
                document.getElementById('statTodayOrders').innerText = data.sales.today_orders;
                document.getElementById('statActiveOrders').innerText = data.sales.active_orders;
                
                // 2. GRAFƒ∞K OLU≈ûTURMA
                const ctx = document.getElementById('salesChart').getContext('2d');
                if(chartInstance) chartInstance.destroy();
                
                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.sales.daily_trend.map(d => new Date(d.date).toLocaleDateString('tr-TR', {day:'numeric', month:'short'})),
                        datasets: [{
                            label: 'G√ºnl√ºk Ciro (TL)',
                            data: data.sales.daily_trend.map(d => d.revenue),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 3,
                            pointBackgroundColor: '#ffffff',
                            pointBorderColor: '#10b981',
                            pointRadius: 5,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, grid: { borderDash: [5, 5] } }, x: { grid: { display: false } } }
                    }
                });
            } catch(e) { 
                 console.error("Dashboard y√ºklenirken kritik hata:", e); 
                 document.getElementById('dashboardSection').innerHTML = `<div class="p-6 bg-red-100 text-red-700 rounded-xl font-bold">‚ö†Ô∏è Dashboard verileri y√ºklenemedi. Verilerin doƒüru √ßekildiƒüinden ve Chart.js'in √ßalƒ±≈ütƒ±ƒüƒ±ndan emin olun. Hata: ${e.message}</div>`;
            }
        }

        // --- Sƒ∞PARƒ∞≈û Y√ñNETƒ∞Mƒ∞ ---
        async function loadOrders() {
            const res = await fetch('/api/orders', {headers: getHeaders()}); 
            const data = await res.json();
            const tbody = document.getElementById('ordersTable');
            tbody.innerHTML = '';

            data.forEach(o => {
                let statusClass = 'bg-gray-100 text-gray-600';
                let statusText = o.status.toUpperCase();
                
                if(o.status === 'ready') { statusClass = 'bg-green-100 text-green-700'; statusText = 'HAZIR'; }
                else if(o.status === 'preparing') { statusClass = 'bg-orange-100 text-orange-700'; statusText = 'HAZIRLANIYOR'; }
                else if(o.status === 'pending') { statusClass = 'bg-red-100 text-red-700'; statusText = 'BEKLƒ∞YOR'; }
                else if(o.status === 'delivered') { statusClass = 'bg-blue-100 text-blue-700'; statusText = 'TESLƒ∞M EDƒ∞LDƒ∞'; }
                else if(o.status === 'cancelled') { statusClass = 'bg-slate-200 text-slate-500 line-through'; statusText = 'ƒ∞PTAL'; }

                tbody.innerHTML += `
                <tr class="border-b hover:bg-gray-50 transition">
                    <td class="p-4 font-mono text-sm">#${o.id}</td>
                    <td class="p-4 font-bold text-gray-800">${o.table_name}</td>
                    <td class="p-4 font-bold text-slate-700">${o.total_amount} ‚Ç∫</td>
                    <td class="p-4"><span class="px-3 py-1 rounded-full text-xs font-bold ${statusClass}">${statusText}</span></td>
                    <td class="p-4 text-sm text-gray-500">${new Date(o.created_at).toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'})}</td>
                    <td class="p-4 text-center">
                        ${o.status !== 'cancelled' ? 
                        `<button onclick="cancelOrder(${o.id})" class="text-red-500 hover:text-red-700 hover:bg-red-50 px-3 py-1 rounded transition text-sm font-bold border border-red-200">
                            <i class="fas fa-ban mr-1"></i> ƒ∞ptal
                        </button>` : 
                        '<span class="text-xs text-gray-400">ƒ∞≈ülem Yok</span>'}
                    </td>
                </tr>`;
            });
        }
        
        async function cancelOrder(id) {
            if(!confirm('Bu sipari≈üi iptal etmek istediƒüinize emin misiniz?')) return;
            await fetch(`/api/orders/${id}/status`, { method:'PUT', headers: getHeaders(), body: JSON.stringify({status:'cancelled'}) });
            loadOrders(); 
            loadDashboard();
        }

        // --- √úR√úN ƒ∞≈ûLEMLERƒ∞ ---
        async function loadProducts() {
            const res = await fetch('/api/products'); 
            const data = await res.json(); 
            document.getElementById('productsTable').innerHTML = data.map(p => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4"><img src="${(p.image_url && p.image_url.length > 5) ? p.image_url : placeholderSvg}" 
                                       class="w-12 h-12 rounded-lg object-cover border border-gray-200" 
                                       onerror="this.onerror=null;this.src='${placeholderSvg}'"></td>
                    <td class="p-4 font-medium text-gray-800">${p.name}</td>
                    <td class="p-4 text-gray-500">${p.category?.name || '-'}</td>
                    <td class="p-4 font-bold text-green-600">${p.price} ‚Ç∫</td>
                    <td class="p-4 text-center">
                        <button onclick="deleteProduct(${p.id})" class="w-8 h-8 rounded-full text-red-500 hover:bg-red-50 transition"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`).join('');
        }
        
        async function openProductModal() {
            const res = await fetch('/api/products/categories'); 
            const cats = await res.json(); 
            document.getElementById('categorySelect').innerHTML = '<option value="">Kategori Se√ßiniz</option>' + cats.map(c => `<option value="${c.id}">${c.name}</option>`).join(''); 
            document.getElementById('productModal').classList.remove('hidden');
        }
        function closeProductModal() { document.getElementById('productModal').classList.add('hidden'); }
        
        async function saveProduct(e) {
            e.preventDefault(); 
            const fd = new FormData(e.target); 
            const d = { name: fd.get('name'), description: fd.get('description'), price: parseFloat(fd.get('price')), category_id: parseInt(fd.get('category_id')), is_active: true, is_featured: false }; 
            try {
                const r = await fetch('/api/products', {method:'POST', headers: getHeaders(), body: JSON.stringify(d)}); 
                if(r.ok){ 
                    const np=await r.json(); 
                    const im=document.getElementById('productImage').files[0]; 
                    if(im){
                        const formD=new FormData(); formD.append('file',im); 
                        await fetch(`/api/products/${np.id}/image`, {method:'POST', headers:{'Authorization':`Bearer ${authToken}`}, body:formD});
                    } 
                    closeProductModal(); loadProducts(); alert('√úr√ºn ba≈üarƒ±yla eklendi! (Resim y√ºkleme ba≈üarƒ±lƒ±ysa loglarda g√∂r√ºn√ºr)'); 
                } else { alert('√úr√ºn eklenirken hata olu≈ütu.'); }
            } catch(e) { alert("Baƒülantƒ± hatasƒ±: " + e.message); }
        }
        async function deleteProduct(id) { if(confirm('Silmek istediƒüinize emin misiniz?')) { await fetch(`/api/products/${id}`, {method:'DELETE', headers: getHeaders()}); loadProducts(); } }

        // --- KATEGORƒ∞LER ---
        async function loadCategories() {
            const res = await fetch('/api/products/categories'); 
            const data = await res.json(); 
            document.getElementById('categoriesTable').innerHTML = data.map(c => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4 text-2xl">${c.icon}</td>
                    <td class="p-4 font-medium text-gray-800">${c.name}</td>
                    <td class="p-4 text-center"><button onclick="deleteCategory(${c.id})" class="w-8 h-8 rounded-full text-red-500 hover:bg-red-50 transition"><i class="fas fa-trash"></i></button></td>
                </tr>`).join('');
        }
        async function addCategory() {
            const n = prompt("Kategori Adƒ±:"); if(!n) return; 
            const i = prompt("Kategori ƒ∞konu (Emoji):", "üçî"); 
            await fetch('/api/products/categories', {method:'POST', headers: getHeaders(), body: JSON.stringify({name:n, icon:i, order:1})}); 
            loadCategories();
        }
        async function deleteCategory(id) { if(confirm('Silinsin mi?')) { await fetch(`/api/products/categories/${id}`, {method:'DELETE', headers: getHeaders()}); loadCategories(); } }

        // --- MASALAR ---
        async function loadTables() {
            const res = await fetch('/api/tables', {headers: getHeaders()}); 
            const data = await res.json(); 
            document.getElementById('tablesTable').innerHTML = data.map(t => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4 font-medium text-gray-800">${t.name}</td>
                    <td class="p-4 font-bold text-blue-600">${t.number}</td>
                    <td class="p-4 text-center flex justify-center gap-2">
                        <button onclick="showQR(${t.id})" class="px-3 py-1 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition text-sm font-bold">QR KOD</button>
                        <button onclick="deleteTable(${t.id})" class="px-3 py-1 bg-red-50 text-red-600 rounded hover:bg-red-100 transition text-sm"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`).join('');
        }
        async function addTable() {
            const n = prompt("Masa Adƒ±:"); if(!n) return; 
            const nm = prompt("Masa No:"); 
            await fetch('/api/tables', {method:'POST', headers: getHeaders(), body: JSON.stringify({name:n, number:parseInt(nm)})}); 
            loadTables();
        }
        async function showQR(id) {
            const r = await fetch(`/api/tables/${id}/qr`, {headers: getHeaders()}); const d = await r.json();
            const w = window.open("","_blank"); w.document.write(`<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; font-family:sans-serif;"><h1>${d.table_name}</h1><img src="${d.qr_url}" style="width:300px; height:300px; border:10px solid black; padding:10px;"/><p style="font-size:1.5rem; margin-top:20px;">Masa No: ${d.table_number}</p><button onclick="window.print()" style="margin-top:30px; padding:15px 40px; font-size:1.2rem; background:black; color:white; border:none; cursor:pointer; border-radius:10px;">YAZDIR</button></div>`);
        }
        async function deleteTable(id) { if(confirm('Silinsin mi?')) { await fetch(`/api/tables/${id}`, {method:'DELETE', headers: getHeaders()}); loadTables(); } }

        // --- RAPORLAR ---
        async function loadReports() {
            const start = document.getElementById('reportStart').value;
            const end = document.getElementById('reportEnd').value;
            
            let url = '/api/admin/reports/sales';
            if(start && end) url += `?start_date=${start}&end_date=${end}`;
            
            try {
                const res = await fetch(url, {headers: getHeaders()});
                const data = await res.json();
                
                // 1. STATƒ∞K DEƒûERLERƒ∞ Y√úKLE
                document.getElementById('repTotalRevenue').innerText = data.total_revenue.toFixed(2) + ' ‚Ç∫';
                document.getElementById('repTotalOrders').innerText = data.total_orders;
                document.getElementById('repAvgOrder').innerText = data.average_order.toFixed(2) + ' ‚Ç∫';
                
                // 2. TABLOYU DOLDUR
                const tbody = document.getElementById('topProductsTable');
                tbody.innerHTML = data.top_products.map(p => `
                    <tr><td class="p-2">${p.name}</td><td class="p-2 font-bold">${p.qty}</td><td class="p-2 text-right">${p.total.toFixed(2)} ‚Ç∫</td></tr>
                `).join('');
                
                // 3. GRAFƒ∞K OLU≈ûTURMA
                const ctx = document.getElementById('reportChart').getContext('2d');
                if(reportChartInstance) reportChartInstance.destroy();
                
                reportChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.daily_breakdown.map(d => new Date(d.date).toLocaleDateString('tr-TR')),
                        datasets: [{
                            label: 'Ciro',
                            data: data.daily_breakdown.map(d => d.revenue),
                            backgroundColor: '#3b82f6',
                            borderRadius: 4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
                
            } catch(e) { 
                 console.error("Rapor y√ºklenirken kritik hata:", e); 
                 document.getElementById('reportsSection').innerHTML = `<div class="p-6 bg-red-100 text-red-700 rounded-xl font-bold">‚ö†Ô∏è Rapor verileri y√ºklenemedi. Verilerin doƒüru √ßekildiƒüinden ve Chart.js'in √ßalƒ±≈ütƒ±ƒüƒ±ndan emin olun. Hata: ${e.message}</div>`;
            }
        }

        // --- AYARLAR ---
        async function loadSettings() {
            try {
                const res = await fetch('/api/admin/settings', {headers: getHeaders()});
                const data = await res.json();
                
                document.getElementById('setRestName').value = data.restaurant_name;
                document.getElementById('setCurrency').value = data.currency;
                document.getElementById('setTax').value = data.tax_rate;
                document.getElementById('setService').value = data.service_charge;
                document.getElementById('setTimeout').value = data.order_timeout_minutes;
                document.getElementById('setWifi').value = data.wifi_password || '';
            } catch(e) { console.error(e); }
        }

        async function saveSettings(e) {
            e.preventDefault();
            const data = {
                restaurant_name: document.getElementById('setRestName').value,
                currency: document.getElementById('setCurrency').value,
                tax_rate: parseFloat(document.getElementById('setTax').value),
                service_charge: parseFloat(document.getElementById('setService').value),
                order_timeout_minutes: parseInt(document.getElementById('setTimeout').value),
                wifi_password: document.getElementById('setWifi').value
            };
            
            try {
                const res = await fetch('/api/admin/settings', {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify(data)
                });
                if(res.ok) alert('Ayarlar kaydedildi! ‚úÖ');
                else alert('Hata olu≈ütu.');
            } catch(e) { alert('Baƒülantƒ± hatasƒ±.'); }
        }

        // --- WEBSOCKET & GARSON Bƒ∞LDƒ∞Rƒ∞Mƒ∞ ---
        function connectWS() {
            const ws = new WebSocket(`ws://${location.host}/ws`);
            ws.onopen=()=>ws.send(JSON.stringify({type:'register', client_type:'admin'}));
            ws.onmessage=(e)=>{ 
                try {
                    const m=JSON.parse(e.data); 
                    if(m.type==='waiter_call') {
                        document.getElementById('bellSound').play().catch(e=>console.log(e));
                        if(Notification.permission === "granted") new Notification(m.message);
                        else alert(m.message);
                    }
                    else if(m.type.includes('order')) { 
                        if(!document.getElementById('dashboardSection').classList.contains('hidden')) loadDashboard();
                        if(!document.getElementById('ordersSection').classList.contains('hidden')) loadOrders();
                    }
                } catch(x){} 
            };
            ws.onclose=()=>setTimeout(connectWS, 3000);
        }
        
        if(Notification.permission !== "denied") Notification.requestPermission();
        showSection('dashboard');
        connectWS();
    </script>
</body>
</html>