<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Men√ºs√º</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sticky-categories {
            position: sticky;
            top: 73px; /* Header height (64px) + padding (9px) */
            background: white;
            z-index: 30;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .sticky-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            z-index: 50;
        }
        
        .category-btn {
            transition: all 0.3s ease;
            border: 2px solid transparent;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }
        
        .category-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: #3b82f6;
        }
        
        .category-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        
        .product-card {
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
        }
        
        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: #3b82f6;
        }
        
        .add-to-cart-animation {
            animation: addToCartFly 0.6s ease-out;
        }
        
        @keyframes addToCartFly {
            0% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
            50% {
                transform: scale(1.1) translateY(-10px);
                opacity: 0.8;
            }
            100% {
                transform: scale(0.8) translateY(-50px);
                opacity: 0;
            }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 100;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .cart-icon-bounce {
            animation: cartBounce 0.5s ease-out;
        }
        
        @keyframes cartBounce {
            0%, 20% { transform: scale(1); }
            40% { transform: scale(1.3); }
            60% { transform: scale(0.9); }
            80% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-utensils mr-2"></i>
                    Restaurant Men√ºs√º
                </h1>
                <div class="text-sm text-gray-600">
                    <i class="fas fa-table mr-1"></i>
                    Masa <span id="tableNumber" class="font-semibold">-</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 py-6 pb-32">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <i class="fas fa-spinner fa-spin text-4xl text-gray-400 mb-4"></i>
            <p class="text-gray-600">Men√º y√ºkleniyor...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden text-center py-12">
            <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
            <p class="text-red-600 mb-4">Men√º y√ºklenirken bir hata olu≈ütu</p>
            <button onclick="loadMenu()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                Tekrar Dene
            </button>
        </div>

        <!-- Categories (Sticky) -->
        <div id="categoriesSection" class="hidden sticky-categories">
            <div class="max-w-4xl mx-auto px-4">
                <div class="flex overflow-x-auto space-x-3 pb-2" id="categoriesList">
                    <!-- Categories will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Products Grid -->
        <div id="productsSection" class="hidden">
            <div id="productsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Products will be loaded here -->
            </div>
        </div>

        <!-- No Products State -->
        <div id="noProductsState" class="hidden text-center py-12">
            <i class="fas fa-inbox text-4xl text-gray-400 mb-4"></i>
            <p class="text-gray-600">Hen√ºz √ºr√ºn bulunmuyor</p>
        </div>
    </main>

    <!-- Product Detail Modal -->
    <div id="productModal" class="modal">
        <div class="bg-white rounded-lg max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h2 id="modalProductName" class="text-xl font-bold text-gray-800"></h2>
                    <button onclick="closeProductModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <img id="modalProductImage" class="w-full h-48 object-cover rounded-lg mb-4" src="" alt="">
                
                <p id="modalProductDescription" class="text-gray-600 mb-4"></p>
                
                <div class="flex justify-between items-center mb-4">
                    <span id="modalProductPrice" class="text-2xl font-bold text-green-600"></span>
                    <span id="modalProductCategory" class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm"></span>
                </div>

                <!-- Extras Section -->
                <div id="modalExtrasSection" class="mb-6">
                    <!-- Extras will be loaded here -->
                </div>

                <!-- Special Instructions -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        √ñzel Notlar (ƒ∞steƒüe baƒülƒ±)
                    </label>
                    <textarea 
                        id="modalSpecialInstructions" 
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                        rows="3"
                        placeholder="√ñzel isteklerinizi buraya yazƒ±n..."
                    ></textarea>
                </div>

                <!-- Cross-sell Suggestions -->
                <div id="crossSellSection" class="mb-6">
                    <!-- Cross-sell suggestions will be loaded here -->
                </div>

                <!-- Add to Cart Button -->
                <button 
                    onclick="addToCartFromModal()" 
                    class="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition-colors"
                >
                    <i class="fas fa-cart-plus mr-2"></i>
                    Sepete Ekle
                </button>
            </div>
        </div>
    </div>

    <!-- Cart Summary (Sticky Bottom) -->
    <div id="cartSummary" class="sticky-bottom hidden">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <div class="bg-blue-500 text-white rounded-lg p-4 flex justify-between items-center">
                <div>
                    <div class="font-semibold">
                        <i class="fas fa-shopping-cart mr-2"></i>
                        Sepetiniz
                    </div>
                    <div class="text-sm opacity-90">
                        <span id="cartItemCount">0</span> √ºr√ºn ‚Ä¢ <span id="cartTotal">0.00</span> TL
                    </div>
                </div>
                <button 
                    onclick="showCart()" 
                    class="bg-white text-blue-500 px-4 py-2 rounded-lg font-semibold hover:bg-gray-100 transition-colors"
                >
                    Sipari≈ü Ver
                </button>
            </div>
        </div>
    </div>

    <!-- Cart Modal -->
    <div id="cartModal" class="modal">
        <div class="bg-white rounded-lg max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Sepetiniz</h2>
                    <button onclick="closeCartModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div id="cartItems" class="space-y-4 mb-6">
                    <!-- Cart items will be loaded here -->
                </div>
                
                <div class="border-t pt-4">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-lg font-semibold">Toplam:</span>
                        <span id="cartModalTotal" class="text-xl font-bold text-green-600">0.00 TL</span>
                    </div>
                    
                    <button 
                        onclick="placeOrder()" 
                        class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors"
                    >
                        <i class="fas fa-check mr-2"></i>
                        Sipari≈üi Onayla
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Success Modal -->
    <div id="orderSuccessModal" class="modal">
        <div class="bg-white rounded-lg max-w-md w-full mx-4 p-6 text-center">
            <div class="text-green-500 mb-4">
                <i class="fas fa-check-circle text-6xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Sipari≈üiniz Alƒ±ndƒ±!</h2>
            <p class="text-gray-600 mb-6">Sipari≈üiniz mutfaƒüa iletildi. Hazƒ±r olduƒüunda bildirim alacaksƒ±nƒ±z.</p>
            <button 
                onclick="closeOrderSuccessModal()" 
                class="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition-colors"
            >
                Tamam
            </button>
        </div>
    </div>

    <script>
        // Global variables
        let currentTable = null;
        let categories = [];
        let products = [];
        let cart = [];
        let currentProduct = null;
        let currentCategory = null;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            // Get table number from URL
            const urlParams = new URLSearchParams(window.location.search);
            const tableNumber = urlParams.get('table');
            
            if (tableNumber) {
                currentTable = tableNumber;
                document.getElementById('tableNumber').textContent = tableNumber;
                await loadMenu();
            } else {
                showError('L√ºtfen QR kodu tarayarak men√ºye ula≈üƒ±n');
            }
        }

        async function loadMenu() {
            try {
                showLoading();
                
                // Load categories
                const categoriesResponse = await fetch('/api/products/categories');
                categories = await categoriesResponse.json();
                
                // Load products
                const productsResponse = await fetch('/api/products');
                products = await productsResponse.json();
                
                renderCategories();
                renderProducts();
                hideLoading();
                
            } catch (error) {
                console.error('Error loading menu:', error);
                showError('Men√º y√ºklenirken bir hata olu≈ütu');
            }
        }

        function renderCategories() {
            const categoriesList = document.getElementById('categoriesList');
            categoriesList.innerHTML = '';
            
            // Add "All" category first
            const allCategoryElement = document.createElement('button');
            allCategoryElement.className = 'category-btn flex-shrink-0 rounded-lg px-4 py-3 text-center transition-all';
            if (currentCategory === null) {
                allCategoryElement.classList.add('active');
            }
            allCategoryElement.innerHTML = `
                <div class="text-2xl mb-1">üçΩÔ∏è</div>
                <div class="text-sm font-medium">T√ºm√º</div>
            `;
            allCategoryElement.onclick = () => filterByCategory(null);
            categoriesList.appendChild(allCategoryElement);
            
            categories.forEach(category => {
                const categoryElement = document.createElement('button');
                categoryElement.className = 'category-btn flex-shrink-0 rounded-lg px-4 py-3 text-center transition-all';
                if (currentCategory === category.id) {
                    categoryElement.classList.add('active');
                }
                categoryElement.innerHTML = `
                    <div class="text-2xl mb-1">${category.icon || 'üçΩÔ∏è'}</div>
                    <div class="text-sm font-medium">${category.name}</div>
                `;
                categoryElement.onclick = () => filterByCategory(category.id);
                categoriesList.appendChild(categoryElement);
            });
            
            document.getElementById('categoriesSection').classList.remove('hidden');
        }

        function getFoodImage(categoryName, productName) {
            // Generate appropriate food image based on category and product name
            const categoryImages = {
                'Ana Yemek': ['grilled meat steak with vegetables', 'roasted chicken with herbs', 'beef burger with fries', 'pasta with tomato sauce', 'grilled fish with lemon'],
                'ƒ∞√ßecek': ['fresh orange juice in glass', 'iced coffee with cream', 'fruit smoothie in tall glass', 'cold beer in frosted glass', 'fresh lemonade with mint'],
                'Tatlƒ±': ['chocolate cake with frosting', 'ice cream sundae with toppings', 'fruit tart with berries', 'cheesecake with strawberry', 'baklava with honey'],
                'Salata': ['fresh green salad with tomatoes', 'caesar salad with croutons', 'greek salad with feta cheese', 'fruit salad colorful', 'chicken salad with vegetables'],
                '√áorba': ['hot tomato soup in bowl', 'creamy mushroom soup', 'chicken noodle soup', 'vegetable soup hot', 'lentil soup with herbs'],
                'Kahvaltƒ±': ['turkish breakfast spread', 'fresh croissants with jam', 'omelette with cheese', 'pancakes with syrup', 'fresh bread with butter'],
                'Fast Food': ['crispy french fries', 'cheese pizza slice', 'hot dog with toppings', 'chicken nuggets', 'onion rings crispy'],
                'Pizza': ['margherita pizza fresh', 'pepperoni pizza slice', 'vegetarian pizza colorful', 'cheese pizza melted', 'bbq chicken pizza']
            };
            
            // Default images for unknown categories
            const defaultImages = ['delicious food plate', 'appetizing meal presentation', 'gourmet dish professional', 'tasty food photography', 'restaurant quality meal'];
            
            let searchTerms;
            if (categoryName && categoryImages[categoryName]) {
                searchTerms = categoryImages[categoryName];
            } else {
                searchTerms = defaultImages;
            }
            
            // Select a random term from the appropriate category
            const randomTerm = searchTerms[Math.floor(Math.random() * searchTerms.length)];
            
            // Generate image URL using the food photography API
            return `https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?prompt=${encodeURIComponent(randomTerm + ', professional food photography, high quality, appetizing, restaurant style')}&image_size=landscape_4_3`;
        }
        
        function renderProducts(categoryId = null) {
            const productsGrid = document.getElementById('productsGrid');
            productsGrid.innerHTML = '';
            
            let filteredProducts = products;
            if (categoryId) {
                filteredProducts = products.filter(p => p.category_id === categoryId);
            }
            
            if (filteredProducts.length === 0) {
                document.getElementById('noProductsState').classList.remove('hidden');
                document.getElementById('productsSection').classList.add('hidden');
                return;
            }
            
            document.getElementById('noProductsState').classList.add('hidden');
            document.getElementById('productsSection').classList.remove('hidden');
            
            filteredProducts.forEach(product => {
                const productElement = document.createElement('div');
                productElement.className = 'product-card bg-white rounded-lg shadow-md overflow-hidden cursor-pointer';
                
                // Get high-quality food image based on category
                const categoryName = categories.find(c => c.id === product.category_id)?.name || '';
                const foodImageUrl = getFoodImage(categoryName, product.name);
                
                productElement.innerHTML = `
                    <div class="relative overflow-hidden">
                        <img 
                            src="${foodImageUrl}" 
                            alt="${product.name}" 
                            class="w-full h-48 object-cover transition-transform duration-300 hover:scale-110"
                            onerror="this.src='https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?prompt=${encodeURIComponent('appetizing food, professional photography, high quality')}&image_size=landscape_4_3'"
                        >
                        <div class="absolute top-2 right-2 bg-white bg-opacity-90 rounded-full px-2 py-1">
                            <span class="text-green-600 font-bold text-sm">${product.price.toFixed(2)} TL</span>
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-semibold text-gray-800 text-lg">${product.name}</h3>
                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">
                                ${categoryName}
                            </span>
                        </div>
                        <p class="text-gray-600 text-sm mb-3">${product.description || ''}</p>
                        <button 
                            onclick="showProductDetail(${product.id})" 
                            class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-2 rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all duration-300 font-medium"
                        >
                            <i class="fas fa-eye mr-2"></i>
                            Detaylƒ± G√∂r
                        </button>
                    </div>
                `;
                productsGrid.appendChild(productElement);
            });
        }

        async function showProductDetail(productId) {
            try {
                const response = await fetch(`/api/products/${productId}`);
                currentProduct = await response.json();
                
                document.getElementById('modalProductName').textContent = currentProduct.name;
                
                // Get high-quality food image for modal
                const categoryName = categories.find(c => c.id === currentProduct.category_id)?.name || '';
                const foodImageUrl = getFoodImage(categoryName, currentProduct.name);
                
                document.getElementById('modalProductImage').src = foodImageUrl;
                document.getElementById('modalProductDescription').textContent = currentProduct.description || '';
                document.getElementById('modalProductPrice').textContent = `${currentProduct.price.toFixed(2)} TL`;
                document.getElementById('modalProductCategory').textContent = currentProduct.category.name;
                
                // Render extras
                renderProductExtras(currentProduct.extra_groups);
                
                // Render cross-sell suggestions
                renderCrossSellSuggestions(currentProduct);
                
                // Reset special instructions
                document.getElementById('modalSpecialInstructions').value = '';
                
                document.getElementById('productModal').classList.add('active');
                
            } catch (error) {
                console.error('Error loading product detail:', error);
                alert('√úr√ºn detayƒ± y√ºklenirken bir hata olu≈ütu');
            }
        }

        function renderProductExtras(extraGroups) {
            const extrasSection = document.getElementById('modalExtrasSection');
            extrasSection.innerHTML = '';
            
            if (!extraGroups || extraGroups.length === 0) {
                extrasSection.style.display = 'none';
                return;
            }
            
            extrasSection.style.display = 'block';
            
            extraGroups.forEach(group => {
                const groupElement = document.createElement('div');
                groupElement.className = 'mb-4';
                
                const groupTitle = document.createElement('h4');
                groupTitle.className = 'font-medium text-gray-700 mb-2';
                groupTitle.textContent = group.name;
                if (group.is_required) {
                    groupTitle.innerHTML += ' <span class="text-red-500">*</span>';
                }
                groupElement.appendChild(groupTitle);
                
                const itemsContainer = document.createElement('div');
                itemsContainer.className = 'space-y-2';
                
                group.items.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'flex items-center justify-between p-2 border rounded-lg';
                    
                    const itemLabel = document.createElement('label');
                    itemLabel.className = 'flex items-center cursor-pointer';
                    
                    const input = document.createElement('input');
                    input.type = group.max_selections === 1 ? 'radio' : 'checkbox';
                    input.name = `extra_${group.id}`;
                    input.value = item.id;
                    input.className = 'mr-2';
                    
                    itemLabel.appendChild(input);
                    itemLabel.innerHTML += item.name;
                    
                    const itemPrice = document.createElement('span');
                    itemPrice.className = 'text-sm text-gray-600';
                    itemPrice.textContent = `+${item.price.toFixed(2)} TL`;
                    
                    itemElement.appendChild(itemLabel);
                    itemElement.appendChild(itemPrice);
                    itemsContainer.appendChild(itemElement);
                });
                
                groupElement.appendChild(itemsContainer);
                extrasSection.appendChild(groupElement);
            });
        }
        
        function renderCrossSellSuggestions(currentProduct) {
            const crossSellSection = document.getElementById('crossSellSection');
            crossSellSection.innerHTML = '';
            
            // Smart cross-sell logic based on product category
            let suggestions = [];
            const currentCategory = categories.find(c => c.id === currentProduct.category_id)?.name || '';
            
            // Define cross-sell rules
            const crossSellRules = {
                'Ana Yemek': ['ƒ∞√ßecek', 'Tatlƒ±', 'Salata'],
                'Pizza': ['ƒ∞√ßecek', 'Tatlƒ±'],
                'Fast Food': ['ƒ∞√ßecek', 'Tatlƒ±'],
                '√áorba': ['Ana Yemek', 'ƒ∞√ßecek'],
                'Salata': ['ƒ∞√ßecek', 'Ana Yemek'],
                'Kahvaltƒ±': ['ƒ∞√ßecek', 'Tatlƒ±'],
                'Tatlƒ±': ['ƒ∞√ßecek', 'Kahvaltƒ±'],
                'ƒ∞√ßecek': ['Tatlƒ±', 'Ana Yemek']
            };
            
            const suggestedCategories = crossSellRules[currentCategory] || ['ƒ∞√ßecek', 'Tatlƒ±'];
            
            // Find products from suggested categories (excluding current category)
            suggestedCategories.forEach(categoryName => {
                const category = categories.find(c => c.name === categoryName);
                if (category) {
                    const categoryProducts = products.filter(p => 
                        p.category_id === category.id && p.id !== currentProduct.id
                    );
                    
                    // Take up to 2 products from each suggested category
                    const selectedProducts = categoryProducts.slice(0, 2);
                    suggestions = suggestions.concat(selectedProducts);
                }
            });
            
            if (suggestions.length === 0) return;
            
            // Create cross-sell section
            const sectionTitle = document.createElement('h4');
            sectionTitle.className = 'font-medium text-gray-700 mb-3';
            sectionTitle.innerHTML = 'üéØ <span class="ml-1">Bu √ºr√ºnle iyi gider</span>';
            crossSellSection.appendChild(sectionTitle);
            
            const suggestionsContainer = document.createElement('div');
            suggestionsContainer.className = 'grid grid-cols-2 gap-3';
            
            suggestions.slice(0, 4).forEach(product => {
                const suggestionElement = document.createElement('div');
                suggestionElement.className = 'bg-gray-50 border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-100 hover:border-blue-300 transition-all';
                
                const categoryName = categories.find(c => c.id === product.category_id)?.name || '';
                const foodImageUrl = getFoodImage(categoryName, product.name);
                
                suggestionElement.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <img 
                            src="${foodImageUrl}" 
                            alt="${product.name}" 
                            class="w-12 h-12 object-cover rounded-lg"
                            onerror="this.src='https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?prompt=${encodeURIComponent('appetizing food, small portion')}&image_size=square'"
                        >
                        <div class="flex-1 min-w-0">
                            <h5 class="font-medium text-gray-800 text-sm truncate">${product.name}</h5>
                            <p class="text-xs text-gray-600">${categoryName}</p>
                            <p class="text-sm font-semibold text-green-600">${product.price.toFixed(2)} TL</p>
                        </div>
                        <button 
                            onclick="quickAddToCart(${product.id})" 
                            class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-blue-600 transition-colors"
                            title="Hemen Ekle"
                        >
                            <i class="fas fa-plus text-xs"></i>
                        </button>
                    </div>
                `;
                
                suggestionsContainer.appendChild(suggestionElement);
            });
            
            crossSellSection.appendChild(suggestionsContainer);
        }
        
        function quickAddToCart(productId) {
            // Quick add to cart without opening modal
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const cartItem = {
                id: Date.now(),
                product: product,
                quantity: 1,
                extras: {},
                specialInstructions: ''
            };
            
            cart.push(cartItem);
            updateCartSummary();
            
            // Show quick add animation
            showToast('‚úÖ √úr√ºn sepete eklendi!');
            
            // Bounce cart icon
            const cartSummary = document.getElementById('cartSummary');
            cartSummary.classList.add('cart-icon-bounce');
            setTimeout(() => cartSummary.classList.remove('cart-icon-bounce'), 500);
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
            currentProduct = null;
        }

        function addToCartFromModal() {
            if (!currentProduct) return;
            
            // Get selected extras
            const extras = {};
            const extraGroups = document.querySelectorAll('[id^="modalExtrasSection"] .mb-4');
            
            extraGroups.forEach((group, index) => {
                const groupId = currentProduct.extra_groups[index].id;
                const selectedItems = [];
                
                const inputs = group.querySelectorAll('input:checked');
                inputs.forEach(input => {
                    const itemId = parseInt(input.value);
                    const item = currentProduct.extra_groups[index].items.find(i => i.id === itemId);
                    if (item) {
                        selectedItems.push({
                            id: item.id,
                            name: item.name,
                            price: item.price
                        });
                    }
                });
                
                if (selectedItems.length > 0) {
                    extras[groupId] = selectedItems;
                }
            });
            
            // Get special instructions
            const specialInstructions = document.getElementById('modalSpecialInstructions').value;
            
            // Add to cart
            const cartItem = {
                id: Date.now(),
                product: currentProduct,
                quantity: 1,
                extras: extras,
                specialInstructions: specialInstructions
            };
            
            cart.push(cartItem);
            updateCartSummary();
            
            // Trigger add to cart animation
            animateAddToCart();
            
            closeProductModal();
            
            // Show success message
            showToast('√úr√ºn sepete eklendi!');
        }
        
        function animateAddToCart() {
            // Create flying animation element
            const flyingElement = document.createElement('div');
            flyingElement.className = 'fixed z-50 pointer-events-none';
            flyingElement.innerHTML = `
                <div class="bg-blue-500 text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg">
                    <i class="fas fa-cart-plus"></i>
                </div>
            `;
            
            // Position at modal center
            const modal = document.getElementById('productModal');
            const modalRect = modal.getBoundingClientRect();
            flyingElement.style.left = (modalRect.left + modalRect.width / 2 - 24) + 'px';
            flyingElement.style.top = (modalRect.top + modalRect.height / 2 - 24) + 'px';
            
            document.body.appendChild(flyingElement);
            
            // Get cart summary position
            const cartSummary = document.getElementById('cartSummary');
            const cartRect = cartSummary.getBoundingClientRect();
            
            // Animate to cart
            flyingElement.animate([
                {
                    transform: 'scale(1) translate(0, 0)',
                    opacity: 1
                },
                {
                    transform: `scale(0.8) translate(${cartRect.left - modalRect.left + cartRect.width / 2 - 24}px, ${cartRect.top - modalRect.top + cartRect.height / 2 - 24}px)`,
                    opacity: 0.8
                },
                {
                    transform: `scale(0.5) translate(${cartRect.left - modalRect.left + cartRect.width / 2 - 12}px, ${cartRect.top - modalRect.top + cartRect.height / 2 - 12}px)`,
                    opacity: 0
                }
            ], {
                duration: 800,
                easing: 'ease-out'
            }).onfinish = () => {
                flyingElement.remove();
                // Bounce cart icon
                cartSummary.classList.add('cart-icon-bounce');
                setTimeout(() => cartSummary.classList.remove('cart-icon-bounce'), 500);
            };
        }

        function updateCartSummary() {
            const cartSummary = document.getElementById('cartSummary');
            const cartItemCount = document.getElementById('cartItemCount');
            const cartTotal = document.getElementById('cartTotal');
            
            if (cart.length === 0) {
                cartSummary.classList.add('hidden');
                return;
            }
            
            cartSummary.classList.remove('hidden');
            
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const totalPrice = cart.reduce((sum, item) => {
                let itemTotal = item.product.price * item.quantity;
                
                // Add extras price
                Object.values(item.extras).forEach(extraGroup => {
                    extraGroup.forEach(extra => {
                        itemTotal += extra.price * item.quantity;
                    });
                });
                
                return sum + itemTotal;
            }, 0);
            
            cartItemCount.textContent = totalItems;
            cartTotal.textContent = totalPrice.toFixed(2);
        }

        function showCart() {
            renderCartItems();
            document.getElementById('cartModal').classList.add('active');
        }

        function closeCartModal() {
            document.getElementById('cartModal').classList.remove('active');
        }

        function renderCartItems() {
            const cartItems = document.getElementById('cartItems');
            cartItems.innerHTML = '';
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<p class="text-gray-600 text-center">Sepetiniz bo≈ü</p>';
                return;
            }
            
            let totalPrice = 0;
            
            cart.forEach((item, index) => {
                let itemTotal = item.product.price * item.quantity;
                
                // Calculate extras price
                let extrasText = '';
                Object.values(item.extras).forEach(extraGroup => {
                    extraGroup.forEach(extra => {
                        itemTotal += extra.price * item.quantity;
                        extrasText += `<span class="text-xs bg-gray-100 px-2 py-1 rounded mr-1">${extra.name}</span>`;
                    });
                });
                
                totalPrice += itemTotal;
                
                const itemElement = document.createElement('div');
                itemElement.className = 'flex items-center justify-between p-3 border rounded-lg';
                itemElement.innerHTML = `
                    <div class="flex-1">
                        <h4 class="font-medium text-gray-800">${item.product.name}</h4>
                        <p class="text-sm text-gray-600">${item.product.price.toFixed(2)} TL x ${item.quantity}</p>
                        ${extrasText ? `<div class="mt-1">${extrasText}</div>` : ''}
                        ${item.specialInstructions ? `<p class="text-xs text-gray-500 mt-1">Not: ${item.specialInstructions}</p>` : ''}
                    </div>
                    <div class="flex items-center space-x-2">
                        <button 
                            onclick="updateCartItemQuantity(${index}, ${item.quantity - 1})" 
                            class="bg-gray-200 text-gray-700 w-8 h-8 rounded-full hover:bg-gray-300"
                        >
                            <i class="fas fa-minus"></i>
                        </button>
                        <span class="font-medium">${item.quantity}</span>
                        <button 
                            onclick="updateCartItemQuantity(${index}, ${item.quantity + 1})" 
                            class="bg-gray-200 text-gray-700 w-8 h-8 rounded-full hover:bg-gray-300"
                        >
                            <i class="fas fa-plus"></i>
                        </button>
                        <button 
                            onclick="removeCartItem(${index})" 
                            class="bg-red-100 text-red-600 w-8 h-8 rounded-full hover:bg-red-200"
                        >
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                cartItems.appendChild(itemElement);
            });
            
            document.getElementById('cartModalTotal').textContent = `${totalPrice.toFixed(2)} TL`;
        }

        function updateCartItemQuantity(index, newQuantity) {
            if (newQuantity <= 0) {
                removeCartItem(index);
                return;
            }
            
            cart[index].quantity = newQuantity;
            updateCartSummary();
            renderCartItems();
        }

        function removeCartItem(index) {
            cart.splice(index, 1);
            updateCartSummary();
            renderCartItems();
        }

        async function placeOrder() {
            if (cart.length === 0) {
                alert('Sepetiniz bo≈ü!');
                return;
            }
            
            try {
                // Prepare order data
                const orderData = {
                    table_id: parseInt(currentTable),
                    items: cart.map(item => ({
                        product_id: item.product.id,
                        quantity: item.quantity,
                        extras: item.extras
                    })),
                    customer_notes: cart.map(item => item.specialInstructions).filter(Boolean).join('; ')
                };
                
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    closeCartModal();
                    cart = [];
                    updateCartSummary();
                    document.getElementById('orderSuccessModal').classList.add('active');
                } else {
                    const error = await response.json();
                    alert(`Sipari≈ü verilirken hata olu≈ütu: ${error.detail || 'Bilinmeyen hata'}`);
                }
                
            } catch (error) {
                console.error('Error placing order:', error);
                alert('Sipari≈ü verilirken bir hata olu≈ütu');
            }
        }

        function closeOrderSuccessModal() {
            document.getElementById('orderSuccessModal').classList.remove('active');
        }

        function showToast(message) {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in';
            toast.innerHTML = `
                <i class="fas fa-check mr-2"></i>
                ${message}
            `;
            
            document.body.appendChild(toast);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('categoriesSection').classList.add('hidden');
            document.getElementById('productsSection').classList.add('hidden');
            document.getElementById('noProductsState').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingState').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('categoriesSection').classList.add('hidden');
            document.getElementById('productsSection').classList.add('hidden');
            document.getElementById('noProductsState').classList.add('hidden');
            
            // Update error message
            document.querySelector('#errorState p').textContent = message;
        }

        function filterByCategory(categoryId) {
            currentCategory = categoryId;
            renderCategories(); // Re-render to update active state
            renderProducts(categoryId);
            
            // Smooth scroll to products section
            document.getElementById('productsSection').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }

        // WebSocket connection for real-time order updates
        function connectWebSocket() {
            if (!currentTable) return;
            
            const ws = new WebSocket(`ws://${window.location.host}/ws`);
            
            ws.onopen = function() {
                console.log('WebSocket connected');
                // Register as customer
                ws.send(JSON.stringify({
                    type: 'register',
                    client_type: 'customer'
                }));
            };
            
            ws.onmessage = function(event) {
                const message = JSON.parse(event.data);
                handleWebSocketMessage(message);
            };
            
            ws.onclose = function() {
                console.log('WebSocket disconnected');
                // Reconnect after 5 seconds
                setTimeout(connectWebSocket, 5000);
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }

        function handleWebSocketMessage(message) {
            if (message.type === 'order_updated') {
                // Check if this order belongs to our table
                if (message.data.table_id == currentTable) {
                    showToast(`Sipari≈üiniz ${getStatusText(message.data.status)}!`);
                }
            }
        }

        function getStatusText(status) {
            const statusTexts = {
                'bekliyor': 'alƒ±ndƒ±',
                'hazirlaniyor': 'hazƒ±rlanƒ±yor',
                'hazir': 'hazƒ±r',
                'teslim_edildi': 'teslim edildi'
            };
            return statusTexts[status] || status;
        }

        // Connect WebSocket after page load
        setTimeout(connectWebSocket, 1000);
    </script>
</body>
</html>