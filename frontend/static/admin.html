<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Paneli | Restoran</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .nav-item.active { background-color: #1e293b; border-left: 4px solid #3b82f6; }
        #loadingBar { position: fixed; top: 0; left: 0; height: 4px; background: #3b82f6; z-index: 9999; transition: width 0.3s; width: 0%; }
        
        /* Toast Bildirim */
        .toast-notification { animation: slideInRight 0.5s ease-out forwards; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Kritik Stok Uyarƒ±sƒ± Animasyonu */
        @keyframes criticalPulse {
            0%, 100% { border-color: #ef4444; box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { border-color: #dc2626; box-shadow: 0 0 15px 5px rgba(239, 68, 68, 0.4); }
        }
        .critical-stock-alert {
            animation: criticalPulse 1.5s ease-in-out infinite;
            border: 3px solid #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        }
        
        /* Bildirim Animasyonu */
        @keyframes pulseOnce {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .animate-pulse-once { animation: pulseOnce 0.3s ease-out; }
    </style>
</head>
<body class="bg-gray-50 flex h-screen overflow-hidden font-sans">
    
    <div id="loadingBar"></div>

    <audio id="bellSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <div class="w-64 bg-slate-900 text-white flex-shrink-0 flex flex-col shadow-xl z-20 transition-all duration-300">
        <div class="p-6 text-center border-b border-slate-800 flex flex-col items-center justify-center gap-3">
            <img id="adminPanelLogo" src="/static/uploads/restaurant_logo.png" class="h-16 w-auto object-contain bg-white/10 p-2 rounded-lg mb-2 hidden" onerror="this.style.display='none'">
            <div class="text-xl font-bold flex items-center gap-2">
                <i class="fas fa-utensils text-blue-500"></i> <span>Y√∂netim</span>
            </div>
        </div>
        
        <nav class="flex-1 overflow-y-auto py-6 space-y-1">
            <button onclick="showSection('dashboard')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3 active"><i class="fas fa-chart-pie w-5 text-center"></i> Dashboard</button>
            <button onclick="showSection('orders')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3"><i class="fas fa-receipt w-5 text-center"></i> Sipari≈üler</button>
            <button onclick="showSection('products')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3"><i class="fas fa-hamburger w-5 text-center"></i> √úr√ºnler</button>
            <button onclick="showSection('categories')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3"><i class="fas fa-tags w-5 text-center"></i> Kategoriler</button>
            <button onclick="showSection('tables')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3"><i class="fas fa-chair w-5 text-center"></i> Masalar</button>
            <button onclick="showSection('reports')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3"><i class="fas fa-chart-line w-5 text-center"></i> Raporlar</button>
            <button onclick="showSection('settings')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3"><i class="fas fa-cog w-5 text-center"></i> Ayarlar</button>
            <button onclick="showSection('league')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3"><i class="fas fa-trophy w-5 text-center"></i> Garson Ligi</button>
            <button onclick="showSection('stock')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3"><i class="fas fa-boxes-stacked w-5 text-center"></i> Stok Y√∂netimi</button>
            <button onclick="showSection('waiters')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3"><i class="fas fa-user-friends w-5 text-center"></i> Garsonlar</button>
        </nav>
        
        <div class="p-4 border-t border-slate-800">
            <button onclick="logout()" class="w-full bg-red-600/90 hover:bg-red-600 py-3 rounded-lg text-sm font-bold transition flex items-center justify-center gap-2 shadow-lg"><i class="fas fa-sign-out-alt"></i> √áIKI≈û YAP</button>
        </div>
    </div>

    <div class="flex-1 flex flex-col overflow-hidden relative bg-gray-50">
        <header class="bg-white shadow-sm p-5 flex justify-between items-center z-10 sticky top-0">
            <div>
                <h2 id="pageTitle" class="text-2xl font-bold text-gray-800">Dashboard</h2>
                <p class="text-sm text-gray-500 mt-1">Sistem durumu ve y√∂netim paneli.</p>
            </div>
            
            <!-- Bildirim Paneli -->
            <div id="notificationPanel" class="flex-1 mx-6 max-w-2xl">
                <div id="notificationList" class="flex flex-wrap gap-2 justify-end"></div>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="text-right hidden sm:block">
                    <div class="text-sm font-bold text-gray-800">Y√∂netici</div>
                    <div class="text-xs text-green-500 flex items-center justify-end gap-1">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> √áevrimi√ßi
                    </div>
                </div>
                <div class="w-10 h-10 bg-slate-200 rounded-full flex items-center justify-center text-slate-600">
                    <i class="fas fa-user"></i>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-6 scroll-smooth">
            
            <div id="dashboardSection" class="section">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border-b-4 border-green-500"><p class="text-gray-500 text-xs font-bold uppercase">G√ºnl√ºk Ciro</p><p class="text-3xl font-bold text-slate-800 mt-1" id="statRevenue">0.00 ‚Ç∫</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-b-4 border-blue-500"><p class="text-gray-500 text-xs font-bold uppercase">Bug√ºnk√º Sipari≈ü</p><p class="text-3xl font-bold text-slate-800 mt-1" id="statTodayOrders">0</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-b-4 border-orange-500"><p class="text-gray-500 text-xs font-bold uppercase">Aktif Sipari≈ü</p><p class="text-3xl font-bold text-slate-800 mt-1" id="statActiveOrders">0</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-b-4 border-purple-500"><p class="text-gray-500 text-xs font-bold uppercase">Men√º √úr√ºnleri</p><p class="text-3xl font-bold text-slate-800 mt-1" id="statProducts">-</p></div>
                </div>
                
                <!-- Kritik Stok Uyarƒ±larƒ± - Dashboard -->
                <div id="criticalStockAlertsDashboard" class="mb-6 hidden">
                    <div class="flex items-center gap-2 mb-3">
                        <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
                        <h3 class="font-bold text-red-600">Kritik Stok Uyarƒ±larƒ±</h3>
                    </div>
                    <div id="criticalStockGridDashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                </div>
                
                <!-- A√ßƒ±k Masalar - Grafiƒüin √ºst√ºnde -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-6">
                    <h3 class="font-bold text-gray-800 mb-3">A√ßƒ±k Masalar</h3>
                    <div id="openTablesGridAdmin" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
                
                <!-- Haftalƒ±k Satƒ±≈ü Grafiƒüi -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-6">Haftalƒ±k Satƒ±≈ü Grafiƒüi</h3>
                    <div class="w-full h-80"><canvas id="salesChart"></canvas></div>
                </div>
            </div>

            <div id="productsSection" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-gray-800">√úr√ºn Listesi</h3>
                    <button onclick="openProductModal()" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700 transition shadow-lg flex items-center gap-2"><i class="fas fa-plus"></i> Yeni √úr√ºn</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
                    <table class="min-w-full divide-y divide-gray-100">
                        <thead class="bg-gray-50"><tr><th class="p-4 text-left">Resim</th><th class="p-4 text-left">√úr√ºn Adƒ±</th><th class="p-4 text-left">Kategori</th><th class="p-4 text-left">Fiyat</th><th class="p-4 text-center" style="min-width:180px">ƒ∞≈ülemler</th></tr></thead>
                        <tbody id="productsTable" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="categoriesSection" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-gray-800">Kategoriler</h3>
                    <button onclick="addCategory()" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700 transition shadow-lg">Yeni Kategori</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
                    <table class="min-w-full divide-y divide-gray-100">
                        <thead class="bg-gray-50"><tr><th class="p-4 text-left">ƒ∞kon</th><th class="p-4 text-left">Kategori Adƒ±</th><th class="p-4 text-center">ƒ∞≈ülem</th></tr></thead>
                        <tbody id="categoriesTable" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="tablesSection" class="section hidden">
                <div class="mb-6">
                    <h3 class="text-lg font-bold text-gray-800">A√ßƒ±k Masalar</h3>
                    <div id="openTablesGridTables" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-3"></div>
                </div>
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-gray-800">Masa Y√∂netimi</h3>
                    <button onclick="addTable()" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700 transition shadow-lg">Yeni Masa</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
                    <table class="min-w-full divide-y divide-gray-100">
                        <thead class="bg-gray-50"><tr><th class="p-4 text-left">Masa Adƒ±</th><th class="p-4 text-left">No</th><th class="p-4 text-center">ƒ∞≈ülemler</th></tr></thead>
                        <tbody id="tablesTable" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="ordersSection" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-gray-800">Sipari≈üler</h3>
                    <div class="flex items-center gap-3">
                        <div class="flex items-center gap-2 bg-white border rounded-lg p-1">
                            <button onclick="setOrdersFilter('today')" id="ordersFilterToday" class="px-3 py-1.5 rounded text-sm font-medium bg-blue-600 text-white">Bug√ºn</button>
                            <button onclick="setOrdersFilter('yesterday')" id="ordersFilterYesterday" class="px-3 py-1.5 rounded text-sm font-medium text-gray-600 hover:bg-gray-100">D√ºn</button>
                            <button onclick="setOrdersFilter('week')" id="ordersFilterWeek" class="px-3 py-1.5 rounded text-sm font-medium text-gray-600 hover:bg-gray-100">Bu Hafta</button>
                            <button onclick="setOrdersFilter('custom')" id="ordersFilterCustom" class="px-3 py-1.5 rounded text-sm font-medium text-gray-600 hover:bg-gray-100">Tarih Se√ß</button>
                        </div>
                        <button onclick="loadOrders()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition"><i class="fas fa-sync-alt"></i></button>
                    </div>
                </div>
                
                <!-- Tarih Se√ßici (Custom i√ßin) -->
                <div id="ordersDatePicker" class="bg-white p-4 rounded-xl shadow-sm mb-4 border border-gray-100 hidden">
                    <div class="flex gap-4 items-end flex-wrap">
                        <div>
                            <label class="text-sm text-gray-500 block mb-1">Ba≈ülangƒ±√ß</label>
                            <input type="date" id="ordersStartDate" class="border border-gray-300 p-2 rounded-lg">
                        </div>
                        <div>
                            <label class="text-sm text-gray-500 block mb-1">Biti≈ü</label>
                            <input type="date" id="ordersEndDate" class="border border-gray-300 p-2 rounded-lg">
                        </div>
                        <button onclick="loadOrdersByDate()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Getir</button>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
                    <table class="min-w-full divide-y divide-gray-100">
                        <thead class="bg-gray-50"><tr><th class="p-4 text-left">ID</th><th class="p-4 text-left">Masa</th><th class="p-4 text-left">Tutar</th><th class="p-4 text-left">√ñdeme</th><th class="p-4 text-left">Durum</th><th class="p-4 text-left">Tarih/Saat</th><th class="p-4 text-center">ƒ∞≈ülem</th></tr></thead>
                        <tbody id="ordersTable" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="reportsSection" class="section hidden">
                <!-- Rapor Tipi Se√ßimi -->
                <div class="flex gap-2 mb-6 bg-white p-2 rounded-xl shadow-sm border">
                    <button onclick="setReportType('daily')" id="reportTypeDaily" class="flex-1 py-3 px-4 rounded-lg font-bold transition bg-blue-600 text-white">üìÖ G√ºnl√ºk</button>
                    <button onclick="setReportType('weekly')" id="reportTypeWeekly" class="flex-1 py-3 px-4 rounded-lg font-bold transition text-gray-600 hover:bg-gray-100">üìä Haftalƒ±k</button>
                    <button onclick="setReportType('monthly')" id="reportTypeMonthly" class="flex-1 py-3 px-4 rounded-lg font-bold transition text-gray-600 hover:bg-gray-100">üìà Aylƒ±k</button>
                    <button onclick="setReportType('history')" id="reportTypeHistory" class="flex-1 py-3 px-4 rounded-lg font-bold transition text-gray-600 hover:bg-gray-100">üìÅ Ge√ßmi≈ü</button>
                </div>
                
                <!-- Tarih Se√ßici -->
                <div id="reportDatePicker" class="bg-white p-4 rounded-xl shadow-sm mb-6 border">
                    <div class="flex gap-4 items-end flex-wrap">
                        <div id="dailyDatePicker">
                            <label class="text-sm text-gray-500 block mb-1">Tarih</label>
                            <input type="date" id="reportDate" class="border border-gray-300 p-2 rounded-lg">
                        </div>
                        <button onclick="loadComprehensiveReport()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition shadow-md flex items-center gap-2">
                            <i class="fas fa-sync-alt"></i> Rapor Getir
                        </button>
                    </div>
                </div>

                <!-- √ñzet Kartlarƒ± -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-green-500 to-green-600 p-5 rounded-xl text-white shadow-lg">
                        <p class="text-green-100 text-xs font-bold uppercase">Toplam Ciro</p>
                        <p class="text-2xl font-bold mt-1" id="repTotalRevenue">0.00 ‚Ç∫</p>
                        <div class="mt-2 text-xs text-green-100">
                            <span>üíµ <span id="repCashTotal">0</span></span>
                            <span class="ml-2">üí≥ <span id="repCardTotal">0</span></span>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-5 rounded-xl text-white shadow-lg">
                        <p class="text-blue-100 text-xs font-bold uppercase">Sipari≈ü</p>
                        <p class="text-2xl font-bold mt-1" id="repTotalOrders">0</p>
                        <p class="text-xs text-blue-100 mt-2">ƒ∞ptal: <span id="repCancelledOrders">0</span></p>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-5 rounded-xl text-white shadow-lg">
                        <p class="text-purple-100 text-xs font-bold uppercase">Ort. Sepet</p>
                        <p class="text-2xl font-bold mt-1" id="repAvgOrder">0.00 ‚Ç∫</p>
                    </div>
                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 p-5 rounded-xl text-white shadow-lg">
                        <p class="text-orange-100 text-xs font-bold uppercase">Deƒüi≈üim</p>
                        <p class="text-2xl font-bold mt-1" id="repChange">-</p>
                    </div>
                </div>

                <!-- Ana ƒ∞√ßerik -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <!-- En √áok Satanlar -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border">
                        <h4 class="font-bold text-gray-700 mb-3 flex items-center gap-2">üèÜ En √áok Satanlar</h4>
                        <div class="space-y-2 max-h-48 overflow-y-auto" id="topProductsList"></div>
                    </div>
                    <!-- En Az Satanlar -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border">
                        <h4 class="font-bold text-gray-700 mb-3 flex items-center gap-2">üìâ En Az Satanlar</h4>
                        <div class="space-y-2 max-h-48 overflow-y-auto" id="lowProductsList"></div>
                    </div>
                    <!-- Garson Performansƒ± -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border">
                        <h4 class="font-bold text-gray-700 mb-3 flex items-center gap-2">üë®‚Äçüç≥ Garson Performansƒ±</h4>
                        <div class="space-y-2 max-h-48 overflow-y-auto" id="waiterStatsList"></div>
                    </div>
                </div>

                <!-- Grafik ve Stok -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-bold text-gray-700">üìä Satƒ±≈ü Performansƒ±</h4>
                            <div class="flex gap-1 bg-gray-100 p-1 rounded-lg">
                                <button onclick="setChartType('bar')" id="chartTypeBar" class="px-3 py-1.5 text-xs rounded-md bg-blue-600 text-white font-medium transition">Bar</button>
                                <button onclick="setChartType('line')" id="chartTypeLine" class="px-3 py-1.5 text-xs rounded-md bg-transparent text-gray-600 font-medium hover:bg-gray-200 transition">√áizgi</button>
                                <button onclick="setChartType('doughnut')" id="chartTypeDoughnut" class="px-3 py-1.5 text-xs rounded-md bg-transparent text-gray-600 font-medium hover:bg-gray-200 transition">Pasta</button>
                            </div>
                        </div>
                        <div class="h-64 relative"><canvas id="reportChart"></canvas></div>
                        <div class="mt-4 grid grid-cols-3 gap-2 text-xs">
                            <div class="bg-gradient-to-br from-green-50 to-green-100 p-3 rounded-lg text-center border border-green-200">
                                <div class="text-green-600 font-bold text-sm" id="chartMaxDay">-</div>
                                <div class="text-gray-500 mt-1">En ƒ∞yi G√ºn</div>
                            </div>
                            <div class="bg-gradient-to-br from-red-50 to-red-100 p-3 rounded-lg text-center border border-red-200">
                                <div class="text-red-600 font-bold text-sm" id="chartMinDay">-</div>
                                <div class="text-gray-500 mt-1">En D√º≈ü√ºk G√ºn</div>
                            </div>
                            <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-3 rounded-lg text-center border border-blue-200">
                                <div class="text-blue-600 font-bold text-sm" id="chartAvgDay">-</div>
                                <div class="text-gray-500 mt-1">G√ºnl√ºk Ort.</div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border">
                        <h4 class="font-bold text-gray-700 mb-3 flex items-center gap-2">üì¶ Kritik Stok</h4>
                        <div class="space-y-2 max-h-48 overflow-y-auto" id="criticalStockList"></div>
                        <div class="mt-4 pt-4 border-t text-sm text-gray-500">
                            <span>Toplam Masa: <strong id="repTotalTables">0</strong></span>
                            <span class="ml-4">Toplam √úr√ºn: <strong id="repTotalProducts">0</strong></span>
                        </div>
                    </div>
                </div>

                <!-- AI Analizi -->
                <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-6 rounded-xl shadow-lg text-white mb-6">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-bold text-lg flex items-center gap-2">ü§ñ AI Analizi ve √ñneriler</h4>
                        <button onclick="loadComprehensiveReport()" class="text-xs bg-white/20 px-3 py-1 rounded-full hover:bg-white/30 transition">
                            <i class="fas fa-sync-alt"></i> Yenile
                        </button>
                    </div>
                    <div id="aiAnalysis" class="text-indigo-100 whitespace-pre-line leading-relaxed text-sm">Rapor y√ºkleniyor...</div>
                </div>

                <!-- Ge√ßmi≈ü Raporlar (History modu i√ßin) -->
                <div id="historySection" class="hidden">
                    <div class="bg-white p-5 rounded-xl shadow-sm border">
                        <h4 class="font-bold text-gray-700 mb-4">üìÅ Ge√ßmi≈ü G√ºnler</h4>
                        <div class="space-y-2" id="historyList"></div>
                    </div>
                </div>

                <!-- Aksiyon Butonlarƒ± -->
                <div id="reportActionButtons" class="flex gap-3 flex-wrap">
                    <button onclick="downloadReportPdf()" id="downloadPdfBtn" class="px-5 py-3 bg-slate-800 text-white rounded-lg hover:bg-slate-900 transition shadow-lg flex items-center gap-2">
                        <i class="fas fa-file-pdf"></i> <span id="pdfBtnText">Kapanƒ±≈ü PDF ƒ∞ndir</span>
                    </button>
                </div>
                
                <!-- PDF ƒ∞ndirme Durumu -->
                <div id="pdfDownloadStatus" class="hidden mt-3 p-3 rounded-lg bg-blue-50 border border-blue-200 text-blue-700 text-sm">
                    <i class="fas fa-spinner fa-spin mr-2"></i> PDF olu≈üturuluyor...
                </div>
            </div>

            <div id="settingsSection" class="section hidden">
                <div class="max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="text-xl font-bold text-gray-800 mb-6 border-b pb-4">Sistem Ayarlarƒ±</h3>
                    
                    <div class="mb-8 bg-blue-50/50 p-6 rounded-xl border border-blue-100">
                        <label class="block text-sm font-bold text-gray-700 mb-3">ƒ∞≈ületme Logosu</label>
                        <div class="flex items-center gap-6">
                            <div class="w-28 h-28 border-2 border-dashed border-gray-300 rounded-xl flex items-center justify-center bg-white overflow-hidden relative group shadow-sm">
                                <img id="currentLogo" src="/static/logo.png" class="w-full h-full object-contain p-2" onerror="this.style.display='none'">
                                <div id="logoPlaceholder" class="absolute inset-0 flex items-center justify-center text-gray-400">
                                    <i class="fas fa-image text-3xl"></i>
                                </div>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm text-gray-500 mb-3">Men√º ve fi≈ülerde g√∂r√ºnecek logo.</p>
                                <div class="flex gap-3 items-center">
                                    <label class="cursor-pointer bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition text-sm font-semibold shadow-sm">
                                        <i class="fas fa-upload mr-2 text-blue-500"></i> Resim Se√ß
                                        <input type="file" id="logoInput" accept="image/*" class="hidden" onchange="handleLogoSelect(this)">
                                    </label>
                                    <button onclick="uploadLogo()" id="uploadBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition text-sm font-semibold shadow-md hidden flex items-center gap-2">
                                        <i class="fas fa-save"></i> Y√ºkle
                                    </button>
                                </div>
                                <p id="fileNameDisplay" class="text-xs text-gray-500 mt-2 font-mono"></p>
                            </div>
                        </div>
                    </div>

                    <form onsubmit="saveSettings(event)" class="space-y-5">
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">Restoran Adƒ±</label><input type="text" id="setRestName" class="w-full border p-3 rounded-lg" required></div>
                        <div class="grid grid-cols-2 gap-5">
                            <div><label class="block text-sm font-medium text-gray-700 mb-1">Para Birimi</label><input type="text" id="setCurrency" class="w-full border p-3 rounded-lg" required></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-1">Vergi Oranƒ± (%)</label><input type="number" step="0.1" id="setTax" class="w-full border p-3 rounded-lg" required></div>
                        </div>
                        <div class="grid grid-cols-2 gap-5">
                            <div><label class="block text-sm font-medium text-gray-700 mb-1">Servis √úcreti (%)</label><input type="number" step="0.1" id="setService" class="w-full border p-3 rounded-lg"></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-1">Masa Zaman A≈üƒ±mƒ± (Dk)</label><input type="number" id="setTimeout" class="w-full border p-3 rounded-lg"></div>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">Wi-Fi ≈ûifresi</label><input type="text" id="setWifi" class="w-full border p-3 rounded-lg"></div>
                        <div class="pt-6"><button type="submit" class="w-full bg-slate-800 text-white py-3.5 rounded-lg font-bold hover:bg-slate-900 transition shadow-lg active:scale-95 transform">Ayarlarƒ± G√ºncelle</button></div>
                    </form>
                </div>
            </div>

            <div id="leagueSection" class="section hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm mb-6 border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2"><i class="fas fa-trophy text-yellow-500"></i> Garson Ligi</h3>
                    <p class="text-sm text-gray-500 mb-4">Garsonlarƒ±n sipari≈ü bazlƒ± performans sƒ±ralamasƒ±.</p>
                    <div class="overflow-auto">
                        <table class="min-w-full text-sm">
                            <thead class="bg-gray-50"><tr><th class="p-3 text-center w-16">Sƒ±ra</th><th class="p-3 text-left">Garson</th><th class="p-3 text-right">Puan</th></tr></thead>
                            <tbody id="leagueTable" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="stockSection" class="section hidden">
                <!-- Kritik Stok Uyarƒ±larƒ± - Stok Sekmesi -->
                <div id="criticalStockAlertsStock" class="mb-6 hidden">
                    <div class="flex items-center gap-2 mb-3">
                        <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
                        <h3 class="font-bold text-red-600">Kritik Stok Uyarƒ±larƒ±</h3>
                    </div>
                    <div id="criticalStockGridStock" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                </div>
                
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-gray-800">Stok Y√∂netimi</h3>
                    <button onclick="loadStock()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition">Yenile</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
                    <table class="min-w-full divide-y divide-gray-100">
                        <thead class="bg-gray-50"><tr><th class="p-4 text-left">√úr√ºn</th><th class="p-4 text-right">Mevcut Stok</th><th class="p-4 text-right">Yeni Stok</th><th class="p-4 text-center">ƒ∞≈ülem</th></tr></thead>
                        <tbody id="stockTable" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="waitersSection" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-gray-800">Garsonlar</h3>
                    <div class="flex gap-2 items-end">
                        <input id="newWaiterName" class="border p-2 rounded" placeholder="Ad Soyad">
                        <button onclick="addWaiter()" class="bg-blue-600 text-white px-4 py-2 rounded">GARSON EKLE</button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
                    <table class="min-w-full divide-y divide-gray-100">
                        <thead class="bg-gray-50"><tr><th class="p-4 text-left">Ad Soyad</th><th class="p-4 text-left">Kullanƒ±cƒ±</th><th class="p-4 text-center">ƒ∞≈ülem</th></tr></thead>
                        <tbody id="waitersTable" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <div id="tableActionsModalAdmin" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl w-[90%] max-w-xl p-4">
            <div class="flex justify-between items-center border-b pb-2 mb-3">
                <div class="text-lg font-bold" id="tamTitleAdmin">Masa</div>
                <button onclick="closeTableActions()" class="px-2 py-1 bg-gray-200 rounded">Kapat</button>
            </div>
            <div class="grid grid-cols-3 gap-3">
                <button onclick="adminAddProductFromActions()" class="p-4 bg-green-100 border border-green-300 rounded-lg font-medium text-green-700 hover:bg-green-200 transition">‚ûï √úr√ºn Ekle</button>
                <button onclick="adminActionDetails()" class="p-4 bg-orange-50 border rounded hover:bg-orange-100 transition">Masa detayƒ±</button>
                <button onclick="adminActionClose()" class="p-4 bg-green-50 border rounded hover:bg-green-100 transition">Hesap kes</button>
                <button onclick="adminActionTransfer()" class="p-4 bg-blue-50 border rounded hover:bg-blue-100 transition">Masa deƒüi≈ütir</button>
                <button onclick="adminActionMerge()" class="p-4 bg-gray-50 border rounded hover:bg-gray-100 transition">Masa birle≈ütir</button>
                <button onclick="adminActionPrint()" class="p-4 bg-yellow-50 border rounded hover:bg-yellow-100 transition">Yazdƒ±r</button>
                <button onclick="adminActionCancel()" class="p-4 bg-red-50 border rounded hover:bg-red-100 transition">ƒ∞ptal et</button>
            </div>
        </div>
    </div>
    <div id="paymentModalAdmin" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl w-[90%] max-w-sm p-4">
            <div class="flex justify-between items-center border-b pb-2 mb-3">
                <div class="text-lg font-bold">√ñdeme ≈ûekli</div>
                <button onclick="closePaymentModal()" class="px-2 py-1 bg-gray-200 rounded">Kapat</button>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="confirmCloseTable('cash')" class="p-4 bg-gray-50 border rounded">Nakit</button>
                <button onclick="confirmCloseTable('card')" class="p-4 bg-gray-50 border rounded">Kredi Kartƒ±</button>
            </div>
        </div>
    </div>
    
    <!-- √úr√ºn Ekleme Modalƒ± -->
    <div id="addProductModalAdmin" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl w-[95%] max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center border-b p-4 bg-green-50">
                <div>
                    <div class="text-lg font-bold text-green-800" id="addProductTitle">Masa X - √úr√ºn Ekle</div>
                    <div class="text-sm text-green-600">Eklemek istediƒüiniz √ºr√ºnleri se√ßin</div>
                </div>
                <button onclick="closeAddProductModal()" class="px-3 py-1.5 bg-gray-200 rounded-lg hover:bg-gray-300">‚úï</button>
            </div>
            <div class="p-4 border-b">
                <div id="adminCategories" class="flex gap-2 flex-wrap"></div>
            </div>
            <div class="flex-1 overflow-y-auto p-4">
                <div id="adminProducts" class="grid grid-cols-2 md:grid-cols-3 gap-3"></div>
            </div>
            <div class="border-t p-4 bg-gray-50">
                <div class="mb-3">
                    <div class="text-sm text-gray-500 mb-2">Sepet</div>
                    <div id="adminCartSummary" class="text-sm text-gray-400">Sepet bo≈ü</div>
                </div>
                <button onclick="submitAdminOrder()" class="w-full py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 transition">‚úì Sipari≈üi G√∂nder</button>
            </div>
        </div>
    </div>

    <div id="productModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl w-96 p-8 shadow-2xl">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Yeni √úr√ºn</h3>
            <form id="productForm" onsubmit="saveProduct(event)" class="space-y-4">
                <input type="text" name="name" placeholder="√úr√ºn Adƒ±" class="w-full border p-3 rounded-xl" required>
                <textarea name="description" placeholder="A√ßƒ±klama" class="w-full border p-3 rounded-xl h-24"></textarea>
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" name="price" placeholder="Fiyat (TL)" step="0.01" class="w-full border p-3 rounded-xl" required>
                    <select name="category_id" id="categorySelect" class="w-full border p-3 rounded-xl" required></select>
                </div>
                <input type="file" id="productImage" accept="image/*" class="block w-full text-sm border p-2 rounded-lg">
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeProductModal()" class="px-5 py-2.5 rounded-xl bg-gray-200 hover:bg-gray-300">ƒ∞ptal</button>
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2.5 rounded-xl hover:bg-blue-700 font-bold">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- GLOBAL AYARLAR ---
        const placeholderSvg = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgcnk9IjEwIiBmaWxsPSIjZGVlMzE3Ii8+PHBhdGggZD0iTTUwLDEwTDIwLDIwVjgwTDUwLDkwTDgwLDgwVjIwTDUwLDEwWiIgZmlsbD0iI2YxZjVmOSIgc3Ryb2tlPSIjNjQ3NDhiIiBzdHJva2Utd2lkdGg9IjIiLz48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSIxMCIgZmlsbD0iIzY0NzQ4YiIvPjwvc3ZnPg==';
        let authToken = localStorage.getItem('authToken');
        if(!authToken) window.location.href = '/login.html';
        const getHeaders = () => ({ 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' });
        let chartInstance = null;
        let categories = [];

        // --- Y√úKLEME BAR ---
        function showLoading() { document.getElementById('loadingBar').style.width = '100%'; }
        function hideLoading() { setTimeout(() => { document.getElementById('loadingBar').style.width = '0%'; }, 300); }

        // --- SAYFA GE√áƒ∞≈ûLERƒ∞ ---
        function showSection(id) {
            document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
            const section = document.getElementById(id + 'Section');
            if(section) section.classList.remove('hidden');
            
            const title = document.getElementById('pageTitle');
            if(title) title.innerText = id.charAt(0).toUpperCase() + id.slice(1);

            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active', 'bg-slate-800'));
            const activeBtn = document.querySelector(`button[onclick="showSection('${id}')"]`);
            if(activeBtn) activeBtn.classList.add('active', 'bg-slate-800');

            // Sayfa y√ºkleme mantƒ±ƒüƒ±
            if(id === 'dashboard') loadDashboard();
            else if(id === 'reports') { 
                // Tarih input'una bug√ºn√º ayarla
                const dateInput = document.getElementById('reportDate');
                if(dateInput && !dateInput.value) dateInput.value = new Date().toISOString().split('T')[0];
                loadComprehensiveReport(); 
            }
            else if(id === 'products') { loadCategories(false); loadProducts(); }
            else if(id === 'categories') loadCategories();
            else if(id === 'tables') loadTables();
            else if(id === 'orders') loadOrders();
            else if(id === 'league') loadLeague();
            else if(id === 'stock') loadStock();
            else if(id === 'waiters') loadWaiters();
            else if(id === 'settings') loadSettings();
        }

        function logout() { localStorage.removeItem('authToken'); window.location.href = '/login.html'; }

        // --- RAPORLAMA FONKSƒ∞YONU (D√úZELTƒ∞LDƒ∞) ---
        async function loadReports() {
            showLoading();
            const s = document.getElementById('reportStart').value;
            const e = document.getElementById('reportEnd').value;
            
            let url = '/api/admin/reports/sales';
            if(s && e) url += `?start_date=${s}&end_date=${e}`;

            try {
                console.log("Rapor isteniyor:", url);
                const res = await fetch(url, {headers: getHeaders()});
                
                if(!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                
                const data = await res.json();
                console.log("Rapor Geldi:", data);

                // Verileri Doldur
                document.getElementById('repTotalRevenue').innerText = (data.total_revenue || 0).toFixed(2) + ' ‚Ç∫';
                document.getElementById('repTotalOrders').innerText = data.total_orders || 0;
                document.getElementById('repAvgOrder').innerText = (data.average_order || 0).toFixed(2) + ' ‚Ç∫';
                
                // √ñdeme y√∂ntemi daƒüƒ±lƒ±mƒ±
                document.getElementById('repCashTotal').innerText = (data.cash_total || 0).toFixed(2) + ' ‚Ç∫';
                document.getElementById('repCardTotal').innerText = (data.card_total || 0).toFixed(2) + ' ‚Ç∫';

                // Tabloyu Doldur
                const tbody = document.getElementById('topProductsTable');
                if(data.top_products && data.top_products.length > 0) {
                    tbody.innerHTML = data.top_products.map(p => `
                        <tr class="hover:bg-gray-50 border-b last:border-0">
                            <td class="p-3 font-medium text-gray-700">${p.name}</td>
                            <td class="p-3 font-bold text-center">${p.qty}</td>
                            <td class="p-3 text-right font-mono text-slate-600">${p.total.toFixed(2)} ‚Ç∫</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-400">Veri yok</td></tr>';
                }

                // Grafiƒüi √áiz
                if(window.Chart) {
                    const ctx = document.getElementById('reportChart').getContext('2d');
                    if(chartInstance) chartInstance.destroy();
                    
                    // Eƒüer breakdown verisi bo≈üsa bo≈ü grafik √ßizmemek i√ßin kontrol
                    const labels = (data.daily_breakdown || []).map(x => new Date(x.date).toLocaleDateString('tr-TR'));
                    const values = (data.daily_breakdown || []).map(x => x.revenue);

                    chartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Ciro (‚Ç∫)',
                                data: values,
                                backgroundColor: '#3b82f6',
                                borderRadius: 4
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                }

            } catch(e) {
                console.error("Rapor hatasƒ±:", e);
                alert("Rapor y√ºklenirken hata olu≈ütu. Konsolu kontrol edin.");
            } finally {
                hideLoading();
            }
        }

        let actionTableId=null; let actionTableNum=null;
        function openTableActions(id, num){ actionTableId=id; actionTableNum=num; const m=document.getElementById('tableActionsModalAdmin'); document.getElementById('tamTitleAdmin').innerText=`Masa ${num}`; m.classList.remove('hidden'); m.classList.add('flex'); }
        function closeTableActions(){ const m=document.getElementById('tableActionsModalAdmin'); m.classList.add('hidden'); m.classList.remove('flex'); }
        async function adminActionDetails(){ 
            showLoading(); 
            try { 
                const r = await fetch(`/api/tables/details/${actionTableId}`, {headers:getHeaders()}); 
                const d = await r.json(); 
                
                // Aktif sipari≈üleri filtrele
                const activeOrders = (d.orders||[]).filter(o=>['pending','preparing','ready','bekliyor','hazirlaniyor','hazir'].includes((o.status||'').toLowerCase()));
                
                // Varƒ±≈ü zamanƒ±
                const arrivalTime = d.arrival_time ? new Date(d.arrival_time).toLocaleString('tr-TR', {hour:'2-digit', minute:'2-digit', day:'2-digit', month:'2-digit'}) : '-';
                
                // Sipari≈üleri detaylƒ± g√∂ster
                let ordersHtml = '';
                if(activeOrders.length > 0) {
                    ordersHtml = activeOrders.map((o, idx) => {
                        const orderTime = o.created_at ? new Date(o.created_at).toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'}) : '-';
                        const statusText = {'pending':'Bekliyor','preparing':'Hazƒ±rlanƒ±yor','ready':'Hazƒ±r','bekliyor':'Bekliyor','hazirlaniyor':'Hazƒ±rlanƒ±yor','hazir':'Hazƒ±r'}[o.status?.toLowerCase()] || o.status;
                        const statusColor = {'pending':'orange','preparing':'blue','ready':'green','bekliyor':'orange','hazirlaniyor':'blue','hazir':'green'}[o.status?.toLowerCase()] || 'gray';
                        
                        const itemsHtml = (o.items||[]).map(i => `
                            <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-0">
                                <div class="flex-1">
                                    <span class="font-medium">${i.name}</span>
                                    <span class="text-gray-500 text-sm ml-2">x${i.quantity}</span>
                                    ${i.extras && Object.keys(i.extras).length > 0 ? `<div class="text-xs text-gray-400">${JSON.stringify(i.extras)}</div>` : ''}
                                </div>
                                <div class="text-right">
                                    <div class="font-mono text-sm">${Number(i.unit_price||0).toFixed(2)} ‚Ç∫</div>
                                    <div class="font-mono font-bold">${Number(i.subtotal||0).toFixed(2)} ‚Ç∫</div>
                                </div>
                            </div>
                        `).join('');
                        
                        return `
                            <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                                <div class="flex justify-between items-center mb-2">
                                    <div class="flex items-center gap-2">
                                        <span class="font-bold text-gray-700">Sipari≈ü #${o.id}</span>
                                        <span class="text-xs px-2 py-0.5 rounded bg-${statusColor}-100 text-${statusColor}-700">${statusText}</span>
                                    </div>
                                    <span class="text-sm text-gray-500"><i class="fas fa-clock mr-1"></i>${orderTime}</span>
                                </div>
                                ${o.customer_notes ? `<div class="text-sm text-amber-600 mb-2 p-2 bg-amber-50 rounded"><i class="fas fa-sticky-note mr-1"></i>${o.customer_notes}</div>` : ''}
                                <div class="space-y-1">${itemsHtml}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    ordersHtml = '<div class="text-gray-400 text-sm text-center py-4">Aktif sipari≈ü yok</div>';
                }
                
                const w = document.createElement('div'); 
                w.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50'; 
                w.innerHTML = `
                    <div class='bg-white rounded-xl w-[90%] max-w-2xl max-h-[90vh] overflow-hidden flex flex-col'>
                        <div class='flex justify-between items-center border-b p-4'>
                            <div>
                                <div class='text-lg font-bold'>Masa ${actionTableNum} - Hesap Detayƒ±</div>
                                <div class='text-sm text-gray-500'><i class="fas fa-clock mr-1"></i>A√ßƒ±lƒ±≈ü: ${arrivalTime}</div>
                            </div>
                            <button class='px-3 py-1.5 bg-gray-200 rounded-lg hover:bg-gray-300' onclick='this.closest(".fixed").remove()'>Kapat</button>
                        </div>
                        <div class='flex-1 overflow-y-auto p-4'>
                            ${ordersHtml}
                        </div>
                        <div class='border-t p-4 bg-gray-50'>
                            <div class='flex justify-between items-center'>
                                <span class='font-bold text-lg'>Toplam Tutar</span>
                                <span class='font-mono text-2xl font-bold text-green-600'>${Number(d.total_amount||0).toFixed(2)} ‚Ç∫</span>
                            </div>
                        </div>
                    </div>
                `; 
                document.body.appendChild(w); 
            } catch(e) { console.error(e); } 
            finally { hideLoading(); }
        }
        function adminActionClose(){ const m=document.getElementById('paymentModalAdmin'); m.classList.remove('hidden'); m.classList.add('flex'); }
        function closePaymentModal(){ const m=document.getElementById('paymentModalAdmin'); m.classList.add('hidden'); m.classList.remove('flex'); }
        async function confirmCloseTable(method){ showLoading(); try{ await fetch(`/api/tables/close/${actionTableId}`, {method:'POST', headers:getHeaders(), body:JSON.stringify({payment_method: method})}); }catch(e){} finally{ hideLoading(); closePaymentModal(); closeTableActions(); loadOpenTables(); showToast(method==='cash'?'Nakit':'Kart', method==='cash'?'green':'purple'); }}
        async function adminActionPrint(){ showLoading(); try{ await fetch(`/api/tables/print-bill/${actionTableId}`, {method:'POST', headers:getHeaders()}); }catch(e){} finally{ hideLoading(); }}
        async function adminActionTransfer(){ const tgt=prompt('Hedef masa numarasƒ±:'); if(!tgt) return; showLoading(); try{ const r=await fetch('/api/tables?active_only=false',{headers:getHeaders()}); const d=await r.json(); const t=d.find(x=>x.number==parseInt(tgt)); if(!t){ alert('Masa bulunamadƒ±'); } else { await fetch(`/api/tables/transfer/${actionTableId}/${t.id}`,{method:'POST',headers:getHeaders()}); } }catch(e){} finally{ hideLoading(); closeTableActions(); loadOpenTables(); }}
        async function adminActionMerge(){ const tgt=prompt('Birle≈ütirilecek masa numarasƒ±:'); if(!tgt) return; showLoading(); try{ const r=await fetch('/api/tables?active_only=false',{headers:getHeaders()}); const d=await r.json(); const t=d.find(x=>x.number==parseInt(tgt)); if(!t){ alert('Masa bulunamadƒ±'); } else { await fetch(`/api/tables/merge/${actionTableId}/${t.id}`,{method:'POST',headers:getHeaders()}); } }catch(e){} finally{ hideLoading(); closeTableActions(); loadOpenTables(); }}
        async function adminActionCancel(){ showLoading(); try{ const dr=await fetch(`/api/tables/details/${actionTableId}`,{headers:getHeaders()}); const d=await dr.json(); const active=(d.orders||[]).filter(o=>['pending','preparing','bekliyor','hazirlaniyor'].includes((o.status||'').toLowerCase())); for(const o of active){ await fetch(`/api/orders/${o.id}/status`,{method:'PUT',headers:getHeaders(),body:JSON.stringify({status:'cancelled'})}); } }catch(e){} finally{ hideLoading(); closeTableActions(); loadOpenTables(); }}
        
        // --- √úR√úN EKLEME FONKSƒ∞YONLARI ---
        let adminCart = [];
        let adminProducts = [];
        let adminCategories = [];
        let addProductTableId = null;
        let addProductTableNum = null;
        
        function adminAddProduct(tableId, tableNum) {
            addProductTableId = tableId;
            addProductTableNum = tableNum;
            document.getElementById('addProductTitle').innerText = `Masa ${tableNum} - √úr√ºn Ekle`;
            adminCart = [];
            loadAdminMenuData();
            document.getElementById('addProductModalAdmin').classList.remove('hidden');
            document.getElementById('addProductModalAdmin').classList.add('flex');
        }
        
        function adminAddProductFromActions() {
            closeTableActions();
            adminAddProduct(actionTableId, actionTableNum);
        }
        
        function closeAddProductModal() {
            document.getElementById('addProductModalAdmin').classList.add('hidden');
            document.getElementById('addProductModalAdmin').classList.remove('flex');
            adminCart = [];
        }
        
        async function loadAdminMenuData() {
            try {
                const cr = await fetch('/api/products/categories', {headers: getHeaders()});
                const cd = await cr.json();
                adminCategories = cd.categories || cd;
                
                const pr = await fetch('/api/products?available_only=true', {headers: getHeaders()});
                const pd = await pr.json();
                adminProducts = Array.isArray(pd) ? pd : (pd.products || []);
                
                renderAdminMenu();
            } catch(e) { console.error(e); }
        }
        
        function renderAdminMenu() {
            const catsDiv = document.getElementById('adminCategories');
            const prodsDiv = document.getElementById('adminProducts');
            
            catsDiv.innerHTML = `<button onclick="filterAdminCat(null)" class="px-3 py-2 bg-blue-600 text-white rounded-lg font-medium">T√ºm√º</button>` + 
                adminCategories.map(c => `<button onclick="filterAdminCat(${c.id})" class="px-3 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 font-medium">${c.name}</button>`).join('');
            
            renderAdminProducts(adminProducts);
            renderAdminCartSummary();
        }
        
        function filterAdminCat(catId) {
            const filtered = catId ? adminProducts.filter(p => p.category_id == catId) : adminProducts;
            renderAdminProducts(filtered);
        }
        
        function renderAdminProducts(products) {
            const prodsDiv = document.getElementById('adminProducts');
            prodsDiv.innerHTML = products.map(p => {
                const inCart = adminCart.find(x => x.product_id == p.id);
                const qty = inCart ? inCart.quantity : 0;
                const selectedClass = qty > 0 ? 'bg-green-50 border-green-400 border-2' : 'border-gray-200';
                return `<div class="border rounded-xl p-3 ${selectedClass}">
                    <div class="font-bold text-gray-800 text-sm">${p.name}</div>
                    <div class="text-sm text-gray-500 mb-2">${(p.price||0).toFixed(2)} ‚Ç∫</div>
                    <div class="flex items-center justify-between">
                        ${qty > 0 ? `
                            <div class="flex items-center gap-2">
                                <button onclick="removeFromAdminCart(${p.id})" class="w-7 h-7 flex items-center justify-center bg-red-500 text-white rounded-full text-sm font-bold">-</button>
                                <span class="font-bold text-green-600">${qty}</span>
                                <button onclick="addToAdminCart(${p.id})" class="w-7 h-7 flex items-center justify-center bg-green-500 text-white rounded-full text-sm font-bold">+</button>
                            </div>
                        ` : `
                            <button onclick="addToAdminCart(${p.id})" class="w-full py-1.5 bg-green-500 text-white rounded-lg text-sm font-medium hover:bg-green-600">+ Ekle</button>
                        `}
                    </div>
                </div>`;
            }).join('');
        }
        
        function addToAdminCart(pid) {
            const p = adminProducts.find(x => x.id == pid);
            if(!p) return;
            const i = adminCart.find(x => x.product_id == pid);
            if(i) i.quantity += 1;
            else adminCart.push({product_id: pid, quantity: 1, extras: {}});
            renderAdminProducts(adminProducts);
            renderAdminCartSummary();
        }
        
        function removeFromAdminCart(pid) {
            const i = adminCart.findIndex(x => x.product_id == pid);
            if(i >= 0) {
                if(adminCart[i].quantity > 1) adminCart[i].quantity--;
                else adminCart.splice(i, 1);
            }
            renderAdminProducts(adminProducts);
            renderAdminCartSummary();
        }
        
        function renderAdminCartSummary() {
            const summary = document.getElementById('adminCartSummary');
            if(adminCart.length === 0) {
                summary.innerHTML = '<span class="text-gray-400">Sepet bo≈ü</span>';
                return;
            }
            let total = 0;
            const items = adminCart.map(c => {
                const p = adminProducts.find(x => x.id == c.product_id);
                if(!p) return '';
                const subtotal = (p.price || 0) * c.quantity;
                total += subtotal;
                return `<span class="inline-block bg-green-100 text-green-700 px-2 py-1 rounded mr-1 mb-1">${c.quantity}x ${p.name}</span>`;
            }).join('');
            summary.innerHTML = `${items}<div class="mt-2 font-bold text-lg text-green-600">Toplam: ${total.toFixed(2)} ‚Ç∫</div>`;
        }
        
        async function submitAdminOrder() {
            if(!addProductTableNum || adminCart.length === 0) {
                alert('√úr√ºn se√ßin');
                return;
            }
            showLoading();
            try {
                const body = {table_number: addProductTableNum, items: adminCart};
                const r = await fetch('/api/orders', {method: 'POST', headers: getHeaders(), body: JSON.stringify(body)});
                if(r.ok) {
                    showToast('Sipari≈ü g√∂nderildi!', 'green');
                    closeAddProductModal();
                    loadOpenTables();
                } else {
                    alert('Sipari≈ü hatasƒ±');
                }
            } catch(e) {
                alert('ƒ∞stek hatasƒ±');
            } finally {
                hideLoading();
            }
        }
        async function loadOpenTables(){ showLoading(); try{ const r=await fetch('/api/tables/open', {headers:getHeaders()}); const d=await r.json(); const adminGrid=document.getElementById('openTablesGridAdmin'); if(adminGrid){ const items=(d||[]).map(t=>`<div class="border rounded-xl p-4 ${t.total_amount>0?'border-green-300 bg-green-50':'border-gray-200 bg-white'}"><div class="flex justify-between items-center cursor-pointer" onclick="openTableActions(${t.table_id}, ${t.table_number})"><div class="font-bold">Masa ${t.table_number}</div><div class="font-mono">${(t.total_amount||0).toFixed(2)} ‚Ç∫</div></div><div class="mt-2 text-xs text-gray-600">${t.items.length} kalem</div><div class="mt-3 flex gap-2"><button onclick="adminAddProduct(${t.table_id}, ${t.table_number})" class="flex-1 bg-green-500 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-green-600 transition">‚ûï √úr√ºn Ekle</button><button onclick="openTableActions(${t.table_id}, ${t.table_number})" class="flex-1 bg-blue-500 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-blue-600 transition">‚öôÔ∏è ƒ∞≈ülemler</button></div></div>`).join(''); adminGrid.innerHTML=items||'<div class="text-gray-400 text-sm">Hi√ß a√ßƒ±k masa yok</div>'; } const tablesGrid=document.getElementById('openTablesGridTables'); if(tablesGrid){ const items=(d||[]).map(t=>`<div class="border rounded-xl p-4 ${t.total_amount>0?'border-green-300 bg-green-50':'border-gray-200 bg-white'}"><div class="flex justify-between items-center cursor-pointer" onclick="openTableActions(${t.table_id}, ${t.table_number})"><div class="font-bold">Masa ${t.table_number}</div><div class="font-mono">${(t.total_amount||0).toFixed(2)} ‚Ç∫</div></div><div class="mt-2 text-xs text-gray-600">${t.items.length} kalem</div><div class="mt-3 flex gap-2"><button onclick="adminAddProduct(${t.table_id}, ${t.table_number})" class="flex-1 bg-green-500 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-green-600 transition">‚ûï √úr√ºn Ekle</button><button onclick="openTableActions(${t.table_id}, ${t.table_number})" class="flex-1 bg-blue-500 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-blue-600 transition">‚öôÔ∏è ƒ∞≈ülemler</button></div></div>`).join(''); tablesGrid.innerHTML=items||'<div class="text-gray-400 text-sm">Hi√ß a√ßƒ±k masa yok</div>'; } }catch(e){} finally{ hideLoading(); }}

        async function loadProductMatrix(){
            showLoading();
            try{
                const res = await fetch('/api/admin/reports/product-matrix', {headers: getHeaders()});
                const data = await res.json();
                const ai = document.getElementById('aiAnalysis');
                ai.innerText = (data.analysis || '').toString();
            }catch(e){ alert('√úr√ºn matrisi getirilemedi'); }
            finally{ hideLoading(); }
        }

        async function downloadClosingPdf(){
            try{
                const res = await fetch('/api/admin/reports/closing-report-pdf', {headers: getHeaders()});
                if(res.ok){
                    const url = '/static/uploads/closing_report.pdf?t=' + new Date().getTime();
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'closing_report.pdf';
                    a.click();
                } else {
                    alert('PDF olu≈üturulamadƒ±');
                }
            }catch(e){ alert('PDF isteƒüi ba≈üarƒ±sƒ±z'); }
        }

        async function loadLeague(){
            showLoading();
            try{
                const res = await fetch('/api/admin/league', {headers: getHeaders()});
                const data = await res.json();
                const tbody = document.getElementById('leagueTable');
                const rows = (data || []).map((w, index) => {
                    // ƒ∞lk 3 i√ßin √∂zel renkler
                    let rankIcon = '';
                    let rowClass = '';
                    if(index === 0) { rankIcon = 'ü•á'; rowClass = 'bg-yellow-50'; }
                    else if(index === 1) { rankIcon = 'ü•à'; rowClass = 'bg-gray-50'; }
                    else if(index === 2) { rankIcon = 'ü•â'; rowClass = 'bg-orange-50'; }
                    else { rankIcon = `<span class="text-gray-400">${index + 1}</span>`; }
                    
                    return `<tr class="${rowClass} hover:bg-gray-100 transition">
                        <td class="p-3 text-center text-xl">${rankIcon}</td>
                        <td class="p-3 font-medium text-gray-800">${w.full_name || w.username}</td>
                        <td class="p-3 text-right font-bold text-blue-600 font-mono">${w.total_orders} puan</td>
                    </tr>`;
                }).join('');
                tbody.innerHTML = rows || '<tr><td colspan="3" class="p-4 text-center text-gray-400">Hen√ºz garson yok</td></tr>';
            }catch(e){ console.error('League y√ºklenemedi:', e); }finally{hideLoading();}
        }

        async function loadStock(){
            showLoading();
            try{
                const res = await fetch('/api/products', {headers: getHeaders()});
                const data = await res.json();
                const tbody = document.getElementById('stockTable');
                tbody.innerHTML = (data||[]).map(p => `
                    <tr class="border-b hover:bg-gray-50 transition">
                        <td class="p-4 font-medium text-gray-800">${p.name}</td>
                        <td class="p-4 text-right font-mono">${p.track_stock ? p.stock : '‚àû'}</td>
                        <td class="p-4 text-right">${p.track_stock ? `<input type=\"number\" min=\"0\" class=\"w-24 border p-2 rounded-lg text-right\" id=\"stock-${p.id}\" value=\"${p.stock}\">` : '<span class=\"text-xs text-gray-400\">Takip Kapalƒ±</span>'}</td>
                        <td class="p-4 text-center"><button onclick="${p.track_stock ? `saveStock(${p.id})` : `toggleTrack(${p.id}, true)`}" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">${p.track_stock ? 'G√ºncelle' : 'Takibi A√ß'}</button></td>
                    </tr>
                `).join('');
                // Kritik stok uyarƒ±larƒ±nƒ± y√ºkle
                loadCriticalStockAlerts('stock');
            }catch(e){}finally{hideLoading();}
        }

        async function saveStock(productId){
            showLoading();
            try{
                const input = document.getElementById('stock-' + productId);
                const qty = parseInt(input.value||'0');
                const res = await fetch('/api/products/' + productId, {method:'PUT', headers: getHeaders(), body: JSON.stringify({stock: qty, initial_stock: qty})});
                if(res.ok){ loadStock(); loadCriticalStockAlerts('all'); }
                else{ alert('G√ºncelleme ba≈üarƒ±sƒ±z'); }
            }catch(e){ alert('ƒ∞stek hatasƒ±'); }finally{ hideLoading(); }
        }

        async function toggleTrack(id, status){
            showLoading();
            try{
                await fetch('/api/products/' + id, {method:'PUT', headers: getHeaders(), body: JSON.stringify({track_stock: status, stock: status ? 0 : 0})});
                loadStock();
            }catch(e){}finally{hideLoading();}
        }

        // --- DASHBOARD ---
        async function loadDashboard() {
            showLoading();
            try {
                const res = await fetch('/api/admin/dashboard', {headers: getHeaders()});
                if(res.status === 401) { logout(); return; }
                const data = await res.json();
                
                document.getElementById('statProducts').innerText = data.overview.total_products || '0';
                document.getElementById('statRevenue').innerText = (data.sales.today_revenue || 0).toFixed(2) + ' ‚Ç∫';
                document.getElementById('statTodayOrders').innerText = data.sales.today_orders || '0';
                document.getElementById('statActiveOrders').innerText = data.sales.active_orders || '0';
                
                if(window.Chart) {
                    const ctx = document.getElementById('salesChart').getContext('2d');
                    if(chartInstance) chartInstance.destroy();
                    chartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: (data.sales.daily_trend || []).map(d => new Date(d.date).toLocaleDateString('tr-TR', {day:'numeric', month:'short'})),
                            datasets: [{
                                label: 'G√ºnl√ºk Ciro',
                                data: (data.sales.daily_trend || []).map(d => d.revenue),
                                borderColor: '#10b981',
                                tension: 0.3,
                                fill: true,
                                backgroundColor: 'rgba(16, 185, 129, 0.1)'
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                }
                // Kritik stok uyarƒ±larƒ±nƒ± y√ºkle
                loadCriticalStockAlerts('dashboard');
            } catch(e){} finally { hideLoading(); }
        }

        // --- KRƒ∞Tƒ∞K STOK UYARILARI ---
        async function loadCriticalStockAlerts(target) {
            try {
                const res = await fetch('/api/admin/critical-stock', {headers: getHeaders()});
                if(!res.ok) return;
                const data = await res.json();
                const products = data.critical_products || [];
                
                // Dashboard i√ßin
                if(target === 'dashboard' || target === 'all') {
                    const container = document.getElementById('criticalStockAlertsDashboard');
                    const grid = document.getElementById('criticalStockGridDashboard');
                    if(container && grid) {
                        if(products.length > 0) {
                            container.classList.remove('hidden');
                            grid.innerHTML = products.map(p => `
                                <div class="critical-stock-alert rounded-xl p-4">
                                    <div class="flex items-center gap-2 mb-2">
                                        <i class="fas fa-exclamation-circle text-red-500"></i>
                                        <span class="font-bold text-red-700">${p.name}</span>
                                    </div>
                                    <div class="text-sm text-red-600">
                                        Stok: <span class="font-bold">${p.current_stock}</span> adet
                                        <span class="text-xs text-red-400 ml-2">(%${p.percentage})</span>
                                    </div>
                                </div>
                            `).join('');
                        } else {
                            container.classList.add('hidden');
                        }
                    }
                }
                
                // Stok sekmesi i√ßin
                if(target === 'stock' || target === 'all') {
                    const container = document.getElementById('criticalStockAlertsStock');
                    const grid = document.getElementById('criticalStockGridStock');
                    if(container && grid) {
                        if(products.length > 0) {
                            container.classList.remove('hidden');
                            grid.innerHTML = products.map(p => `
                                <div class="critical-stock-alert rounded-xl p-4">
                                    <div class="flex items-center gap-2 mb-2">
                                        <i class="fas fa-exclamation-circle text-red-500"></i>
                                        <span class="font-bold text-red-700">${p.name}</span>
                                    </div>
                                    <div class="text-sm text-red-600">
                                        Stok: <span class="font-bold">${p.current_stock}</span> adet
                                        <span class="text-xs text-red-400 ml-2">(%${p.percentage})</span>
                                    </div>
                                </div>
                            `).join('');
                        } else {
                            container.classList.add('hidden');
                        }
                    }
                }
            } catch(e) { console.error('Kritik stok y√ºklenemedi:', e); }
        }

        // --- Dƒ∞ƒûER FONKSƒ∞YONLAR ---
        async function loadProducts() {
            showLoading();
            try {
                const res = await fetch('/api/products'); 
                const rawData = await res.json();
                const products = Array.isArray(rawData) ? rawData : (rawData.products || []);
                
                document.getElementById('productsTable').innerHTML = products.map(p => {
                    const imgUrl = (p.image_url && p.image_url.length > 5) ? p.image_url : placeholderSvg;
                    const catName = p.category ? p.category.name : (categories.find(c => c.id == p.category_id)?.name || '-');
                    const stockBtnClass = p.track_stock ? 'bg-green-100 text-green-700 border-green-300' : 'bg-gray-100 text-gray-500 border-gray-300';
                    const stockBtnText = p.track_stock ? '<i class="fas fa-box-open mr-1"></i>Takip A√ßƒ±k' : '<i class="fas fa-box mr-1"></i>Takip Kapalƒ±';
                    const stockInfo = p.track_stock ? `<span class="text-xs text-gray-400 ml-2">(Stok: ${p.stock || 0})</span>` : '';
                    return `
                    <tr class="border-b hover:bg-gray-50 transition">
                        <td class="p-4"><div class="w-12 h-12 rounded-lg overflow-hidden bg-gray-100 border"><img src="${imgUrl}" class="w-full h-full object-cover" onerror="this.src='${placeholderSvg}'"></div></td>
                        <td class="p-4 font-medium text-gray-800">${p.name}${stockInfo}</td>
                        <td class="p-4 text-sm text-gray-500">${catName}</td>
                        <td class="p-4 font-bold text-green-600 font-mono">${p.price.toFixed(2)} ‚Ç∫</td>
                        <td class="p-4 text-center flex items-center justify-center gap-2">
                            <button onclick="toggleStockTrack(${p.id}, ${!p.track_stock})" class="px-2 py-1 text-xs border rounded ${stockBtnClass} hover:opacity-80 transition">${stockBtnText}</button>
                            <button onclick="deleteProduct(${p.id})" class="text-red-500 hover:bg-red-50 p-2 rounded-full transition"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                }).join('');
            } catch(e){} finally { hideLoading(); }
        }
        // (Diƒüer fonksiyonlar √ºr√ºn ekleme/silme vb. aynƒ± mantƒ±kla buraya eklenebilir, yer kaplamamasƒ± i√ßin kƒ±salttƒ±m)
        
        async function saveProduct(e){e.preventDefault();showLoading();const fd=new FormData(e.target);const d={name:fd.get('name'),description:fd.get('description'),price:parseFloat(fd.get('price')),category_id:parseInt(fd.get('category_id')),is_active:true};try{const r=await fetch('/api/products',{method:'POST',headers:getHeaders(),body:JSON.stringify(d)});if(r.ok){const np=await r.json();const im=document.getElementById('productImage').files[0];if(im){const f=new FormData();f.append('file',im);await fetch(`/api/products/${np.id}/image`,{method:'POST',headers:{'Authorization':`Bearer ${authToken}`},body:f});}closeProductModal();loadProducts();alert('Eklendi!');}else alert('Hata');}catch(e){alert(e);}finally{hideLoading();}}
        
        // Stok takibi a√ßma/kapama fonksiyonu
        async function toggleStockTrack(productId, newStatus) {
            showLoading();
            try {
                const res = await fetch('/api/products/' + productId, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify({ track_stock: newStatus, stock: newStatus ? 0 : 0, initial_stock: 0 })
                });
                if(res.ok) {
                    loadProducts();
                    showToast(newStatus ? 'Stok takibi a√ßƒ±ldƒ±' : 'Stok takibi kapatƒ±ldƒ±', newStatus ? 'green' : 'gray');
                } else {
                    alert('G√ºncelleme ba≈üarƒ±sƒ±z');
                }
            } catch(e) {
                alert('ƒ∞stek hatasƒ±');
            } finally {
                hideLoading();
            }
        }
        async function deleteProduct(id){if(confirm('Sil?')){showLoading();await fetch(`/api/products/${id}`,{method:'DELETE',headers:getHeaders()});loadProducts();hideLoading();}}
        async function openProductModal(){const r=await fetch('/api/products/categories');const d=await r.json();categories=d.categories||d;document.getElementById('categorySelect').innerHTML='<option>Se√ß</option>'+categories.map(c=>`<option value="${c.id}">${c.name}</option>`);document.getElementById('productModal').classList.remove('hidden');}
        function closeProductModal(){document.getElementById('productModal').classList.add('hidden');}
        
        // Kategoriler
        async function loadCategories(render=true){if(render)showLoading();try{const r=await fetch('/api/products/categories');const d=await r.json();categories=d.categories||d;if(render)document.getElementById('categoriesTable').innerHTML=categories.map(c=>`<tr class="border-b hover:bg-gray-50"><td class="p-4 text-2xl">${c.icon||''}</td><td class="p-4 font-bold text-gray-700">${c.name}</td><td class="p-4 text-center"><button onclick="deleteCategory(${c.id})" class="text-red-500 hover:bg-red-50 p-2 rounded-full"><i class="fas fa-trash"></i></button></td></tr>`).join('');}catch(e){}finally{if(render)hideLoading();}}
        async function addCategory(){const n=prompt('Ad:');if(!n)return;const i=prompt('ƒ∞kon:','üçî');showLoading();await fetch('/api/products/categories',{method:'POST',headers:getHeaders(),body:JSON.stringify({name:n,icon:i})});loadCategories();hideLoading();}
        async function deleteCategory(id){if(confirm('Sil?')){showLoading();await fetch(`/api/products/categories/${id}`,{method:'DELETE',headers:getHeaders()});loadCategories();hideLoading();}}

        // Masalar
        async function loadTables(){showLoading();try{const r=await fetch('/api/tables',{headers:getHeaders()});const d=await r.json();document.getElementById('tablesTable').innerHTML=d.map(t=>`<tr class="border-b hover:bg-gray-50"><td class="p-4 font-medium">${t.name}</td><td class="p-4 font-bold text-blue-600">${t.number}</td><td class="p-4 text-center"><button onclick="showQR(${t.id})" class="text-blue-600 mr-3 font-bold text-sm">QR</button><button onclick="deleteTable(${t.id})" class="text-red-500"><i class="fas fa-trash"></i></button></td></tr>`).join('');}catch(e){}finally{hideLoading();}}
        async function addTable(){const n=prompt('Ad:');if(!n)return;const num=prompt('No:');showLoading();await fetch('/api/tables',{method:'POST',headers:getHeaders(),body:JSON.stringify({name:n,number:parseInt(num)})});loadTables();hideLoading();}
        async function deleteTable(id){if(confirm('Sil?')){showLoading();await fetch(`/api/tables/${id}`,{method:'DELETE',headers:getHeaders()});loadTables();hideLoading();}}
        async function showQR(id){const r=await fetch(`/api/tables/${id}/qr`,{headers:getHeaders()});const d=await r.json();const w=window.open("","_blank");w.document.write(`<div style="text-align:center;margin-top:50px;font-family:sans-serif"><h1>${d.table_name}</h1><img src="${d.qr_url}" width="300"><br><button onclick="window.print()" style="margin-top:20px;padding:10px 20px;font-size:1.2em">YAZDIR</button></div>`);}

        // Sipari≈üler
        let currentOrdersFilter = 'today';
        
        function setOrdersFilter(filter) {
            currentOrdersFilter = filter;
            // Buton stillerini g√ºncelle
            ['today','yesterday','week','custom'].forEach(f => {
                const btn = document.getElementById('ordersFilter' + f.charAt(0).toUpperCase() + f.slice(1));
                if(btn) {
                    if(f === filter) {
                        btn.classList.add('bg-blue-600', 'text-white');
                        btn.classList.remove('text-gray-600', 'hover:bg-gray-100');
                    } else {
                        btn.classList.remove('bg-blue-600', 'text-white');
                        btn.classList.add('text-gray-600', 'hover:bg-gray-100');
                    }
                }
            });
            // Tarih se√ßici g√∂ster/gizle
            const datePicker = document.getElementById('ordersDatePicker');
            if(datePicker) {
                if(filter === 'custom') {
                    datePicker.classList.remove('hidden');
                } else {
                    datePicker.classList.add('hidden');
                    loadOrders();
                }
            }
        }
        
        function getOrdersDateRange() {
            const today = new Date();
            today.setHours(0,0,0,0);
            let start, end;
            
            if(currentOrdersFilter === 'today') {
                start = today;
                end = new Date(today);
                end.setHours(23,59,59,999);
            } else if(currentOrdersFilter === 'yesterday') {
                start = new Date(today);
                start.setDate(start.getDate() - 1);
                end = new Date(start);
                end.setHours(23,59,59,999);
            } else if(currentOrdersFilter === 'week') {
                start = new Date(today);
                start.setDate(start.getDate() - 7);
                end = new Date(today);
                end.setHours(23,59,59,999);
            } else {
                // custom - tarih se√ßiciden al
                const startInput = document.getElementById('ordersStartDate');
                const endInput = document.getElementById('ordersEndDate');
                start = startInput?.value ? new Date(startInput.value) : today;
                end = endInput?.value ? new Date(endInput.value) : today;
                end.setHours(23,59,59,999);
            }
            return { start, end };
        }
        
        async function loadOrders() {
            showLoading();
            try {
                const r = await fetch('/api/orders', {headers:getHeaders()});
                const allOrders = await r.json();
                
                // Tarih filtresine g√∂re filtrele
                const { start, end } = getOrdersDateRange();
                const filtered = allOrders.filter(o => {
                    const orderDate = new Date(o.created_at);
                    return orderDate >= start && orderDate <= end;
                });
                
                // Tarihe g√∂re sƒ±rala (en yeni en √ºstte)
                filtered.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
                
                const statusColors = {
                    'pending': 'bg-yellow-100 text-yellow-700',
                    'preparing': 'bg-blue-100 text-blue-700',
                    'ready': 'bg-green-100 text-green-700',
                    'delivered': 'bg-gray-100 text-gray-600',
                    'cancelled': 'bg-red-100 text-red-700'
                };
                
                const paymentIcons = {
                    'cash': 'üíµ Nakit',
                    'card': 'üí≥ Kart',
                    null: '-',
                    undefined: '-'
                };
                
                document.getElementById('ordersTable').innerHTML = filtered.length > 0 ? filtered.map(o => {
                    const statusClass = statusColors[o.status?.toLowerCase()] || 'bg-gray-100 text-gray-600';
                    const paymentText = paymentIcons[o.payment_method] || '-';
                    const dateTime = new Date(o.created_at);
                    const dateStr = dateTime.toLocaleDateString('tr-TR', {day:'2-digit', month:'2-digit'});
                    const timeStr = dateTime.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
                    
                    return `<tr class="border-b hover:bg-gray-50">
                        <td class="p-4 text-gray-500 font-mono">#${o.id}</td>
                        <td class="p-4 font-bold">${o.table_name || 'Masa ' + o.table_id}</td>
                        <td class="p-4 font-bold text-slate-700">${(o.total_amount||0).toFixed(2)} ‚Ç∫</td>
                        <td class="p-4 text-sm">${paymentText}</td>
                        <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${statusClass}">${o.status}</span></td>
                        <td class="p-4 text-sm text-gray-500">${dateStr} ${timeStr}</td>
                        <td class="p-4 text-center">
                            ${o.status?.toLowerCase() !== 'cancelled' && o.status?.toLowerCase() !== 'delivered' ? 
                                `<button onclick="cancelOrder(${o.id})" class="text-red-500 border border-red-200 px-2 py-1 rounded text-xs hover:bg-red-50">ƒ∞ptal</button>` : 
                                '<span class="text-gray-400 text-xs">-</span>'}
                        </td>
                    </tr>`;
                }).join('') : '<tr><td colspan="7" class="p-8 text-center text-gray-400">Bu tarih aralƒ±ƒüƒ±nda sipari≈ü bulunamadƒ±</td></tr>';
            } catch(e) { console.error(e); } 
            finally { hideLoading(); }
        }
        
        function loadOrdersByDate() {
            loadOrders();
        }
        
        async function cancelOrder(id){if(!confirm('ƒ∞ptal?'))return;showLoading();await fetch(`/api/orders/${id}/status`,{method:'PUT',headers:getHeaders(),body:JSON.stringify({status:'cancelled'})});loadOrders();hideLoading();}

        // Ayarlar ve Logo
        function handleLogoSelect(input){if(input.files&&input.files[0]){const r=new FileReader();r.onload=e=>{document.getElementById('currentLogo').src=e.target.result;document.getElementById('currentLogo').style.display='block';document.getElementById('logoPlaceholder').style.display='none';document.getElementById('uploadBtn').classList.remove('hidden');};r.readAsDataURL(input.files[0]);document.getElementById('fileNameDisplay').innerText=input.files[0].name;}}
        async function uploadLogo(){const fi=document.getElementById('logoInput');if(fi.files.length===0)return;showLoading();const fd=new FormData();fd.append('file',fi.files[0]);try{const r=await fetch('/api/admin/settings/logo',{method:'POST',headers:{'Authorization':`Bearer ${authToken}`},body:fd});if(r.ok){alert('Y√ºklendi!');loadSettings();}else alert('Hata');}catch(e){alert(e);}finally{hideLoading();}}
        async function loadSettings(){showLoading();try{const r=await fetch('/api/admin/settings',{headers:getHeaders()});if(r.ok){const d=await r.json();document.getElementById('setRestName').value=d.restaurant_name||'';document.getElementById('setCurrency').value=d.currency||'';document.getElementById('setTax').value=d.tax_rate||0;document.getElementById('setService').value=d.service_charge||0;document.getElementById('setTimeout').value=d.order_timeout_minutes||30;document.getElementById('setWifi').value=d.wifi_password||'';if(d.logo_url){const url=d.logo_url+'?t='+new Date().getTime();document.getElementById('currentLogo').src=url;document.getElementById('currentLogo').style.display='block';document.getElementById('logoPlaceholder').style.display='none';const al=document.getElementById('adminPanelLogo');if(al){al.src=url;al.style.display='block';al.classList.remove('hidden');}}}}catch(e){}finally{hideLoading();}}
        async function saveSettings(e){e.preventDefault();showLoading();const d={restaurant_name:document.getElementById('setRestName').value,currency:document.getElementById('setCurrency').value,tax_rate:parseFloat(document.getElementById('setTax').value),service_charge:parseFloat(document.getElementById('setService').value),order_timeout_minutes:parseInt(document.getElementById('setTimeout').value),wifi_password:document.getElementById('setWifi').value};await fetch('/api/admin/settings',{method:'PUT',headers:getHeaders(),body:JSON.stringify(d)});alert('Kaydedildi!');hideLoading();}

        // --- Bƒ∞LDƒ∞Rƒ∞M Sƒ∞STEMƒ∞ ---
        let notifications = [];
        let notificationIdCounter = 0;
        
        function addNotification(data) {
            const notification = {
                id: ++notificationIdCounter,
                type: data.type,
                table_name: data.table_name,
                table_number: data.table_number,
                timestamp: data.timestamp || new Date().toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'}),
                message: data.message
            };
            notifications.push(notification);
            renderNotifications();
        }
        
        function deleteNotification(id) {
            notifications = notifications.filter(n => n.id !== id);
            renderNotifications();
        }
        
        function renderNotifications() {
            const container = document.getElementById('notificationList');
            if(!container) return;
            
            if(notifications.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = notifications.map(n => {
                const isWaiterCall = n.type === 'waiter_call';
                const bgColor = isWaiterCall ? 'bg-amber-50 border-amber-300' : 'bg-purple-50 border-purple-300';
                const textColor = isWaiterCall ? 'text-amber-700' : 'text-purple-700';
                const icon = isWaiterCall ? 'fa-bell' : 'fa-credit-card';
                const iconColor = isWaiterCall ? 'text-amber-500' : 'text-purple-500';
                const tableDisplay = n.table_number ? `Masa ${n.table_number}` : n.table_name;
                
                return `<div class="flex items-center gap-2 px-3 py-2 rounded-lg border ${bgColor} shadow-sm animate-pulse-once">
                    <i class="fas ${icon} ${iconColor}"></i>
                    <div class="flex-1">
                        <div class="font-bold ${textColor} text-sm">${tableDisplay}</div>
                        <div class="text-xs text-gray-500">${isWaiterCall ? 'Garson √áaƒürƒ±sƒ±' : 'Hesap ƒ∞steƒüi'} ‚Ä¢ ${n.timestamp}</div>
                    </div>
                    <button onclick="deleteNotification(${n.id})" class="w-6 h-6 flex items-center justify-center rounded-full hover:bg-red-100 text-red-400 hover:text-red-600 transition" title="Bildirimi Sil">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>`;
            }).join('');
        }
        
        // WebSocket
        function connectWS() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
            ws.onopen = () => ws.send(JSON.stringify({type:'register', client_type:'admin'}));
            ws.onmessage = (e) => {
                try {
                    const m = JSON.parse(e.data);
                    if(m.type === 'waiter_call' || m.type === 'bill_request') {
                        document.getElementById('bellSound').play().catch(()=>{});
                        // Kalƒ±cƒ± bildirim paneline ekle
                        addNotification(m);
                        // Ayrƒ±ca kƒ±sa s√ºreli toast da g√∂ster
                        showToast(m.message, m.type === 'bill_request' ? 'purple' : 'orange');
                    } else if(m.type === 'stock_warning') {
                        showToast(m.message, 'red');
                    } else if(m.type && m.type.includes('order')) {
                        if(!document.getElementById('dashboardSection').classList.contains('hidden')) loadDashboard();
                        if(!document.getElementById('ordersSection').classList.contains('hidden')) loadOrders();
                        loadOpenTables();
                    } else if(m.type === 'table_status') {
                        loadOpenTables();
                    }
                } catch(x){}
            };
            ws.onclose = () => setTimeout(connectWS, 3000);
        }

        function showToast(msg, color) {
            const div = document.createElement('div');
            div.className = `fixed top-5 right-5 bg-white border-l-4 border-${color}-500 text-gray-700 px-6 py-4 shadow-2xl z-50 flex items-center gap-3 rounded-r toast-notification`;
            div.innerHTML = `<i class="fas fa-bell text-${color}-500 text-xl"></i> <span class="font-bold">${msg}</span>`;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }

        // BA≈ûLAT
        window.onload = () => {
            showSection('dashboard');
            loadSettings();
            connectWS();
            loadOpenTables();
            // PDF buton metnini ba≈ülangƒ±√ßta ayarla
            updatePdfButtonText();
        };

        async function loadWaiters(){
            showLoading();
            try{
                const r = await fetch('/api/waiters', {headers: getHeaders()});
                const d = await r.json();
                const tbody = document.getElementById('waitersTable');
                const rows = (d||[]).map(w => `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-4 font-medium">${w.full_name||'-'}</td>
                        <td class="p-4">${w.username}</td>
                        <td class="p-4 text-center"><button onclick="resetWaiterPin(${w.id})" class="bg-amber-600 text-white px-3 py-1 rounded mr-2">PIN Sƒ±fƒ±rla</button><button onclick="deleteWaiter(${w.id})" class="bg-red-600 text-white px-3 py-1 rounded">Sil</button></td>
                    </tr>
                `);
                tbody.innerHTML = rows.join('') || '<tr><td colspan="3" class="p-4 text-center text-gray-400">Garson yok</td></tr>';
            }catch(e){}finally{hideLoading();}
        }
        async function addWaiter(){
            const n = document.getElementById('newWaiterName').value.trim();
            if(!n){ alert('Ad Soyad gerekli'); return; }
            showLoading();
            try{
                const r = await fetch('/api/waiters', {method:'POST', headers:getHeaders(), body: JSON.stringify({full_name:n})});
                if(r.ok){ const d=await r.json(); alert(`Garson eklendi. ≈ûifre: ${d.pin}`); document.getElementById('newWaiterName').value=''; loadWaiters(); }
                else{ alert('Ekleme ba≈üarƒ±sƒ±z'); }
            }catch(x){ alert('ƒ∞stek hatasƒ±'); }
            finally{ hideLoading(); }
        }
        
        async function deleteWaiter(id){
            if(!confirm('Silinsin?')) return;
            showLoading();
            try{ await fetch('/api/waiters/'+id, {method:'DELETE', headers:getHeaders()}); loadWaiters(); }
            catch(x){}
            finally{ hideLoading(); }
        }
        async function resetWaiterPin(id){
            showLoading();
            try{ const r=await fetch('/api/waiters/'+id+'/reset-pin', {method:'POST', headers:getHeaders()}); if(r.ok){ const d=await r.json(); alert('Yeni PIN: '+d.pin); } else { alert('PIN sƒ±fƒ±rlama ba≈üarƒ±sƒ±z'); } }
            catch(x){ alert('ƒ∞stek hatasƒ±'); }
            finally{ hideLoading(); }
        }

        // --- KAPSAMLI RAPORLAMA Sƒ∞STEMƒ∞ ---
        let currentReportType = 'daily';
        let reportChartInstance = null;
        
        function setReportType(type) {
            currentReportType = type;
            ['daily', 'weekly', 'monthly', 'history'].forEach(t => {
                const btn = document.getElementById('reportType' + t.charAt(0).toUpperCase() + t.slice(1));
                if(btn) {
                    if(t === type) {
                        btn.classList.add('bg-blue-600', 'text-white');
                        btn.classList.remove('text-gray-600', 'hover:bg-gray-100');
                    } else {
                        btn.classList.remove('bg-blue-600', 'text-white');
                        btn.classList.add('text-gray-600', 'hover:bg-gray-100');
                    }
                }
            });
            
            // PDF buton metnini g√ºncelle
            updatePdfButtonText();
            
            // History modunda farklƒ± g√∂r√ºn√ºm
            const historySection = document.getElementById('historySection');
            const datePicker = document.getElementById('reportDatePicker');
            const actionButtons = document.getElementById('reportActionButtons');
            
            if(type === 'history') {
                if(historySection) historySection.classList.remove('hidden');
                if(datePicker) datePicker.classList.add('hidden');
                if(actionButtons) actionButtons.classList.add('hidden');
                loadReportHistory();
            } else {
                if(historySection) historySection.classList.add('hidden');
                if(datePicker) datePicker.classList.remove('hidden');
                if(actionButtons) actionButtons.classList.remove('hidden');
                loadComprehensiveReport();
            }
        }
        
        async function loadComprehensiveReport() {
            showLoading();
            try {
                let url = '';
                const reportDate = document.getElementById('reportDate')?.value || new Date().toISOString().split('T')[0];
                
                if(currentReportType === 'daily') {
                    url = `/api/admin/reports/daily-comprehensive?report_date=${reportDate}`;
                } else if(currentReportType === 'weekly') {
                    url = `/api/admin/reports/weekly-comprehensive`;
                } else if(currentReportType === 'monthly') {
                    url = `/api/admin/reports/monthly-comprehensive`;
                }
                
                const res = await fetch(url, {headers: getHeaders()});
                if(!res.ok) throw new Error('Rapor y√ºklenemedi');
                const data = await res.json();
                
                renderComprehensiveReport(data);
            } catch(e) {
                console.error('Rapor hatasƒ±:', e);
                document.getElementById('aiAnalysis').innerText = 'Rapor y√ºklenirken hata olu≈ütu.';
            } finally {
                hideLoading();
            }
        }
        
        function renderComprehensiveReport(data) {
            // √ñzet kartlarƒ±
            document.getElementById('repTotalRevenue').innerText = (data.total_revenue || 0).toFixed(2) + ' ‚Ç∫';
            document.getElementById('repCashTotal').innerText = (data.cash_total || 0).toFixed(2) + ' ‚Ç∫';
            document.getElementById('repCardTotal').innerText = (data.card_total || 0).toFixed(2) + ' ‚Ç∫';
            document.getElementById('repTotalOrders').innerText = data.total_orders || 0;
            document.getElementById('repCancelledOrders').innerText = data.cancelled_orders || 0;
            document.getElementById('repAvgOrder').innerText = (data.avg_order || 0).toFixed(2) + ' ‚Ç∫';
            
            // Deƒüi≈üim
            const changeEl = document.getElementById('repChange');
            if(data.revenue_change !== undefined) {
                const change = data.revenue_change;
                const arrow = change >= 0 ? '‚Üë' : '‚Üì';
                changeEl.innerText = `${arrow} ${Math.abs(change).toFixed(1)}%`;
            } else {
                changeEl.innerText = '-';
            }
            
            // En √ßok satanlar
            const topList = document.getElementById('topProductsList');
            topList.innerHTML = (data.top_products || []).map((p, i) => `
                <div class="flex justify-between items-center p-2 rounded ${i < 3 ? 'bg-yellow-50' : 'bg-gray-50'}">
                    <span class="font-medium">${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : (i+1)+'.'} ${p.name}</span>
                    <span class="text-sm text-gray-600">${p.qty} adet</span>
                </div>
            `).join('') || '<div class="text-gray-400 text-sm">Veri yok</div>';
            
            // En az satanlar
            const lowList = document.getElementById('lowProductsList');
            lowList.innerHTML = (data.low_products || []).map(p => `
                <div class="flex justify-between items-center p-2 rounded bg-red-50">
                    <span class="font-medium text-red-700">${p.name}</span>
                    <span class="text-sm text-red-600">${p.qty} adet</span>
                </div>
            `).join('') || '<div class="text-gray-400 text-sm">Veri yok</div>';
            
            // Garson performansƒ±
            const waiterList = document.getElementById('waiterStatsList');
            waiterList.innerHTML = (data.waiter_stats || []).map((w, i) => `
                <div class="flex justify-between items-center p-2 rounded ${i === 0 ? 'bg-green-50' : 'bg-gray-50'}">
                    <span class="font-medium">${i === 0 ? '‚≠ê' : ''} ${w.name}</span>
                    <span class="text-sm font-bold text-blue-600">${w.total_orders} sipari≈ü</span>
                </div>
            `).join('') || '<div class="text-gray-400 text-sm">Veri yok</div>';
            
            // Kritik stok
            const stockList = document.getElementById('criticalStockList');
            stockList.innerHTML = (data.critical_stock || []).map(s => `
                <div class="flex justify-between items-center p-2 rounded bg-red-50 border border-red-200">
                    <span class="font-medium text-red-700">‚ö†Ô∏è ${s.name}</span>
                    <span class="text-sm font-bold text-red-600">${s.stock} adet</span>
                </div>
            `).join('') || '<div class="text-green-600 text-sm">‚úì Kritik stok yok</div>';
            
            // Masa ve √ºr√ºn sayƒ±sƒ±
            document.getElementById('repTotalTables').innerText = data.total_tables || 0;
            document.getElementById('repTotalProducts').innerText = data.total_products || 0;
            
            // AI Analizi
            document.getElementById('aiAnalysis').innerText = data.ai_analysis || 'AI analizi y√ºklenemedi.';
            
            // Grafik
            renderReportChart(data.daily_breakdown || {});
        }
        
        function renderReportChart(dailyData) {
            const ctx = document.getElementById('reportChart')?.getContext('2d');
            if(!ctx) return;
            
            // Veriyi sakla (grafik tipi deƒüi≈ütiƒüinde kullanmak i√ßin)
            currentChartData = dailyData;
            
            if(reportChartInstance) reportChartInstance.destroy();
            
            const labels = Object.keys(dailyData).sort();
            const revenues = labels.map(d => dailyData[d]?.revenue || 0);
            const orders = labels.map(d => dailyData[d]?.orders || 0);
            
            // ƒ∞statistikleri hesapla
            const maxRevenue = Math.max(...revenues);
            const minRevenue = Math.min(...revenues.filter(r => r > 0));
            const avgRevenue = revenues.reduce((a, b) => a + b, 0) / revenues.length;
            
            const maxIndex = revenues.indexOf(maxRevenue);
            const minIndex = revenues.indexOf(minRevenue);
            
            // En iyi/en k√∂t√º g√ºn bilgilerini g√ºncelle
            const maxDayEl = document.getElementById('chartMaxDay');
            const minDayEl = document.getElementById('chartMinDay');
            const avgDayEl = document.getElementById('chartAvgDay');
            
            if(maxDayEl && labels[maxIndex]) {
                maxDayEl.innerText = new Date(labels[maxIndex]).toLocaleDateString('tr-TR', {day:'numeric', month:'short'}) + ' - ' + maxRevenue.toFixed(0) + '‚Ç∫';
            }
            if(minDayEl && labels[minIndex] && minRevenue > 0) {
                minDayEl.innerText = new Date(labels[minIndex]).toLocaleDateString('tr-TR', {day:'numeric', month:'short'}) + ' - ' + minRevenue.toFixed(0) + '‚Ç∫';
            }
            if(avgDayEl) {
                avgDayEl.innerText = avgRevenue.toFixed(0) + ' ‚Ç∫';
            }
            
            // Grafik renkleri
            const gradientColors = revenues.map((r, i) => {
                if(i === maxIndex) return 'rgba(34, 197, 94, 0.8)'; // Ye≈üil - en iyi
                if(i === minIndex && r > 0) return 'rgba(239, 68, 68, 0.8)'; // Kƒ±rmƒ±zƒ± - en k√∂t√º
                return 'rgba(59, 130, 246, 0.7)'; // Mavi - normal
            });
            
            // Grafik konfig√ºrasyonu
            let chartConfig = {};
            
            if(currentChartType === 'doughnut') {
                // Pasta grafik i√ßin farklƒ± yapƒ±
                const colorPalette = [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(34, 197, 94, 0.8)',
                    'rgba(249, 115, 22, 0.8)',
                    'rgba(139, 92, 246, 0.8)',
                    'rgba(236, 72, 153, 0.8)',
                    'rgba(20, 184, 166, 0.8)',
                    'rgba(245, 158, 11, 0.8)'
                ];
                
                chartConfig = {
                    type: 'doughnut',
                    data: {
                        labels: labels.map(d => new Date(d).toLocaleDateString('tr-TR', {day:'numeric', month:'short'})),
                        datasets: [{
                            data: revenues,
                            backgroundColor: labels.map((_, i) => colorPalette[i % colorPalette.length]),
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'right',
                                labels: { font: { size: 10 }, boxWidth: 12 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': ' + context.raw.toFixed(2) + ' ‚Ç∫';
                                    }
                                }
                            }
                        }
                    }
                };
            } else {
                // Bar veya Line grafik
                chartConfig = {
                    type: currentChartType,
                    data: {
                        labels: labels.map(d => new Date(d).toLocaleDateString('tr-TR', {day:'numeric', month:'short'})),
                        datasets: [{
                            label: 'Ciro (‚Ç∫)',
                            data: revenues,
                            backgroundColor: currentChartType === 'bar' ? gradientColors : 'rgba(59, 130, 246, 0.2)',
                            borderColor: currentChartType === 'line' ? 'rgba(59, 130, 246, 1)' : gradientColors,
                            borderWidth: currentChartType === 'line' ? 3 : 0,
                            borderRadius: currentChartType === 'bar' ? 6 : 0,
                            tension: 0.4,
                            fill: currentChartType === 'line',
                            pointBackgroundColor: currentChartType === 'line' ? gradientColors : undefined,
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: currentChartType === 'line' ? 5 : 0,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                titleFont: { size: 13, weight: 'bold' },
                                bodyFont: { size: 12 },
                                padding: 12,
                                cornerRadius: 8,
                                displayColors: false,
                                callbacks: {
                                    label: function(context) {
                                        const idx = context.dataIndex;
                                        const orderCount = orders[idx] || 0;
                                        return [
                                            'Ciro: ' + context.raw.toFixed(2) + ' ‚Ç∫',
                                            'Sipari≈ü: ' + orderCount + ' adet'
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(0,0,0,0.05)' },
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString('tr-TR') + ' ‚Ç∫';
                                    }
                                }
                            },
                            x: {
                                grid: { display: false }
                            }
                        }
                    }
                };
            }
            
            reportChartInstance = new Chart(ctx, chartConfig);
        }
        
        async function loadReportHistory() {
            showLoading();
            try {
                const res = await fetch('/api/admin/reports/history-list', {headers: getHeaders()});
                const data = await res.json();
                
                const historyList = document.getElementById('historyList');
                historyList.innerHTML = (data.history || []).map(h => `
                    <div class="flex justify-between items-center p-3 rounded-lg border hover:bg-gray-50 cursor-pointer" onclick="loadHistoryDay('${h.date}')">
                        <div>
                            <span class="font-bold">${h.day_name}</span>
                            <span class="text-gray-500 ml-2">${h.date}</span>
                        </div>
                        <div class="text-right">
                            <span class="font-bold text-green-600">${h.revenue.toFixed(2)} ‚Ç∫</span>
                            <span class="text-gray-500 ml-2">${h.orders} sipari≈ü</span>
                        </div>
                    </div>
                `).join('') || '<div class="text-gray-400">Ge√ßmi≈ü veri yok</div>';
            } catch(e) {
                console.error(e);
            } finally {
                hideLoading();
            }
        }
        
        function loadHistoryDay(dateStr) {
            document.getElementById('reportDate').value = dateStr;
            setReportType('daily');
        }
        
        // Eski loadReports fonksiyonunu yeni sisteme y√∂nlendir
        async function loadReports() {
            loadComprehensiveReport();
        }
        
        // --- GRAFƒ∞K Tƒ∞Pƒ∞ DEƒûƒ∞≈ûTƒ∞RME ---
        let currentChartType = 'bar';
        let currentChartData = null;
        
        function setChartType(type) {
            currentChartType = type;
            ['bar', 'line', 'doughnut'].forEach(t => {
                const btn = document.getElementById('chartType' + t.charAt(0).toUpperCase() + t.slice(1));
                if(btn) {
                    if(t === type) {
                        btn.classList.add('bg-blue-600', 'text-white');
                        btn.classList.remove('bg-transparent', 'text-gray-600', 'hover:bg-gray-200');
                    } else {
                        btn.classList.remove('bg-blue-600', 'text-white');
                        btn.classList.add('bg-transparent', 'text-gray-600', 'hover:bg-gray-200');
                    }
                }
            });
            if(currentChartData) {
                renderReportChart(currentChartData);
            }
        }
        
        // --- PDF ƒ∞NDƒ∞RME FONKSƒ∞YONU ---
        async function downloadReportPdf() {
            const statusEl = document.getElementById('pdfDownloadStatus');
            if(statusEl) {
                statusEl.classList.remove('hidden');
            }
            
            try {
                let url = '';
                const reportDate = document.getElementById('reportDate')?.value || new Date().toISOString().split('T')[0];
                
                if(currentReportType === 'daily') {
                    // G√ºnl√ºk rapor i√ßin kapanƒ±≈ü PDF - tarih parametresi ekle
                    url = `/api/admin/reports/closing-report-pdf?report_date=${reportDate}`;
                } else {
                    // Haftalƒ±k/Aylƒ±k i√ßin detaylƒ± rapor
                    const today = new Date();
                    let startDate, endDate;
                    
                    if(currentReportType === 'weekly') {
                        const dayOfWeek = today.getDay();
                        const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                        startDate = new Date(today.setDate(diff)).toISOString().split('T')[0];
                        endDate = new Date(new Date(startDate).setDate(new Date(startDate).getDate() + 6)).toISOString().split('T')[0];
                    } else {
                        // Aylƒ±k
                        startDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                        endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
                    }
                    
                    url = `/api/admin/reports/full-pdf?start_date=${startDate}&end_date=${endDate}&include_ai=true`;
                }
                
                const res = await fetch(url, {headers: getHeaders()});
                
                if(res.ok) {
                    const blob = await res.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    
                    // Dosya adƒ±nƒ± belirle
                    let filename = 'rapor.pdf';
                    if(currentReportType === 'daily') {
                        filename = `kapanis_raporu_${reportDate}.pdf`;
                    } else if(currentReportType === 'weekly') {
                        filename = `haftalik_rapor_${new Date().toISOString().split('T')[0]}.pdf`;
                    } else {
                        filename = `aylik_rapor_${new Date().toISOString().split('T')[0]}.pdf`;
                    }
                    
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(downloadUrl);
                    
                    showToast('PDF ba≈üarƒ±yla indirildi!', 'green');
                } else {
                    throw new Error('PDF olu≈üturulamadƒ±');
                }
            } catch(e) {
                console.error('PDF indirme hatasƒ±:', e);
                showToast('PDF indirilemedi. L√ºtfen tekrar deneyin.', 'red');
            } finally {
                if(statusEl) {
                    statusEl.classList.add('hidden');
                }
            }
        }
        
        // --- PDF BUTON METNƒ∞Nƒ∞ G√úNCELLE ---
        function updatePdfButtonText() {
            const btnText = document.getElementById('pdfBtnText');
            if(btnText) {
                if(currentReportType === 'daily') {
                    btnText.innerText = 'Kapanƒ±≈ü PDF ƒ∞ndir';
                } else {
                    btnText.innerText = 'Detaylƒ± Rapor ƒ∞ndir';
                }
            }
        }
    </script>
</body>
</html>
 
