<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Paneli | Restoran</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .nav-item.active { background-color: #1e293b; border-left: 4px solid #3b82f6; }
        #loadingBar { position: fixed; top: 0; left: 0; height: 4px; background: #3b82f6; z-index: 9999; transition: width 0.3s; width: 0%; }
        
        /* Toast Bildirim */
        .toast-notification { animation: slideInRight 0.5s ease-out forwards; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 flex h-screen overflow-hidden font-sans">
    
    <div id="loadingBar"></div>

    <audio id="bellSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <div class="w-64 bg-slate-900 text-white flex-shrink-0 flex flex-col shadow-xl z-20 transition-all duration-300">
        <div class="p-6 text-center border-b border-slate-800 flex flex-col items-center justify-center gap-3">
            <img id="adminPanelLogo" src="/static/uploads/restaurant_logo.png" class="h-16 w-auto object-contain bg-white/10 p-2 rounded-lg mb-2 hidden" onerror="this.style.display='none'">
            <div class="text-xl font-bold flex items-center gap-2">
                <i class="fas fa-utensils text-blue-500"></i> <span>YÃ¶netim</span>
            </div>
        </div>
        
        <nav class="flex-1 overflow-y-auto py-6 space-y-1">
            <button onclick="showSection('dashboard')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3 active"><i class="fas fa-chart-pie w-5 text-center"></i> Dashboard</button>
            <button onclick="showSection('orders')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3"><i class="fas fa-receipt w-5 text-center"></i> SipariÅŸler</button>
            <button onclick="showSection('products')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3"><i class="fas fa-hamburger w-5 text-center"></i> ÃœrÃ¼nler</button>
            <button onclick="showSection('categories')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3"><i class="fas fa-tags w-5 text-center"></i> Kategoriler</button>
            <button onclick="showSection('tables')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3"><i class="fas fa-chair w-5 text-center"></i> Masalar</button>
            <button onclick="showSection('reports')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3"><i class="fas fa-chart-line w-5 text-center"></i> Raporlar</button>
            <button onclick="showSection('settings')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3"><i class="fas fa-cog w-5 text-center"></i> Ayarlar</button>
            <button onclick="showSection('league')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3"><i class="fas fa-trophy w-5 text-center"></i> Garson Ligi</button>
            <button onclick="showSection('stock')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center gap-3"><i class="fas fa-boxes-stacked w-5 text-center"></i> Stok YÃ¶netimi</button>
        </nav>
        
        <div class="p-4 border-t border-slate-800">
            <button onclick="logout()" class="w-full bg-red-600/90 hover:bg-red-600 py-3 rounded-lg text-sm font-bold transition flex items-center justify-center gap-2 shadow-lg"><i class="fas fa-sign-out-alt"></i> Ã‡IKIÅž YAP</button>
        </div>
    </div>

    <div class="flex-1 flex flex-col overflow-hidden relative bg-gray-50">
        <header class="bg-white shadow-sm p-5 flex justify-between items-center z-10 sticky top-0">
            <div>
                <h2 id="pageTitle" class="text-2xl font-bold text-gray-800">Dashboard</h2>
                <p class="text-sm text-gray-500 mt-1">Sistem durumu ve yÃ¶netim paneli.</p>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right hidden sm:block">
                    <div class="text-sm font-bold text-gray-800">YÃ¶netici</div>
                    <div class="text-xs text-green-500 flex items-center justify-end gap-1">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Ã‡evrimiÃ§i
                    </div>
                </div>
                <div class="w-10 h-10 bg-slate-200 rounded-full flex items-center justify-center text-slate-600">
                    <i class="fas fa-user"></i>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-6 scroll-smooth">
            
            <div id="dashboardSection" class="section">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border-b-4 border-green-500"><p class="text-gray-500 text-xs font-bold uppercase">GÃ¼nlÃ¼k Ciro</p><p class="text-3xl font-bold text-slate-800 mt-1" id="statRevenue">0.00 â‚º</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-b-4 border-blue-500"><p class="text-gray-500 text-xs font-bold uppercase">BugÃ¼nkÃ¼ SipariÅŸ</p><p class="text-3xl font-bold text-slate-800 mt-1" id="statTodayOrders">0</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-b-4 border-orange-500"><p class="text-gray-500 text-xs font-bold uppercase">Aktif SipariÅŸ</p><p class="text-3xl font-bold text-slate-800 mt-1" id="statActiveOrders">0</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-b-4 border-purple-500"><p class="text-gray-500 text-xs font-bold uppercase">MenÃ¼ ÃœrÃ¼nleri</p><p class="text-3xl font-bold text-slate-800 mt-1" id="statProducts">-</p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-gray-800 mb-3">DÃ¼ÅŸÃ¼k Stok Bildirimleri</h3>
                        <div id="lowStockList" class="space-y-2"></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-gray-800 mb-3">AÃ§Ä±k Masalar</h3>
                        <div id="tableStats" class="grid grid-cols-3 gap-3 mb-3"></div>
                        <div id="openTablesGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-6">HaftalÄ±k SatÄ±ÅŸ GrafiÄŸi</h3>
                    <div class="w-full h-80"><canvas id="salesChart"></canvas></div>
                </div>
            </div>

            <div id="productsSection" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-gray-800">ÃœrÃ¼n Listesi</h3>
                    <button onclick="openProductModal()" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700 transition shadow-lg flex items-center gap-2"><i class="fas fa-plus"></i> Yeni ÃœrÃ¼n</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
                    <div class="flex justify-between items-center mb-4">
                        <input type="text" id="stockSearch" placeholder="ÃœrÃ¼n ara..." class="border p-2 rounded-lg" onkeyup="filterStockTable()">
                        <button onclick="openProductModal(); document.getElementById('track_stock').checked = true;" class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700">Yeni ÃœrÃ¼n</button>
                    </div>
                    <table class="min-w-full divide-y divide-gray-100">
                        <thead class="bg-gray-50"><tr><th class="p-4 text-left">Resim</th><th class="p-4 text-left">ÃœrÃ¼n AdÄ±</th><th class="p-4 text-left">Kategori</th><th class="p-4 text-left">Fiyat</th><th class="p-4 text-center">Ä°ÅŸlem</th></tr></thead>
                        <tbody id="productsTable" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="categoriesSection" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-gray-800">Kategoriler</h3>
                    <button onclick="addCategory()" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700 transition shadow-lg">Yeni Kategori</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
                    <table class="min-w-full divide-y divide-gray-100">
                        <thead class="bg-gray-50"><tr><th class="p-4 text-left">Ä°kon</th><th class="p-4 text-left">Kategori AdÄ±</th><th class="p-4 text-center">Ä°ÅŸlem</th></tr></thead>
                        <tbody id="categoriesTable" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="tablesSection" class="section hidden">
                <div class="mb-6">
                    <h3 class="text-lg font-bold text-gray-800">AÃ§Ä±k Masalar</h3>
                    <div id="openTablesGridTables" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-3"></div>
                </div>
                <div class="border-t my-6"></div>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800">Masa YÃ¶netimi</h3>
                    <div class="flex items-center gap-3">
                        <input type="text" id="quickTableName" class="border p-2 rounded-lg" placeholder="Masa adÄ±">
                        <input type="number" id="quickTableNumber" class="border p-2 rounded-lg w-24" placeholder="No">
                        <button onclick="addTableQuick()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Ekle</button>
                        <input type="number" id="reactivateTableNumber" class="border p-2 rounded-lg w-28" placeholder="No AktifleÅŸtir">
                        <button onclick="reactivateTableByNumber()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">AktifleÅŸtir</button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
                    <table class="min-w-full divide-y divide-gray-100">
                        <thead class="bg-gray-50"><tr><th class="p-4 text-left">Masa AdÄ±</th><th class="p-4 text-left">No</th><th class="p-4 text-center">Ä°ÅŸlemler</th></tr></thead>
                        <tbody id="tablesTable" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="ordersSection" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-gray-800">TÃ¼m SipariÅŸler</h3>
                    <button onclick="loadOrders()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition">Yenile</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
                    <table class="min-w-full divide-y divide-gray-100">
                        <thead class="bg-gray-50"><tr><th class="p-4 text-left">ID</th><th class="p-4 text-left">Masa</th><th class="p-4 text-left">Tutar</th><th class="p-4 text-left">Durum</th><th class="p-4 text-left">Tarih</th><th class="p-4 text-center">Ä°ÅŸlem</th></tr></thead>
                        <tbody id="ordersTable" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="reportsSection" class="section hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm mb-6 border border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-4">Tarih AralÄ±ÄŸÄ± SeÃ§</h3>
                    <div class="flex gap-4 items-end flex-wrap">
                        <div>
                            <label class="text-sm text-gray-500 block mb-1">BaÅŸlangÄ±Ã§</label>
                            <input type="date" id="reportStart" class="block border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="text-sm text-gray-500 block mb-1">BitiÅŸ</label>
                            <input type="date" id="reportEnd" class="block border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <button onclick="loadReports()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition shadow-md">Raporla</button>
                    </div>
                </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
                        <p class="text-gray-500 text-sm font-medium">Toplam Ciro</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1" id="repTotalRevenue">0.00 â‚º</h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500">
                        <p class="text-gray-500 text-sm font-medium">Toplam SipariÅŸ</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1" id="repTotalOrders">0</h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-purple-500">
                        <p class="text-gray-500 text-sm font-medium">Ortalama Sepet</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1" id="repAvgOrder">0.00 â‚º</h3>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h4 class="font-bold text-gray-700 mb-4 flex items-center gap-2"><i class="fas fa-crown text-yellow-500"></i> En Ã‡ok Satan ÃœrÃ¼nler</h4>
                        <div class="overflow-auto max-h-60">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50 text-gray-500"><tr><th class="p-2">ÃœrÃ¼n</th><th class="p-2">Adet</th><th class="p-2 text-right">Tutar</th></tr></thead>
                                <tbody id="topProductsTable" class="divide-y"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h4 class="font-bold text-gray-700 mb-4">GÃ¼nlÃ¼k SatÄ±ÅŸ GrafiÄŸi</h4>
                        <div class="h-60"><canvas id="reportChart"></canvas></div>
                        <div class="mt-6 flex gap-3">
                            <button onclick="loadProductMatrix()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">ÃœrÃ¼n Matrisi</button>
                            <button onclick="downloadClosingPdf()" class="px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-900">KapanÄ±ÅŸ PDF</button>
                        </div>
                        <div id="aiAnalysis" class="mt-4 text-sm text-gray-600"></div>
                    </div>
                </div>
            </div>

            <div id="settingsSection" class="section hidden">
                <div class="max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="text-xl font-bold text-gray-800 mb-6 border-b pb-4">Sistem AyarlarÄ±</h3>
                    
                    <div class="mb-8 bg-blue-50/50 p-6 rounded-xl border border-blue-100">
                        <label class="block text-sm font-bold text-gray-700 mb-3">Ä°ÅŸletme Logosu</label>
                        <div class="flex items-center gap-6">
                            <div class="w-28 h-28 border-2 border-dashed border-gray-300 rounded-xl flex items-center justify-center bg-white overflow-hidden relative group shadow-sm">
                                <img id="currentLogo" src="/static/logo.png" class="w-full h-full object-contain p-2" onerror="this.style.display='none'">
                                <div id="logoPlaceholder" class="absolute inset-0 flex items-center justify-center text-gray-400">
                                    <i class="fas fa-image text-3xl"></i>
                                </div>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm text-gray-500 mb-3">MenÃ¼ ve fiÅŸlerde gÃ¶rÃ¼necek logo.</p>
                                <div class="flex gap-3 items-center">
                                    <label class="cursor-pointer bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition text-sm font-semibold shadow-sm">
                                        <i class="fas fa-upload mr-2 text-blue-500"></i> Resim SeÃ§
                                        <input type="file" id="logoInput" accept="image/*" class="hidden" onchange="handleLogoSelect(this)">
                                    </label>
                                    <button onclick="uploadLogo()" id="uploadBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition text-sm font-semibold shadow-md hidden flex items-center gap-2">
                                        <i class="fas fa-save"></i> YÃ¼kle
                                    </button>
                                </div>
                                <p id="fileNameDisplay" class="text-xs text-gray-500 mt-2 font-mono"></p>
                            </div>
                        </div>
                    </div>

                    <form onsubmit="saveSettings(event)" class="space-y-5">
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">Restoran AdÄ±</label><input type="text" id="setRestName" class="w-full border p-3 rounded-lg" required></div>
                        <div class="grid grid-cols-2 gap-5">
                            <div><label class="block text-sm font-medium text-gray-700 mb-1">Para Birimi</label><input type="text" id="setCurrency" class="w-full border p-3 rounded-lg" required></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-1">Vergi OranÄ± (%)</label><input type="number" step="0.1" id="setTax" class="w-full border p-3 rounded-lg" required></div>
                        </div>
                        <div class="grid grid-cols-2 gap-5">
                            <div><label class="block text-sm font-medium text-gray-700 mb-1">Servis Ãœcreti (%)</label><input type="number" step="0.1" id="setService" class="w-full border p-3 rounded-lg"></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-1">Masa Zaman AÅŸÄ±mÄ± (Dk)</label><input type="number" id="setTimeout" class="w-full border p-3 rounded-lg"></div>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">Wi-Fi Åžifresi</label><input type="text" id="setWifi" class="w-full border p-3 rounded-lg"></div>
                        <div class="pt-6"><button type="submit" class="w-full bg-slate-800 text-white py-3.5 rounded-lg font-bold hover:bg-slate-900 transition shadow-lg active:scale-95 transform">AyarlarÄ± GÃ¼ncelle</button></div>
                    </form>
                </div>
            </div>

            <div id="leagueSection" class="section hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm mb-6 border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800">Garson Ligi</h3>
                    <p class="text-sm text-gray-500 mb-4">Tamamlanan sipariÅŸlerden toplanan puanlar ve bahÅŸiÅŸler.</p>
                    <div class="overflow-auto">
                        <table class="min-w-full text-sm">
                            <thead class="bg-gray-50"><tr><th class="p-3 text-left">KullanÄ±cÄ±</th><th class="p-3 text-right">SatÄ±ÅŸ PuanÄ±</th><th class="p-3 text-right">BahÅŸiÅŸ</th></tr></thead>
                            <tbody id="leagueTable" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="stockSection" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-gray-800">Stok YÃ¶netimi</h3>
                    <button onclick="loadStock()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition">Yenile</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
                    <div class="p-4 flex flex-wrap items-center gap-3 border-b">
                        <input type="text" id="quickNewName" class="border p-2 rounded-lg flex-1 min-w-[200px]" placeholder="Yeni Ã¼rÃ¼n adÄ±" onkeyup="if(event.key==='Enter'){quickCreateProduct();}">
                        <select id="quickNewCategory" class="border p-2 rounded-lg"></select>
                        <input type="number" id="quickNewPrice" class="border p-2 rounded-lg w-28" placeholder="Fiyat">
                        <input type="number" id="quickNewStock" class="border p-2 rounded-lg w-24" placeholder="Stok">
                        <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="quickNewTrack" checked> Takip</label>
                        <button onclick="quickCreateProduct()" class="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700">Ekle</button>
                    </div>
                    <div class="p-4 flex flex-wrap items-center gap-3 border-b">
                        <select id="quickProductSelect" class="border p-2 rounded-lg min-w-[200px]"></select>
                        <input type="number" id="quickAmount" class="border p-2 rounded-lg w-24" placeholder="+/-">
                        <button onclick="quickAddStock()" class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700">HÄ±zlÄ± Ekle</button>
                    </div>
                    <div id="stockCards" class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4"></div>
                    <table class="min-w-full divide-y divide-gray-100">
                        <thead class="bg-gray-50"><tr><th class="p-4 text-left">ÃœrÃ¼n</th><th class="p-4 text-right">Mevcut Stok</th><th class="p-4 text-right">Yeni Stok</th><th class="p-4 text-center">Ä°ÅŸlem</th></tr></thead>
                        <tbody id="stockTable" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <div id="productModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl w-96 p-8 shadow-2xl">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Yeni ÃœrÃ¼n</h3>
            <form id="productForm" onsubmit="saveProduct(event)" class="space-y-4">
                <input type="text" name="name" placeholder="ÃœrÃ¼n AdÄ±" class="w-full border p-3 rounded-xl" required>
                <textarea name="description" placeholder="AÃ§Ä±klama" class="w-full border p-3 rounded-xl h-24"></textarea>
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" name="price" placeholder="Fiyat (TL)" step="0.01" class="w-full border p-3 rounded-xl" required>
                    <select name="category_id" id="categorySelect" class="w-full border p-3 rounded-xl" required></select>
                </div>
                <input type="file" id="productImage" accept="image/*" class="block w-full text-sm border p-2 rounded-lg">
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeProductModal()" class="px-5 py-2.5 rounded-xl bg-gray-200 hover:bg-gray-300">Ä°ptal</button>
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2.5 rounded-xl hover:bg-blue-700 font-bold">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- GLOBAL AYARLAR ---
        const placeholderSvg = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgcnk9IjEwIiBmaWxsPSIjZGVlMzE3Ii8+PHBhdGggZD0iTTUwLDEwTDIwLDIwVjgwTDUwLDkwTDgwLDgwVjIwTDUwLDEwWiIgZmlsbD0iI2YxZjVmOSIgc3Ryb2tlPSIjNjQ3NDhiIiBzdHJva2Utd2lkdGg9IjIiLz48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSIxMCIgZmlsbD0iIzY0NzQ4YiIvPjwvc3ZnPg==';
        let authToken = localStorage.getItem('authToken');
        if(!authToken) window.location.href = '/login.html';
        const getHeaders = () => ({ 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' });
        let chartInstance = null;
        let categories = [];

        // --- YÃœKLEME BAR ---
        function showLoading() { document.getElementById('loadingBar').style.width = '100%'; }
        function hideLoading() { setTimeout(() => { document.getElementById('loadingBar').style.width = '0%'; }, 300); }

        // --- SAYFA GEÃ‡Ä°ÅžLERÄ° ---
        function showSection(id) {
            document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
            const section = document.getElementById(id + 'Section');
            if(section) section.classList.remove('hidden');
            
            const title = document.getElementById('pageTitle');
            if(title) title.innerText = id.charAt(0).toUpperCase() + id.slice(1);

            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active', 'bg-slate-800'));
            const activeBtn = document.querySelector(`button[onclick="showSection('${id}')"]`);
            if(activeBtn) activeBtn.classList.add('active', 'bg-slate-800');

            // Sayfa yÃ¼kleme mantÄ±ÄŸÄ±
            if(id === 'dashboard') loadDashboard();
            else if(id === 'reports') loadReports(); 
            else if(id === 'products') { loadCategories(false); loadProducts(); }
            else if(id === 'categories') loadCategories();
            else if(id === 'tables') loadTables();
            else if(id === 'orders') loadOrders();
            else if(id === 'league') loadLeague();
            else if(id === 'stock') loadStock();
            else if(id === 'settings') loadSettings();
        }

        function logout() { localStorage.removeItem('authToken'); window.location.href = '/login.html'; }

        // --- RAPORLAMA FONKSÄ°YONU (DÃœZELTÄ°LDÄ°) ---
        async function loadReports() {
            showLoading();
            const s = document.getElementById('reportStart').value;
            const e = document.getElementById('reportEnd').value;
            
            let url = '/api/admin/reports/sales';
            if(s && e) url += `?start_date=${s}&end_date=${e}`;

            try {
                console.log("Rapor isteniyor:", url);
                const res = await fetch(url, {headers: getHeaders()});
                
                if(!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                
                const data = await res.json();
                console.log("Rapor Geldi:", data);

                // Verileri Doldur
                document.getElementById('repTotalRevenue').innerText = (data.total_revenue || 0).toFixed(2) + ' â‚º';
                document.getElementById('repTotalOrders').innerText = data.total_orders || 0;
                document.getElementById('repAvgOrder').innerText = (data.average_order || 0).toFixed(2) + ' â‚º';

                // Tabloyu Doldur
                const tbody = document.getElementById('topProductsTable');
                if(data.top_products && data.top_products.length > 0) {
                    tbody.innerHTML = data.top_products.map(p => `
                        <tr class="hover:bg-gray-50 border-b last:border-0">
                            <td class="p-3 font-medium text-gray-700">${p.name}</td>
                            <td class="p-3 font-bold text-center">${p.qty}</td>
                            <td class="p-3 text-right font-mono text-slate-600">${p.total.toFixed(2)} â‚º</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-400">Veri yok</td></tr>';
                }

                // GrafiÄŸi Ã‡iz
                if(window.Chart) {
                    const ctx = document.getElementById('reportChart').getContext('2d');
                    if(chartInstance) chartInstance.destroy();
                    
                    // EÄŸer breakdown verisi boÅŸsa boÅŸ grafik Ã§izmemek iÃ§in kontrol
                    const labels = (data.daily_breakdown || []).map(x => new Date(x.date).toLocaleDateString('tr-TR'));
                    const values = (data.daily_breakdown || []).map(x => x.revenue);

                    chartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Ciro (â‚º)',
                                data: values,
                                backgroundColor: '#3b82f6',
                                borderRadius: 4
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                }

            } catch(e) {
                console.error("Rapor hatasÄ±:", e);
                alert("Rapor yÃ¼klenirken hata oluÅŸtu. Konsolu kontrol edin.");
            } finally {
                hideLoading();
            }
        }

        async function loadProductMatrix(){
            showLoading();
            try{
                const res = await fetch('/api/admin/reports/product-matrix', {headers: getHeaders()});
                const data = await res.json();
                const ai = document.getElementById('aiAnalysis');
                ai.innerText = (data.analysis || '').toString();
            }catch(e){ alert('ÃœrÃ¼n matrisi getirilemedi'); }
            finally{ hideLoading(); }
        }

        async function downloadClosingPdf(){
            try{
                const res = await fetch('/api/admin/reports/closing-report-pdf', {headers: getHeaders()});
                if(res.ok){
                    const url = '/static/uploads/closing_report.pdf?t=' + new Date().getTime();
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'closing_report.pdf';
                    a.click();
                } else {
                    alert('PDF oluÅŸturulamadÄ±');
                }
            }catch(e){ alert('PDF isteÄŸi baÅŸarÄ±sÄ±z'); }
        }

        async function loadLeague(){
            showLoading();
            try{
                const usersRes = await fetch('/api/auth/users', {headers: getHeaders()});
                const users = await usersRes.json();
                const tbody = document.getElementById('leagueTable');
                const rows = (users || []).map(u => {
                    return `<tr><td class="p-3 font-medium text-gray-800">${u.username}</td><td class="p-3 text-right font-mono">-</td><td class="p-3 text-right font-mono">-</td></tr>`;
                }).join('');
                tbody.innerHTML = rows;
            }catch(e){}finally{hideLoading();}
        }

        async function loadStock(){
            showLoading();
            try{
                const res = await fetch('/api/products', {headers: getHeaders()});
                const data = await res.json();
                const tbody = document.getElementById('stockTable');
                tbody.innerHTML = (data||[]).map(p => `
                    <tr class="border-b hover:bg-gray-50 transition">
                        <td class="p-4 font-medium text-gray-800">${p.name}</td>
                        <td class="p-4 text-right font-mono">${p.track_stock ? p.stock : 'âˆž'}</td>
                        <td class="p-4 text-right">${p.track_stock ? `<input type=\"number\" min=\"0\" class=\"w-24 border p-2 rounded-lg text-right\" id=\"stock-${p.id}\" value=\"${p.stock}\">` : '<span class=\"text-xs text-gray-400\">Takip KapalÄ±</span>'}</td>
                        <td class="p-4 text-center"><button onclick="${p.track_stock ? `saveStock(${p.id})` : `toggleTrack(${p.id}, true)`}" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">${p.track_stock ? 'GÃ¼ncelle' : 'Takibi AÃ§'}</button></td>
                    </tr>
                `).join('');
            }catch(e){}finally{hideLoading();}
        }

        async function saveStock(productId){
            showLoading();
            try{
                const input = document.getElementById('stock-' + productId);
                const qty = parseInt(input.value||'0');
                const res = await fetch('/api/products/' + productId, {method:'PUT', headers: getHeaders(), body: JSON.stringify({stock: qty})});
                if(res.ok){ loadStock(); }
                else{ alert('GÃ¼ncelleme baÅŸarÄ±sÄ±z'); }
            }catch(e){ alert('Ä°stek hatasÄ±'); }finally{ hideLoading(); }
        }

        async function toggleTrack(id, status){
            showLoading();
            try{
                await fetch('/api/products/' + id, {method:'PUT', headers: getHeaders(), body: JSON.stringify({track_stock: status, stock: status ? 0 : 0})});
                loadStock();
            }catch(e){}finally{hideLoading();}
        }

        // --- DASHBOARD ---
        async function loadDashboard() {
            showLoading();
            try {
                const res = await fetch('/api/admin/dashboard', {headers: getHeaders()});
                if(res.status === 401) { logout(); return; }
                const data = await res.json();
                
                document.getElementById('statProducts').innerText = data.overview.total_products || '0';
                document.getElementById('statRevenue').innerText = (data.sales.today_revenue || 0).toFixed(2) + ' â‚º';
                document.getElementById('statTodayOrders').innerText = data.sales.today_orders || '0';
                document.getElementById('statActiveOrders').innerText = data.sales.active_orders || '0';
                
                if(window.Chart) {
                    const ctx = document.getElementById('salesChart').getContext('2d');
                    if(chartInstance) chartInstance.destroy();
                    chartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: (data.sales.daily_trend || []).map(d => new Date(d.date).toLocaleDateString('tr-TR', {day:'numeric', month:'short'})),
                            datasets: [{
                                label: 'GÃ¼nlÃ¼k Ciro',
                                data: (data.sales.daily_trend || []).map(d => d.revenue),
                                borderColor: '#10b981',
                                tension: 0.3,
                                fill: true,
                                backgroundColor: 'rgba(16, 185, 129, 0.1)'
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                }
                try{
                    const pr = await fetch('/api/products', {headers:getHeaders()});
                    const pd = await pr.json();
                    const low = (pd||[]).filter(p => p.track_stock && (p.stock||0) <= 15);
                    const ls = document.getElementById('lowStockList');
                    if(ls) ls.innerHTML = low.length ? low.map(p=>`<div class="flex items-center gap-2 text-sm"><span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span><span class="font-bold">${p.name}</span><span class="font-mono">(${p.stock})</span></div>`).join('') : '<div class="text-gray-400 text-sm">UyarÄ± yok</div>';
                }catch(x){}
                try{
                    const tr = await fetch('/api/tables/open', {headers:getHeaders()});
                    const td = await tr.json();
                const grid = document.getElementById('openTablesGrid');
                    if(grid) {
                        const items = (td||[]).map(t=>`<div class="border rounded-xl p-4 ${t.total_amount>0?'border-green-300 bg-green-50':'border-gray-200 bg-white'}"><div class="flex justify-between items-center"><div class="font-bold">Masa ${t.table_number}</div><div class="font-mono">${(t.total_amount||0).toFixed(2)} â‚º</div></div><div class="mt-2 text-xs text-gray-600">${t.items.length} kalem</div><div class="mt-3 flex justify-end gap-2"><button onclick="openTableDetails(${t.table_id})" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Detay</button><button onclick="printBill(${t.table_id})" class="px-3 py-1 bg-gray-700 text-white rounded hover:bg-gray-800 text-sm">YazdÄ±r</button><button onclick="closeTable(${t.table_id})" class="px-3 py-1 bg-slate-800 text-white rounded hover:bg-slate-900 text-sm">Hesap AlÄ±ndÄ±</button></div></div>`).join('');
                        grid.innerHTML = items || '<div class="text-gray-400 text-sm">HiÃ§ aÃ§Ä±k masa yok</div>';
                    }
                try{
                    const sr = await fetch('/api/tables/stats/summary', {headers:getHeaders()});
                    const sd = await sr.json();
                    const stats = document.getElementById('tableStats');
                    if(stats) stats.innerHTML = `
                        <div class="bg-gray-50 rounded-lg p-3 text-center"><div class="text-xs text-gray-500">Toplam Aktif Masa</div><div class="text-xl font-bold">${sd.total_tables||0}</div></div>
                        <div class="bg-gray-50 rounded-lg p-3 text-center"><div class="text-xs text-gray-500">Aktif (Son 2 saat)</div><div class="text-xl font-bold">${sd.active_tables||0}</div></div>
                        <div class="bg-gray-50 rounded-lg p-3 text-center"><div class="text-xs text-gray-500">MÃ¼sait</div><div class="text-xl font-bold">${sd.available_tables||0}</div></div>
                    `;
                }catch(x){}
                }catch(x){}
            } catch(e){} finally { hideLoading(); }
        }
        async function closeTable(id){ showLoading(); try{ await fetch(`/api/tables/close/${id}`, {method:'POST', headers:getHeaders()}); loadDashboard(); }catch(x){} finally{ hideLoading(); } }

        // --- DÄ°ÄžER FONKSÄ°YONLAR ---
        async function loadProducts() {
            showLoading();
            try {
                const res = await fetch('/api/products'); 
                const rawData = await res.json();
                const products = Array.isArray(rawData) ? rawData : (rawData.products || []);
                
                document.getElementById('productsTable').innerHTML = products.map(p => {
                    const imgUrl = (p.image_url && p.image_url.length > 5) ? p.image_url : placeholderSvg;
                    const catName = p.category ? p.category.name : (categories.find(c => c.id == p.category_id)?.name || '-');
                    return `
                    <tr class="border-b hover:bg-gray-50 transition">
                        <td class="p-4"><div class="w-12 h-12 rounded-lg overflow-hidden bg-gray-100 border"><img src="${imgUrl}" class="w-full h-full object-cover" onerror="this.src='${placeholderSvg}'"></div></td>
                        <td class="p-4 font-medium text-gray-800">${p.name}</td>
                        <td class="p-4 text-sm text-gray-500">${catName}</td>
                        <td class="p-4 font-bold text-green-600 font-mono">${p.price.toFixed(2)} â‚º</td>
                        <td class="p-4 text-center"><button onclick="deleteProduct(${p.id})" class="text-red-500 hover:bg-red-50 p-2 rounded-full transition"><i class="fas fa-trash"></i></button></td>
                    </tr>`;
                }).join('');
            } catch(e){} finally { hideLoading(); }
        }
        // (DiÄŸer fonksiyonlar Ã¼rÃ¼n ekleme/silme vb. aynÄ± mantÄ±kla buraya eklenebilir, yer kaplamamasÄ± iÃ§in kÄ±salttÄ±m)
        
        async function saveProduct(e){
            e.preventDefault();
            showLoading();
            const fd=new FormData(e.target);
            const d={
                name:fd.get('name'),
                description:fd.get('description'),
                price:parseFloat(fd.get('price')),
                category_id:parseInt(fd.get('category_id')),
                is_active:true,
                track_stock: !!document.getElementById('track_stock')?.checked,
                stock: parseInt(document.getElementById('stock_input')?.value||'0')
            };
            try{
                const r=await fetch('/api/products',{method:'POST',headers:getHeaders(),body:JSON.stringify(d)});
                if(r.ok){
                    const np=await r.json();
                    const im=document.getElementById('productImage').files[0];
                    if(im){
                        const f=new FormData();
                        f.append('file',im);
                        await fetch(`/api/products/${np.id}/image`,{method:'POST',headers:{'Authorization':`Bearer ${authToken}`},body:f});
                    }
                    closeProductModal();
                    loadProducts();
                    if(document.getElementById('stockSection') && !document.getElementById('stockSection').classList.contains('hidden')){ loadStock(); }
                    alert('Eklendi!');
                } else {
                    alert('Hata');
                }
            }catch(err){ alert(err); }
            finally{ hideLoading(); }
        }
        async function deleteProduct(id){if(confirm('Sil?')){showLoading();await fetch(`/api/products/${id}`,{method:'DELETE',headers:getHeaders()});loadProducts();hideLoading();}}
        async function openProductModal(){const r=await fetch('/api/products/categories');const d=await r.json();categories=d.categories||d;document.getElementById('categorySelect').innerHTML='<option>SeÃ§</option>'+categories.map(c=>`<option value="${c.id}">${c.name}</option>`);document.getElementById('productModal').classList.remove('hidden');}
        function closeProductModal(){document.getElementById('productModal').classList.add('hidden');}
        
        // Kategoriler
        async function loadCategories(render=true){if(render)showLoading();try{const r=await fetch('/api/products/categories');const d=await r.json();categories=d.categories||d;if(render)document.getElementById('categoriesTable').innerHTML=categories.map(c=>`<tr class="border-b hover:bg-gray-50"><td class="p-4 text-2xl">${c.icon||''}</td><td class="p-4 font-bold text-gray-700">${c.name}</td><td class="p-4 text-center"><button onclick="deleteCategory(${c.id})" class="text-red-500 hover:bg-red-50 p-2 rounded-full"><i class="fas fa-trash"></i></button></td></tr>`).join('');}catch(e){}finally{if(render)hideLoading();}}
        async function addCategory(){const n=prompt('Ad:');if(!n)return;const i=prompt('Ä°kon:','ðŸ”');showLoading();await fetch('/api/products/categories',{method:'POST',headers:getHeaders(),body:JSON.stringify({name:n,icon:i})});loadCategories();hideLoading();}
        async function deleteCategory(id){if(confirm('Sil?')){showLoading();await fetch(`/api/products/categories/${id}`,{method:'DELETE',headers:getHeaders()});loadCategories();hideLoading();}}

        // Masalar
        async function loadTables(){
            showLoading();
            try{
                const r=await fetch('/api/tables',{headers:getHeaders()});
                const d=await r.json();
                const tbody=document.getElementById('tablesTable');
                if(tbody) {
                    const rows = d.map(t=>`<tr class="border-b hover:bg-gray-50"><td class="p-4 font-medium">${t.name}</td><td class="p-4 font-bold text-blue-600">${t.number}</td><td class="p-4 text-center"><button onclick="showQR(${t.id})" class="text-blue-600 mr-3 font-bold text-sm">QR</button><button onclick="deleteTable(${t.id})" class="text-red-500"><i class="fas fa-trash"></i></button></td></tr>`).join('');
                    tbody.innerHTML = rows || '<tr><td colspan="3" class="p-4 text-center text-gray-400">HiÃ§ aktif masa yok</td></tr>';
                }
                try{
                    const or=await fetch('/api/tables/open',{headers:getHeaders()});
                    const od=await or.json();
                    const grid=document.getElementById('openTablesGridTables');
                    if(grid) {
                        const items=(od||[]).map(t=>`<div class="border rounded-xl p-4 ${t.total_amount>0?'border-green-300 bg-green-50':'border-gray-200 bg-white'}"><div class="flex justify-between items-center"><div class="font-bold">Masa ${t.table_number}</div><div class="font-mono">${(t.total_amount||0).toFixed(2)} â‚º</div></div><div class="mt-2 text-xs text-gray-600">${t.items.length} kalem</div><div class="mt-3 flex justify-end gap-2"><button onclick="openTableDetails(${t.table_id})" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Detay</button><button onclick="printBill(${t.table_id})" class="px-3 py-1 bg-gray-700 text-white rounded hover:bg-gray-800 text-sm">YazdÄ±r</button><button onclick="closeTable(${t.table_id})" class="px-3 py-1 bg-slate-800 text-white rounded hover:bg-slate-900 text-sm">Hesap AlÄ±ndÄ±</button></div></div>`).join('');
                        grid.innerHTML = items || '<div class="text-gray-400 text-sm">HiÃ§ aÃ§Ä±k masa yok</div>';
                    }
                }catch(x){}
            }catch(e){}
            finally{hideLoading();}
        }
        async function openTableDetails(id){
            showLoading();
            try{
                const r=await fetch(`/api/tables/details/${id}`, {headers:getHeaders()});
                const d=await r.json();
                const w=window.open("","_blank");
                const doc=w.document;
                const wrap=doc.createElement('div');
                wrap.className='p-6';
                const container=doc.createElement('div');
                container.className='max-w-2xl mx-auto';
                const head=doc.createElement('div');
                head.className='flex justify-between items-center mb-4';
                const h2=doc.createElement('h2'); h2.className='text-2xl font-bold'; h2.textContent=`Masa ${d.table_number}`;
                const ts=doc.createElement('span'); ts.className='text-sm text-gray-500'; ts.textContent=d.arrival_time?new Date(d.arrival_time).toLocaleString('tr-TR'):'';
                head.appendChild(h2); head.appendChild(ts);
                const totalCard=doc.createElement('div'); totalCard.className='bg-white border rounded-xl p-4 mb-4';
                const totalRow=doc.createElement('div'); totalRow.className='flex justify-between';
                const totalLbl=doc.createElement('div'); totalLbl.className='font-bold'; totalLbl.textContent='Toplam';
                const totalVal=doc.createElement('div'); totalVal.className='font-mono text-lg'; totalVal.textContent=`${(d.total_amount||0).toFixed(2)} â‚º`;
                totalRow.appendChild(totalLbl); totalRow.appendChild(totalVal); totalCard.appendChild(totalRow);
                const ordersBox=doc.createElement('div'); ordersBox.className='bg-white border rounded-xl p-4';
                const ordersTitle=doc.createElement('h3'); ordersTitle.className='font-bold mb-2'; ordersTitle.textContent='SipariÅŸler'; ordersBox.appendChild(ordersTitle);
                (d.orders||[]).forEach(o=>{
                    const sec=doc.createElement('div'); sec.className='border-b py-2';
                    const top=doc.createElement('div'); top.className='flex justify-between';
                    const left=doc.createElement('div'); left.className='font-semibold'; left.textContent=`#${o.id} - ${o.status}`;
                    const right=doc.createElement('div'); right.className='text-xs text-gray-500'; right.textContent=new Date(o.created_at).toLocaleString('tr-TR');
                    top.appendChild(left); top.appendChild(right); sec.appendChild(top);
                    if(o.customer_notes){ const notes=doc.createElement('div'); notes.className='text-xs text-gray-600'; notes.textContent=`Not: ${o.customer_notes}`; sec.appendChild(notes); }
                    const table=doc.createElement('table'); table.className='w-full text-sm mt-2';
                    const thead=doc.createElement('thead'); thead.className='text-gray-500';
                    thead.innerHTML='<tr><th class="text-left">ÃœrÃ¼n</th><th class="text-center">Adet</th><th class="text-right">Fiyat</th><th class="text-right">Tutar</th></tr>';
                    const tbody=doc.createElement('tbody');
                    (o.items||[]).forEach(it=>{
                        const tr=doc.createElement('tr');
                        tr.innerHTML=`<td>${it.name}</td><td class="text-center">${it.quantity}</td><td class="text-right font-mono">${Number(it.unit_price||0).toFixed(2)} â‚º</td><td class="text-right font-mono">${Number(it.subtotal||0).toFixed(2)} â‚º</td>`;
                        tbody.appendChild(tr);
                    });
                    table.appendChild(thead); table.appendChild(tbody); sec.appendChild(table);
                    ordersBox.appendChild(sec);
                });
                const actions=doc.createElement('div'); actions.className='mt-4 text-right';
                const btn=doc.createElement('button'); btn.className='px-4 py-2 bg-slate-800 text-white rounded hover:bg-slate-900'; btn.textContent='YazdÄ±r'; btn.onclick=()=>{window.opener && window.opener.printBill(id); w.close();};
                actions.appendChild(btn); ordersBox.appendChild(actions);
                container.appendChild(head); container.appendChild(totalCard); container.appendChild(ordersBox);
                wrap.appendChild(container); doc.body.appendChild(wrap);
            }catch(x){ alert('Detay yÃ¼klenemedi'); }
            finally{ hideLoading(); }
        }
        async function printBill(id){
            showLoading();
            try{ await fetch(`/api/tables/print-bill/${id}`, {method:'POST', headers:getHeaders()}); showToast('Hesap yazdÄ±rÄ±lÄ±yor', 'blue'); }
            catch(x){ alert('YazdÄ±rma baÅŸarÄ±sÄ±z'); }
            finally{ hideLoading(); }
        }
        async function addTableQuick(){
            const n=document.getElementById('quickTableName')?.value.trim();
            const num=parseInt(document.getElementById('quickTableNumber')?.value||'0');
            if(!n || !num){ alert('Masa adÄ± ve numarasÄ± gerekli'); return; }
            showLoading();
            try{ await fetch('/api/tables',{method:'POST',headers:getHeaders(),body:JSON.stringify({name:n,number:num})}); document.getElementById('quickTableName').value=''; document.getElementById('quickTableNumber').value=''; loadTables(); }
            catch(x){ alert('Ekleme hatasÄ±'); }
            finally{ hideLoading(); }
        }
        async function addTable(){const n=prompt('Ad:');if(!n)return;const num=prompt('No:');showLoading();await fetch('/api/tables',{method:'POST',headers:getHeaders(),body:JSON.stringify({name:n,number:parseInt(num)})});loadTables();hideLoading();}
        async function deleteTable(id){if(confirm('Sil?')){showLoading();await fetch(`/api/tables/${id}`,{method:'DELETE',headers:getHeaders()});loadTables();hideLoading();}}
        async function reactivateTableByNumber(){
            const num=parseInt(document.getElementById('reactivateTableNumber')?.value||'0');
            if(!num){ alert('Masa no gerekli'); return; }
            showLoading();
            try{
                const r=await fetch('/api/tables?active_only=false',{headers:getHeaders()});
                const d=await r.json();
                const t=(d||[]).find(x=>x.number===num);
                if(!t){ alert('Masa bulunamadÄ±'); return; }
                if(t.is_active){ alert('Masa zaten aktif'); return; }
                const u=await fetch(`/api/tables/${t.id}`,{method:'PUT',headers:getHeaders(),body:JSON.stringify({is_active:true})});
                if(u.ok){ document.getElementById('reactivateTableNumber').value=''; loadTables(); }
                else{ alert('AktifleÅŸtirme baÅŸarÄ±sÄ±z'); }
            }catch(e){ alert('Ä°stek hatasÄ±'); }
            finally{ hideLoading(); }
        }
        async function showQR(id){
            const r=await fetch(`/api/tables/${id}/qr`,{headers:getHeaders()});
            const d=await r.json();
            const w=window.open("","_blank");
            const doc=w.document;
            const root=doc.createElement('div');
            root.style.textAlign='center';
            root.style.marginTop='50px';
            root.style.fontFamily='sans-serif';
            const h1=doc.createElement('h1');
            h1.textContent=d.table_name||`Masa ${id}`;
            const img=doc.createElement('img');
            img.width=300;
            img.src=d.qr_url||'';
            const br=doc.createElement('br');
            const btn=doc.createElement('button');
            btn.textContent='YAZDIR';
            btn.style.marginTop='20px';
            btn.style.padding='10px 20px';
            btn.style.fontSize='1.2em';
            btn.onclick=()=>w.print();
            root.appendChild(h1);root.appendChild(img);root.appendChild(br);root.appendChild(btn);
            doc.body.appendChild(root);
        }

        // SipariÅŸler
        async function loadOrders(){showLoading();try{const r=await fetch('/api/orders',{headers:getHeaders()});const d=await r.json();document.getElementById('ordersTable').innerHTML=d.map(o=>`<tr class="border-b hover:bg-gray-50"><td class="p-4 text-gray-500 font-mono">#${o.id}</td><td class="p-4 font-bold">${o.table_name}</td><td class="p-4 font-bold text-slate-700">${o.total_amount.toFixed(2)} â‚º</td><td class="p-4"><span class="bg-gray-100 px-2 py-1 rounded text-xs font-bold text-gray-600 uppercase">${o.status}</span></td><td class="p-4 text-sm text-gray-500">${new Date(o.created_at).toLocaleTimeString('tr-TR').slice(0,5)}</td><td class="p-4 text-center"><button onclick="cancelOrder(${o.id})" class="text-red-500 border border-red-200 px-2 py-1 rounded text-xs hover:bg-red-50">Ä°ptal</button></td></tr>`).join('');}catch(e){}finally{hideLoading();}}
        async function cancelOrder(id){if(!confirm('Ä°ptal?'))return;showLoading();await fetch(`/api/orders/${id}/status`,{method:'PUT',headers:getHeaders(),body:JSON.stringify({status:'cancelled'})});loadOrders();hideLoading();}

        // Ayarlar ve Logo
        function handleLogoSelect(input){if(input.files&&input.files[0]){const r=new FileReader();r.onload=e=>{document.getElementById('currentLogo').src=e.target.result;document.getElementById('currentLogo').style.display='block';document.getElementById('logoPlaceholder').style.display='none';document.getElementById('uploadBtn').classList.remove('hidden');};r.readAsDataURL(input.files[0]);document.getElementById('fileNameDisplay').innerText=input.files[0].name;}}
        async function uploadLogo(){const fi=document.getElementById('logoInput');if(fi.files.length===0)return;showLoading();const fd=new FormData();fd.append('file',fi.files[0]);try{const r=await fetch('/api/admin/settings/logo',{method:'POST',headers:{'Authorization':`Bearer ${authToken}`},body:fd});if(r.ok){alert('YÃ¼klendi!');loadSettings();}else alert('Hata');}catch(e){alert(e);}finally{hideLoading();}}
        async function loadSettings(){showLoading();try{const r=await fetch('/api/admin/settings',{headers:getHeaders()});if(r.ok){const d=await r.json();document.getElementById('setRestName').value=d.restaurant_name||'';document.getElementById('setCurrency').value=d.currency||'';document.getElementById('setTax').value=d.tax_rate||0;document.getElementById('setService').value=d.service_charge||0;document.getElementById('setTimeout').value=d.order_timeout_minutes||30;document.getElementById('setWifi').value=d.wifi_password||'';if(d.logo_url){const url=d.logo_url+'?t='+new Date().getTime();document.getElementById('currentLogo').src=url;document.getElementById('currentLogo').style.display='block';document.getElementById('logoPlaceholder').style.display='none';const al=document.getElementById('adminPanelLogo');if(al){al.src=url;al.style.display='block';al.classList.remove('hidden');}}}}catch(e){}finally{hideLoading();}}
        async function saveSettings(e){e.preventDefault();showLoading();const d={restaurant_name:document.getElementById('setRestName').value,currency:document.getElementById('setCurrency').value,tax_rate:parseFloat(document.getElementById('setTax').value),service_charge:parseFloat(document.getElementById('setService').value),order_timeout_minutes:parseInt(document.getElementById('setTimeout').value),wifi_password:document.getElementById('setWifi').value};await fetch('/api/admin/settings',{method:'PUT',headers:getHeaders(),body:JSON.stringify(d)});alert('Kaydedildi!');hideLoading();}

        // WebSocket
        function connectWS() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
            ws.onopen = () => ws.send(JSON.stringify({type:'register', client_type:'admin'}));
            ws.onmessage = (e) => {
                try {
                    const m = JSON.parse(e.data);
                    if(m.type === 'waiter_call' || m.type === 'bill_request') {
                        document.getElementById('bellSound').play().catch(()=>{});
                        showToast(m.message, m.type === 'bill_request' ? 'purple' : 'orange');
                    } else if(m.type === 'stock_warning') {
                        showToast(m.message, 'red');
                    } else if(m.type && m.type.includes('order')) {
                        if(!document.getElementById('dashboardSection').classList.contains('hidden')) loadDashboard();
                        if(!document.getElementById('ordersSection').classList.contains('hidden')) loadOrders();
                        if(!document.getElementById('tablesSection').classList.contains('hidden')) loadTables();
                    } else if(m.type === 'table_status') {
                        showToast(`${m.table_name} aktif oldu`, 'blue');
                        if(!document.getElementById('dashboardSection').classList.contains('hidden')) loadDashboard();
                        if(!document.getElementById('tablesSection').classList.contains('hidden')) loadTables();
                    }
                } catch(x){}
            };
            ws.onclose = () => setTimeout(connectWS, 3000);
        }

        function showToast(msg, color) {
            const div = document.createElement('div');
            div.className = `fixed top-5 right-5 bg-white border-l-4 border-${color}-500 text-gray-700 px-6 py-4 shadow-2xl z-50 flex items-center gap-3 rounded-r toast-notification`;
            div.innerHTML = `<i class="fas fa-bell text-${color}-500 text-xl"></i> <span class="font-bold">${msg}</span>`;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }

        // BAÅžLAT
        window.onload = () => {
            showSection('dashboard');
            loadSettings();
            connectWS();
        };
        function filterStockTable(){
            const q=(document.getElementById('stockSearch')?.value||'').toLowerCase();
            const tbody=document.getElementById('stockTableBody')||document.getElementById('stockTable');
            if(!tbody) return;
            Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
                const nameCell=tr.querySelector('td');
                const name=nameCell?nameCell.textContent.toLowerCase():'';
                tr.style.display=name.includes(q)?'':'';
            });
        }
    </script>
</body>
</html>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const sec = document.getElementById('stockSection') || document.getElementById('stocksSection');
  if(sec){
    const header = sec.querySelector('div.flex.justify-between.items-center') || sec.querySelector('div.mb-6');
    if(header && !document.getElementById('stockAddBtn')){
      const btn = document.createElement('button');
      btn.id = 'stockAddBtn';
      btn.className = 'bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700';
      btn.textContent = 'Yeni ÃœrÃ¼n';
      btn.onclick = function(){
        if(typeof openProductModal === 'function'){
          openProductModal();
          const cb = document.getElementById('track_stock');
          if(cb){ cb.checked = true; }
        }
      };
      header.appendChild(btn);
    }
  }
});
</script>
<script>
async function loadStock(){
    showLoading();
    try{
        const res = await fetch('/api/products', {headers: getHeaders()});
        const data = await res.json();
        try{ const cr = await fetch('/api/products/categories'); const cd = await cr.json(); const cats = cd.categories||cd; const qc = document.getElementById('quickNewCategory'); if(qc) qc.innerHTML = cats.map(c=>`<option value="${c.id}">${c.name}</option>`).join(''); }catch(x){}
        const tbody = document.getElementById('stockTable');
        if(tbody) tbody.innerHTML = (data||[]).map(p => `
            <tr class="border-b hover:bg-gray-50 transition">
                <td class="p-4 font-medium text-gray-800">${p.name}</td>
                <td class="p-4 text-right font-mono">${p.track_stock ? p.stock : 'âˆž'}</td>
                <td class="p-4 text-right">${p.track_stock ? `<input type=\"number\" min=\"0\" class=\"w-24 border p-2 rounded-lg text-right\" id=\"stock-${p.id}\" value=\"${p.stock}\">` : '<span class=\"text-xs text-gray-400\">Takip KapalÄ±</span>'}</td>
                <td class="p-4 text-center"><button onclick=\"${p.track_stock ? `saveStock(${p.id})` : `toggleTrack(${p.id}, true)`}\" class=\"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700\">${p.track_stock ? 'GÃ¼ncelle' : 'Takibi AÃ§'}</button></td>
            </tr>
        `).join('');
        const qs = document.getElementById('quickProductSelect');
        if(qs) qs.innerHTML = (data||[]).map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        const cards = document.getElementById('stockCards');
        if(cards) cards.innerHTML = (data||[]).map(p => renderStockCard(p)).join('');
    }catch(e){}finally{hideLoading();}
}
function renderStockCard(p){
    const cap = 100;
    const pct = Math.max(0, Math.min(100, Math.round(((p.stock||0)/cap)*100)));
    let cls = 'bg-green-100 border-green-300';
    if(pct < 75 && pct >= 50) cls = 'bg-yellow-100 border-yellow-300';
    if(p.track_stock && p.stock <= 15) cls = 'bg-red-100 border-red-300 animate-pulse';
    return `
    <div class=\"p-4 rounded-xl border ${cls}\">
        <div class=\"flex justify-between items-center\">
            <div class=\"font-bold text-gray-800\">${p.name}</div>
            <div class=\"text-sm\">${p.track_stock ? 'Takip' : 'Takipsiz'}</div>
        </div>
        <div class=\"mt-2 text-2xl font-mono\">${p.track_stock ? p.stock : 'âˆž'}</div>
        <div class=\"mt-1 text-xs text-gray-500\">Tahmini doluluk: ${pct}%</div>
    </div>`;
}
async function quickCreateProduct(){
    const name = document.getElementById('quickNewName')?.value.trim();
    const category_id = parseInt(document.getElementById('quickNewCategory')?.value||'0');
    const price = parseFloat(document.getElementById('quickNewPrice')?.value||'0');
    const stock = parseInt(document.getElementById('quickNewStock')?.value||'0');
    const track = !!document.getElementById('quickNewTrack')?.checked;
    if(!name || !category_id || !price){ alert('Ad, kategori ve fiyat zorunlu'); return; }
    showLoading();
    try{
        const r = await fetch('/api/products',{method:'POST', headers:getHeaders(), body: JSON.stringify({name, description:'', price, category_id, is_active:true, track_stock: track, stock})});
        if(r.ok){ const qn=document.getElementById('quickNewName'); if(qn) qn.value=''; const qp=document.getElementById('quickNewPrice'); if(qp) qp.value=''; const qs=document.getElementById('quickNewStock'); if(qs) qs.value=''; loadStock(); }
        else alert('Ekleme hatasÄ±');
    }catch(x){ alert('Ä°stek hatasÄ±'); }finally{ hideLoading(); }
}
async function quickAddStock(){
    const id = parseInt(document.getElementById('quickProductSelect')?.value||'0');
    const delta = parseInt(document.getElementById('quickAmount')?.value||'0');
    if(!id || isNaN(delta)) { alert('ÃœrÃ¼n ve miktar seÃ§in'); return; }
    const productsRes = await fetch(`/api/products/${id}`, {headers: getHeaders()});
    const product = await productsRes.json();
    const newStock = (product.stock||0) + delta;
    await fetch(`/api/products/${id}`, {method:'PUT', headers: getHeaders(), body: JSON.stringify({stock: newStock})});
    const qa = document.getElementById('quickAmount'); if(qa) qa.value='';
    loadStock();
}
</script>
 
